\chapter{Proof of Preservation and Progress}
\label{proof_of_pnp}

\begin{definition}{(Heap Induced Graph)}
  The induced graph of heap $H$, written $\Graph{(H)}$ is the directed graph
  $(V, E)$ such that $V = \dom{(H)}$ and 
  \begin{equation}
    E = \left\{ (o, o')_f \in \dom{(H)}^2 \times \FieldNames: 
      H(o) = \Obj{C, FM} \text{ and } FM(f) = o'
    \right\}
  \end{equation}
\end{definition}

\begin{definition}{(Graph Reachability)}
  We say an object $o'$ is reachable from $o$ in graph $G = (V,
  E)$, $\reach{(G, o, o')}$ if there is a finite sequence $o_0, \dots,
  o_n \in V$ such that $o = o_0, o_n = o'$ and
  \begin{equation}
    \forall i = 1,\dots, n-1. \: \exists f \in \FieldNames \text{ s.t. } (o_i,
    o_{i+1})_f \in E.
  \end{equation}
  The sequence $o_0, \dots, o_n$ is called a \emph{path}.
\end{definition}

\begin{definition}
  Given a graph $G = (V, E)$ and a set $O \subseteq V$, we define
  \begin{equation}
    \reachable{(O, G)} = \left\{ q \in V: \exists o\in O.\: \reach{(G, o, q)}
    \right\} \notag
  \end{equation}
\end{definition}

\begin{proposition}{(Reachability equivalence)}
  \label{prop:reacheq}
  For a heap $H$ 
  \begin{equation}
    \reach{(H, o, o')} \iff \reach{(\Graph{(H)}, o, o')}
  \end{equation}
\end{proposition}

\begin{proof}
  Both directions of implication are simple to prove.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of derivation tree.
    \item[Case $\impliedby$:] By induction on the path length in graph
      $\Graph{(H)}$.
  \end{description}
\end{proof}

% TODO change definition of ocrloc
\begin{proposition} For any heap $H$ and frame stack $FS$ we have
  \begin{flalign*}
    &\ocrloc{(FS, H)} &\\
    &\iff &\\
    &\begin{aligned}
    \forall o, q &\in \dom{(H)}. \\
    & \accRoot{(o, FS, H)} \land \reach{(H, o, q)} \implies \\
    & \ocap{(\typeOf{(o, H)})} 
    \end{aligned}&\\
    &\iff &\\
    &\begin{aligned}
    \forall q &\in \reachable{{(\accRoots{(FS,H)}, \Graph{(H)})}}. \notag\\
    & \ocap{(\typeOf{(q, H)})}
    \end{aligned}&
  \end{flalign*}
\end{proposition}

% TODO should I elaborate?
\begin{proof}
  Follows from definition of $\accRoot$, $\accRoots$ and $\reachable$.
\end{proof}

\begin{proposition} \label{prop:csep_eq}
  For any heap $H$ and object references $o, o'$ we have
  \begin{flalign*}
    &\csep{(H, o, o')} \iff &\\
    & \begin{aligned}
        \forall q \in \: &\reachable{(\{o\}, \Graph{(H)})} \cap \reachable{(\{o'\},
        \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

\begin{proof}
  First of all we let $R = \reachable{(\{o\}, \Graph{(H)})}, R' =
  \reachable{(\{o'\}, \Graph{(H)})}$.
  We prove each direction of implication separately.
  \begin{description}
    \item[Case $\implies$:] Take any $q \in  R\cap R'$. By definition of
      $\reachable$, reachability equivalence (prop.~\ref{prop:reacheq}) and 
      definition of $\csep{(H, o, o')}$ we have $\typeOf{(q, H)} \stof \CellType$.
    \item[Case $\impliedby$:] Take any $q, q'\in \dom{(H)}$ such that
      $\reach{(H, o, q)}$ and $\reach{(H, o', q')}$. If $q \neq q$ we are done.
      Otherwise $q = q'$ and by definition of $\reachable$ $q \in R \cap R'$.
      Finally $\typeOf{(q, H)} \stof \CellType$ by assumption.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:isolation_eq}
  For any heap $H$ and frame stacks $FS, HS$ we have
  \begin{flalign*}
    &\isolated{(H, FS, HS)}  \iff &\\
    &\begin{aligned}
        \forall q \in \:&\reachable{(\accRoots{(FS, H)}, \Graph{(H)})} \cap \\
        & \reachable{(\accRoots{(HS, H)}, \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

% TODO proof
\begin{proof}
  Let $R = \reachable(\accRoots(FS, H), \Graph(H)), R' =
  \reachable(\accRoots(HS, H), \Graph(H))$. We prove each direction of
  implication separately.
  \begin{description}
    \item[Case $\implies$:] Take $q \in R \cap R'$. Then 
      \begin{equation*}
        \exists o \in \accRoots(FS, H), o' \in \accRoots(HS, H)
      \end{equation*}
      such that
      \begin{equation*}
        q \in \reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\}, \Graph(H))
      \end{equation*}
      By definition of $\accRoots$ we have
      \begin{equation*}
        \accRoot(o, FS, H) \land \accRoot(o', HS, H)
      \end{equation*}
      and thus by $\isolated(H, FS, HS)$ we have $\csep(H, o, o')$. 
      Proposition~\ref{prop:csep_eq} yields $\typeOf(q, H) \stof \CellType$.
    \item[Case $\impliedby$:] Take any $o, o' \in \dom(H)$ such that
      \begin{equation*}
        \accRoot(o, FS, H) \land \accRoot(o', HS).
      \end{equation*}
      Clearly then $o \in \accRoots(FS, H)$ and $o \in \accRoots(HS, H)$.
      Moreover
      \begin{gather*}
        \reachable(\{o\}, \Graph(H)) \subseteq R \\
        \reachable(\{o'\}, \Graph(H)) \subseteq R'
      \end{gather*}
      By assumption then
      \begin{align*}
        \forall q \in &\reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\},
        \Graph(H)). \\ 
        &\typeOf(q, H) \stof \CellType
      \end{align*}
      and by proposition~\ref{prop:csep_eq} we have $\csep(H, o, o')$. Since
      $o, o'$ arbitrary we are done.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:common_isolation_orc_gen}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ FS|_a^d \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ FS'|_a^d \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall HS|_b^e \in Q.$ \\ 
      $\reachable{(\accRoots{(HS, H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(HS, H)}, \Graph{(H)})}$
    \item $\reachable{(\accRoots{(FS', H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(FS, H)}, \Graph{(H)})}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{proposition}

\begin{remark}
  Note that $\Graph{(H)} = \Graph{(H')}$ implies $\dom{(H)} = \dom{(H')}$.
  Otherwise many of the preconditions above would not make sense.
\end{remark}

\begin{proof}
  We prove that 
  \begin{equation*}
    \forall \text{ distinct } HS|_a^d, GS|_b^e \in P'.\; a = \ocap \lor b = \ocap \implies
    \isolated(H', HS, GS).
  \end{equation*}
  This implies $\isolation(H', P')$ by rule {\sc ISO-Procs}.
  Take any distinct $HS|_b^e, GS|_c^f \in P$. Then by assumption 3, 4 and basic set
  properties
  \begin{equation} \label{eq:reachinclusion1}
    \begin{gathered}
      \reachable(\accRoots(HS, H'), \Graph(H')) \cap \reachable(\accRoots(GS, H'),
      \Graph(H')) \\
      \subseteq \\
      \reachable(\accRoots(HS, H), \Graph(H)) \cap \reachable(\accRoots(GS, H),
      \Graph(H)).
    \end{gathered}
  \end{equation}
  By this, proposition~\ref{prop:isolation_eq} and $\isolation(H, HS, GS)$ we have
  $\isolation(H', HS, GS)$. By \eqref{eq:reachinclusion1} and assumption
  we have $H' \vdash P' \tsep \ocr$.
\end{proof}

\begin{corollary} \label{prop:common_isolation_orc}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ FS|_a^d \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ FS'|_a^d \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall HS|_b^e \in Q. \: \accRoots{(HS, H')} \subseteq \accRoots{(HS, H)}$
    \item $\accRoots{(FS', H')} \subseteq \accRoots{(FS, H)}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{corollary}

\begin{proof}
  Assumption 2 and 3 implies assumption 2 and 3 of
  proposition~\ref{prop:common_isolation_orc_gen}
\end{proof}

\begin{definition} \label{def:ptilde}
  Let $FS_g = \Frame{L_0}{global}{-} \circ \varepsilon$ bet the framestack where
  $L_0 = [global \mapsto o_g]$. Then for any thread set $P$, let $\tilde{P}$ be the
  thread set
  \begin{equation*}
    \tilde{P} = P \cup \left\{ FS_g|_{\nocap}^d \right\}
  \end{equation*}
  for some valid $d$.
\end{definition}

\begin{proposition} \label{prop:gsep_eq}
  For any heap $H$ and thread set $P$
  \begin{equation*}
    \isolation{(H, \tilde{P})} \iff \isolation{(H, P)} \text{ and } H \vdash P
    \tsep \gsep 
  \end{equation*}
\end{proposition}

\begin{proof}
  This follows almost immediately by the definitions of isolation and global
  object separation, and the fact that $\accRoots(FS_g) = \left\{
    o_g \right\}$ 
\end{proof}

We state the following two propositions without proof, but they should be quite
obvious.
% TODO define transition identifier
\begin{proposition} \label{prop:uniq_trans}
  Let $H, P \Rrightarrow H', P'$. Then there is a unique transition identifier
  $R^{\alpha, \beta}$ such that $H, P \Rrightarrow^{R^{\alpha, \beta}} H', P'$.
\end{proposition}

\begin{proposition} \label{prop:tilde_trans}
  Let $H, P \Rrightarrow^{R^{\alpha, \beta}} H', P'$. Then $H, \tilde{P}
  \Rrightarrow^{R^{\alpha, \beta}} H', \tilde{P'}$
\end{proposition}

%TODO check formulation of prop
\begin{proposition} \label{prop:common_gsep}
  If for any $H, H', P, P'$ such that $\vdash H, H \vdash P$ and $H, P
  \Rrightarrow^{R^{\alpha, \beta}} H', P'$
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \isolation(H, \tilde{P}) \implies \isolation(H', \tilde{P'})
  \end{equation*}
\end{proposition}

\begin{proof}
  By proposition~\ref{prop:tilde_trans} $H, \tilde{P} \Rrightarrow^{R^{\alpha,
  \beta}} H', \tilde{P'}$. It is easy to see that $\vdash H$ and $H \vdash
  \tilde{P}$.
  Since the assumption of the proposition refers to any $H, H', P, P'$ for which
  these three properties hold the statement also holds for $H, H',
  \tilde{P}, \tilde{P'}$.
\end{proof}

\begin{remark}
  This proposition may seem a bit circular, but what it does is allow us to get
  the global separation property for free in most cases in the proof of
  preservation by combining it with proposition~\ref{prop:gsep_eq}. We state
  this in the following corollary.
\end{remark}

\begin{corollary}
  If for any $H, H', P, P'$ such that $\vdash H, H \vdash P$ and $H, P
  \Rrightarrow^{R^{\alpha, \beta}} H', P'$
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \begin{gathered}
      \isolation(H, P) \text{ and } H \vdash P \tsep \gsep \\
      \implies \\
      \isolation(H', P') \text{ and } H \vdash P' \tsep \gsep
    \end{gathered}
  \end{equation*}
\end{corollary}

\begin{proposition}
  Let $H, H'$ be heaps. If $\dom{(H)} = \dom{(H')}$ and
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}
  \end{equation*}
  then 
  \begin{equation*}
    \forall k \in \Values. \: \typeOf{(k, H)} = \typeOf{(k, H')}
  \end{equation*}
\end{proposition}

\begin{proof}
  Trivial.
\end{proof}

\begin{proposition} \label{prop:2.19}
  If
  \begin{equation*}
    \forall o \in \dom(H) \subseteq \dom(H'). \: \typeOf(o, H) = \typeOf(o, H')
  \end{equation*}
  and $H \vdash \Gamma; L$, then $H' \vdash \Gamma; L$.
\end{proposition}

\begin{proposition} \label{prop:tprocseq}
  For any $H, P$ we have 
  \begin{equation}
    H \vdash P \iff \forall HS|_b^e \in P.\: H;b \vdash HS
  \end{equation}
\end{proposition}

\begin{proof} (Sketch) Done in each direction separately.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of the derivation tree.
    \item[Case $\impliedby$:] By induction on size of $P$.
  \end{description}
\end{proof}

% TODO define heap
\begin{proposition}
  Let $H, H'$ be heaps such that $\dom{(H)} \subseteq \dom{(H')}$ and 
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}.
  \end{equation*}
  Then for any frame stack $FS$
  \begin{equation}\label{eq:fs_impl_typing1}
    H; a \vdash FS \implies H'; a \vdash FS
  \end{equation}
  and
  \begin{equation} \label{eq:fs_impl_typing2}
    H; a \vdash^{x :\sigma} FS \implies H'; a \vdash^{x: \sigma} FS 
  \end{equation}
\end{proposition}

\begin{proof}
  We first prove \eqref{eq:fs_impl_typing2} by induction on the lenght $n$ of
  $FS$. To prove the implication we assume that $H; a \vdash^{x: \tau} FS$.
  
  If $n = 0$ we have $FS = \varepsilon$. By {\sc T-FSEmpty2} we are done.
  
  If $n = i + 1$ we have $FS = F \circ GS$ where length of $GS$ is $i$. By  
  $H; a \vdash^{x: \sigma} FS$ and {\sc T-FS2} we have 
  \begin{equation*}
    F = \xframe{L, t}^{y} \andalso H \vdash \Gamma; L \andalso \TypeRel{\Gamma, x:
    \sigma}{a}{t}{\tau} \andalso H; a \vdash^{y: \tau} GS.
  \end{equation*}
  By induction hypothesis we then have $H'; a \vdash^{y: \tau} GS$. We get $H'
  \vdash \Gamma; L$ from proposition \ref{prop:2.19}. Applying rule {\sc T-FS2}
  yields $H'; a \vdash^{x: \sigma} FS$.

  Now we prove \eqref{eq:fs_impl_typing1}. Similarly assuming $H; a \vdash^{x:
  \tau} FS$ we have two cases. If $FS = \varepsilon$ we are done by {\sc
  T-FSEmpty1}. If $FS = F \circ GS$ we by {\sc T-FS1} have
  \begin{equation*}
    F = \xframe{L, t}^{x} \andalso H \vdash \Gamma; L \andalso
    \TypeRel{\Gamma}{a}{t}{\tau} \andalso H; a \vdash^{x: \sigma} GS.
  \end{equation*}
  By \eqref{eq:fs_impl_typing1} $H'; a \vdash^{x: \sigma} GS$ and
  proposition~\ref{prop:2.19} yields $H' \vdash \Gamma; L$. Applying rule {\sc
  T-FS1} gives us $H'; a \vdash FS$.
\end{proof}

% TODO fix the statement
\begin{proposition}
  Let $HS|_b^e \in Q$ where $Q$ as in thm case {\sc E-Assign}. Then
  \begin{align*}
    &\reachable{(\accRoots{(FS',H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
  and if $a = \ocap$ or $b = \ocap$ then
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}
  \end{align*}
\end{proposition}

\begin{corollary}
  If $b = \ocap$ then 
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}
  \end{align*}
\end{corollary}

\begin{corollary}
  \begin{align*}
    &\reachable{(\accRoots{(FS',H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
\end{corollary}

\begin{proposition}
  Let $HS|_b^e \in Q$ where $Q$ as in thm case {\sc E-Assign}. Then
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}\: \cup \\ 
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
\end{proposition}

\begin{proposition}
  If 
  \[
    \forall o \in \dom{(H)} \subseteq \dom{(H')}. \: \typeOf{(o, H)} = \typeOf{(o,
  H')}
  \] 
  and $H \vdash \Gamma; L$, then $H' \vdash \Gamma; L$
\end{proposition}
\begin{proof}
  Trivial.
\end{proof}


% TODO 2.20 can it be included in 2.5 perhaps?

\section{Proof of preservation}
\label{sec:proof_of_preservation}

\begin{proof} 
  First of all we have that $S \neq \Error$ since no step can be made from this
  state. Thus $S = H, P$ and
  \begin{equation*}
    \vdash H \andalso H \vdash P \andalso H \vdash P \tsep \ocr \andalso
    \isolated{(H, P)} \andalso H \vdash P \tsep \gsep
  \end{equation*}
  We also assume we have $S' = H', P'$ since otherwise $S' = \Error$ and the
  theorem holds trivially. What remains is to prove
  \begin{equation*}
    \vdash H' \andalso H' \vdash P' \andalso H' \vdash P' \tsep \ocr \andalso
    \isolated{(H', P')} \andalso H' \vdash P' \tsep \gsep.
  \end{equation*}
  We proceed by cases.
  \begin{description}
    \item[Case {\sc E-FSProp}:] According to this rule $P = Q \cup_D \left\{
        FS|_a^d \right\}$ and $P' = Q \cup \left\{ FS'|_a^d \right\}$. We proceed by cases.
      \begin{description}
        \item[Case {\sc E-FProp}:] By the rule definition $FS|_a^d = F \circ
          GS|_a^d$ and $FS'|_a^d = F' \circ GS|_a^d$. Furthermore we can assume
          that $F = \sframe{L, t}$ and $F' = \sframe{L', t'}$.
          We proceed by cases.
          \begin{description}
            \item[Case {\sc E-Null}:] By this rule we have $t =
              \Let{x}{\NullVal}{t'}$, $H = H'$ and $L' = L[x \mapsto \NullVal]$.
              Immediatelly we have $\vdash H'$.

              By {\sc T-Procs} and proposition~\ref{prop:tprocseq} we have 
              \begin{equation} \label{eq:enull1}
               H \vdash Q  \andalso H; a \vdash FS 
              \end{equation}
              Trivially $H' \vdash Q$. 
              By~\eqref{eq:enull1} and rule {\sc T-FS1} we have
              \begin{equation} \label{eq:enull2}
                H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma}
                \andalso H; a \vdash^{s: \sigma} GS.
              \end{equation}
              Let $\Gamma' = \Gamma, x: \NullType$. By {\sc T-Let}, {\sc
              T-Null} and \eqref{eq:enull2} we have
              \begin{equation} \label{eq:enull3}
                \TypeRel{\Gamma'}{a}{t'}{\sigma}.
              \end{equation}
              By {\sc T-FS1}, \eqref{eq:enull3} and \eqref{eq:enull2}
              \begin{equation}\label{eq:enull4}
                H;a \vdash FS'
              \end{equation}
              By \eqref{eq:enull4}, {\sc T-Procs} and $H = H'$ we get  
              \begin{equation}
                H' \vdash P'
              \end{equation}
              $H' \vdash P' \tsep \ocr$ and $\isolation{(H', P')}$ follows from
              proposition~\ref{prop:common_isolation_orc}. Then $H' \vdash P'
              \tsep \gsep$ follows from propositions~\ref{prop:gsep_eq}
              and~\ref{prop:common_gsep}.
            \item[Case {\sc E-LVal}:] Similarly.
            \item[Case {\sc E-Var}:] Similarly.
          \end{description}
      \end{description}
  \end{description}
\end{proof}











