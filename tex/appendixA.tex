\chapter{Proof of Preservation and Progress}
\label{proof_of_pnp}

\begin{definition}{(Heap Induced Graph)}
  The induced graph of heap $H$, written $\Graph{(H)}$ is the directed graph
  $(V, E)$ such that $V = \dom{(H)}$ and 
  \begin{equation}
    E = \left\{ (o, o')_f \in \dom{(H)}^2 \times \FieldNames: 
      H(o) = \Obj{C, FM} \text{ and } FM(f) = o'
    \right\}
  \end{equation}
\end{definition}

\begin{definition}{(Graph Reachability)}
  We say an object $o'$ is reachable from $o$ in graph $G = (V,
  E)$, $\reach{(G, o, o')}$ if there is a finite sequence $o_0, \dots,
  o_n \in V$ such that $o = o_0, o_n = o'$ and
  \begin{equation}
    \forall i = 1,\dots, n-1. \: \exists f \in \FieldNames \text{ s.t. } (o_i,
    o_{i+1})_f \in E.
  \end{equation}
  The sequence $o_0, \dots, o_n$ is called a \emph{path}.
\end{definition}

\begin{definition}
  Given a graph $G = (V, E)$ and a set $O \subseteq V$, we define
  \begin{equation}
    \reachable{(O, G)} = \left\{ q \in V: \exists o\in O.\: \reach{(G, o, q)}
    \right\} \notag
  \end{equation}
\end{definition}

\begin{proposition}{(Reachability equivalence)}
  \label{prop:reacheq}
  For a heap $H$ 
  \begin{equation}
    \reach{(H, o, o')} \iff \reach{(\Graph{(H)}, o, o')}
  \end{equation}
\end{proposition}

\begin{proof}
  Both directions of implication are simple to prove.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of derivation tree.
    \item[Case $\impliedby$:] By induction on the path length in graph
      $\Graph{(H)}$.
  \end{description}
\end{proof}

% TODO change definition of ocrloc
\begin{proposition} For any heap $H$ and frame stack $FS$ we have
  \begin{flalign*}
    &\ocrloc{(FS, H)} &\\
    &\iff &\\
    &\begin{aligned}
    \forall o, q &\in \dom{(H)}. \\
    & \accRoot{(o, FS, H)} \land \reach{(H, o, q)} \implies \\
    & \ocap{(\typeOf{(o, H)})} 
    \end{aligned}&\\
    &\iff &\\
    &\begin{aligned}
    \forall q &\in \reachable{{(\accRoots{(FS,H)}, \Graph{(H)})}}. \notag\\
    & \ocap{(\typeOf{(q, H)})}
    \end{aligned}&
  \end{flalign*}
\end{proposition}

% TODO should I elaborate?
\begin{proof}
  Follows from definition of $\accRoot$, $\accRoots$ and $\reachable$.
\end{proof}

\begin{proposition} \label{prop:csep_eq}
  For any heap $H$ and object references $o, o'$ we have
  \begin{flalign*}
    &\csep{(H, o, o')} \iff &\\
    & \begin{aligned}
        \forall q \in \: &\reachable{(\{o\}, \Graph{(H)})} \cap \reachable{(\{o'\},
        \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

\begin{proof}
  First of all we let $R = \reachable{(\{o\}, \Graph{(H)})}, R' =
  \reachable{(\{o'\}, \Graph{(H)})}$.
  We prove each direction of implication separately.
  \begin{description}
    \item[Case $\implies$:] Take any $q \in  R\cap R'$. By definition of
      $\reachable$, reachability equivalence (prop.~\ref{prop:reacheq}) and 
      definition of $\csep{(H, o, o')}$ we have $\typeOf{(q, H)} \stof \CellType$.
    \item[Case $\impliedby$:] Take any $q, q'\in \dom{(H)}$ such that
      $\reach{(H, o, q)}$ and $\reach{(H, o', q')}$. If $q \neq q$ we are done.
      Otherwise $q = q'$ and by definition of $\reachable$ $q \in R \cap R'$.
      Finally $\typeOf{(q, H)} \stof \CellType$ by assumption.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:2.6}
  For any heap $H$ and frame stacks $FS, HS$ we have
  \begin{flalign*}
    &\isolated{(H, FS, HS)}  \iff &\\
    &\begin{aligned}
        \forall q \in \:&\reachable{(\accRoots{(FS, H)}, \Graph{(H)})} \cap \\
        & \reachable{(\accRoots{(HS, H)}, \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

% TODO proof
\begin{proof}
  Let $R = \reachable(\accRoots(FS, H), \Graph(H)), R' =
  \reachable(\accRoots(HS, H), \Graph(H))$. We prove each direction of
  implication separately.
  \begin{description}
    \item[Case $\implies$:] Take $q \in R \cap R'$. Then 
      \begin{equation*}
        \exists o \in \accRoots(FS, H), o' \in \accRoots(HS, H)
      \end{equation*}
      such that
      \begin{equation*}
        q \in \reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\}, \Graph(H))
      \end{equation*}
      By definition of $\accRoots$ we have
      \begin{equation*}
        \accRoot(o, FS, H) \land \accRoot(o', HS, H)
      \end{equation*}
      and thus by $\isolated(H, FS, HS)$ we have $\csep(H, o, o')$. 
      Proposition~\ref{prop:csep_eq} yields $\typeOf(q, H) \stof \CellType$.
    \item[Case $\impliedby$:] Take any $o, o' \in \dom(H)$ such that
      \begin{equation*}
        \accRoot(o, FS, H) \land \accRoot(o', HS).
      \end{equation*}
      Clearly then $o \in \accRoots(FS, H)$ and $o \in \accRoots(HS, H)$.
      Moreover
      \begin{gather*}
        \reachable(\{o\}, \Graph(H)) \subseteq R \\
        \reachable(\{o'\}, \Graph(H)) \subseteq R'
      \end{gather*}
      By assumption then
      \begin{align*}
        \forall q \in &\reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\},
        \Graph(H)). \\ 
        &\typeOf(q, H) \stof \CellType
      \end{align*}
      and by proposition~\ref{prop:csep_eq} we have $\csep(H, o, o')$. Since
      $o, o'$ arbitrary we are done.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:2.11}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ FS|_a^d \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ FS'|_a^d \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall HS|_b^e \in Q.$ \\ 
      $\reachable{(\accRoots{(HS, H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(HS, H)}, \Graph{(H)})}$
    \item $\reachable{(\accRoots{(FS', H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(FS, H)}, \Graph{(H)})}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{proposition}

\begin{remark}
  Note that $\Graph{(H)} = \Graph{(H')}$ implies $\dom{(H)} = \dom{(H')}$.
  Otherwise many of the preconditions above would not make sense.
\end{remark}

\begin{proof}
  We prove that 
  \begin{equation*}
    \forall \text{ distinct } HS|_a^d, GS|_b^e \in P'.\; a = \ocap \lor b = \ocap \implies
    \isolated(H', HS, GS).
  \end{equation*}
  This implies $\isolation(H', P')$ by rule {\sc ISO-Procs}.
  Take any distinct $HS|_b^e, GS|_c^f \in P$. Then by assumption 3, 4 and basic set
  properties
  \begin{equation} \label{eq:reachinclusion1}
    \begin{gathered}
      \reachable(\accRoots(HS, H'), \Graph(H')) \cap \reachable(\accRoots(GS, H'),
      \Graph(H')) \\
      \subseteq \\
      \reachable(\accRoots(HS, H), \Graph(H)) \cap \reachable(\accRoots(GS, H),
      \Graph(H)).
    \end{gathered}
  \end{equation}
  By this, proposition~\ref{prop:2.6} and $\isolation(H, HS, GS)$ we have
  $\isolation(H', HS, GS)$. By \eqref{eq:reachinclusion1} and assumption 5
  we have $H' \vdash P' \tsep \ocr$.
\end{proof}

\begin{corollary} \label{cor:2.11}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ FS|_a^d \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ FS'|_a^d \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall HS|_b^e \in Q. \: \accRoots{(HS, H')} \subseteq \accRoots{(HS, H)}$
    \item $\accRoots{(FS', H')} \subseteq \accRoots{(FS, H)}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{corollary}

\begin{proof}
  Assumption 2 and 3 implies assumption 2 and 3 of
  proposition~\ref{prop:2.11}
\end{proof}

\begin{definition} \label{def:ptilde}
  Let $FS_g = \Frame{L_0}{global}{-} \circ \varepsilon$ bet the framestack where
  $L_0 = [global \mapsto o_g]$. Then for any thread set $P$, let $\tilde{P}$ be the
  thread set
  \begin{equation*}
    \tilde{P} = P \cup \left\{ FS_g|_{\nocap}^d \right\}
  \end{equation*}
  for some valid $d$.
\end{definition}

\begin{proposition} \label{prop:2.8}
  For any heap $H$ and thread set $P$
  \begin{equation*}
    \isolation{(H, \tilde{P})} \iff \isolation{(H, P)} \text{ and } H \vdash P
    \tsep \gsep 
  \end{equation*}
\end{proposition}

\begin{proof}
  This follows almost immediately by the definitions of isolation and global
  object separation, and the fact that $\accRoots(FS_g) = \left\{
    o_g \right\}$ 
\end{proof}

We state the following two propositions without proof, but they should be quite
obvious.
% TODO define transition identifier
\begin{proposition} \label{prop:uniq_trans}
  Let $H, P \Rrightarrow H', P'$. Then there is a unique transition identifier
  $R^{\alpha, \beta}$ such that $H, P \Rrightarrow^{R^{\alpha, \beta}} H', P'$.
\end{proposition}

\begin{proposition} \label{prop:tilde_trans}
  Let $H, P \Rrightarrow^{R^{\alpha, \beta}} H', P'$. Then $H, \tilde{P}
  \Rrightarrow^{R^{\alpha, \beta}} H', \tilde{P'}$
\end{proposition}

%TODO check formulation of prop
\begin{proposition} \label{prop:2.9}
  If for any $H, H', P, P'$ such that $\vdash H, H \vdash P$ and $H, P
  \Rrightarrow^{R^{\alpha, \beta}} H', P'$
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \isolation(H, \tilde{P}) \implies \isolation(H', \tilde{P'})
  \end{equation*}
\end{proposition}

\begin{proof}
  By proposition~\ref{prop:tilde_trans} $H, \tilde{P} \Rrightarrow^{R^{\alpha,
  \beta}} H', \tilde{P'}$. It is easy to see that $\vdash H$ and $H \vdash
  \tilde{P}$.
  Since the assumption of the proposition refers to any $H, H', P, P'$ for which
  these three properties hold the statement also holds for $H, H',
  \tilde{P}, \tilde{P'}$.
\end{proof}

\begin{remark}
  This proposition may seem a bit circular, but what it does is allow us to get
  the global separation property for free in most cases in the proof of
  preservation by combining it with proposition~\ref{prop:2.8}. We state
  this in the following corollary.
\end{remark}

\begin{corollary}
  If for any $H, H', P, P'$ such that $\vdash H, H \vdash P$ and $H, P
  \Rrightarrow^{R^{\alpha, \beta}} H', P'$
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \begin{gathered}
      \isolation(H, P) \text{ and } H \vdash P \tsep \gsep \\
      \implies \\
      \isolation(H', P') \text{ and } H \vdash P' \tsep \gsep
    \end{gathered}
  \end{equation*}
\end{corollary}

% TODO define \Values set
\begin{proposition} \label{prop:2.12}
  Let $H, H'$ be heaps. If $\dom{(H)} = \dom{(H')}$ and
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}
  \end{equation*}
  then 
  \begin{equation*}
    \forall k \in \Values. \: \typeOf{(k, H)} = \typeOf{(k, H')}
  \end{equation*}
\end{proposition}

\begin{proof}
  It is easy to see since the only values in $\Values$ where its type depends on
  $H$ is the object references $o$.
\end{proof}

\begin{proposition} \label{prop:2.19}
  If
  \begin{equation*}
    \forall o \in \dom(H) \subseteq \dom(H'). \: \typeOf(o, H) = \typeOf(o, H')
  \end{equation*}
  and $H \vdash \Gamma; L$, then $H' \vdash \Gamma; L$.
\end{proposition}

\begin{proof}
  It is obvious from the structure of the rules {\sc WF-EnvVar} and {\sc
  WF-Env} and the assumptions of the proposition.
\end{proof}

\begin{proposition} \label{prop:2.13}
  For any $H, P$ we have 
  \begin{equation}
    H \vdash P \iff \forall HS|_b^e \in P.\: H;b \vdash HS
  \end{equation}
\end{proposition}

\begin{proof} (Sketch) Done in each direction separately.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of the derivation tree.
    \item[Case $\impliedby$:] By induction on size of $P$.
  \end{description}
\end{proof}

% TODO define heap
\begin{proposition} \label{prop:2.14}
  Let $H, H'$ be heaps such that $\dom{(H)} \subseteq \dom{(H')}$ and 
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}.
  \end{equation*}
  Then for any frame stack $FS$
  \begin{equation}\label{eq:fs_impl_typing1}
    H; a \vdash FS \implies H'; a \vdash FS
  \end{equation}
  and
  \begin{equation} \label{eq:fs_impl_typing2}
    H; a \vdash^{x :\sigma} FS \implies H'; a \vdash^{x: \sigma} FS 
  \end{equation}
\end{proposition}

\begin{proof}
  We first prove \eqref{eq:fs_impl_typing2} by induction on the lenght $n$ of
  $FS$. To prove the implication we assume that $H; a \vdash^{x: \tau} FS$.
  
  If $n = 0$ we have $FS = \varepsilon$. By {\sc T-FSEmpty2} we are done.
  
  If $n = i + 1$ we have $FS = F \circ GS$ where length of $GS$ is $i$. By  
  $H; a \vdash^{x: \sigma} FS$ and {\sc T-FS2} we have 
  \begin{equation*}
    F = \xframe{L, t}^{y} \andalso H \vdash \Gamma; L \andalso \TypeRel{\Gamma, x:
    \sigma}{a}{t}{\tau} \andalso H; a \vdash^{y: \tau} GS.
  \end{equation*}
  By induction hypothesis we then have $H'; a \vdash^{y: \tau} GS$. We get $H'
  \vdash \Gamma; L$ from proposition \ref{prop:2.19}. Applying rule {\sc T-FS2}
  yields $H'; a \vdash^{x: \sigma} FS$.

  Now we prove \eqref{eq:fs_impl_typing1}. Similarly assuming $H; a \vdash^{x:
  \tau} FS$ we have two cases. If $FS = \varepsilon$ we are done by {\sc
  T-FSEmpty1}. If $FS = F \circ GS$ we by {\sc T-FS1} have
  \begin{equation*}
    F = \xframe{L, t}^{x} \andalso H \vdash \Gamma; L \andalso
    \TypeRel{\Gamma}{a}{t}{\tau} \andalso H; a \vdash^{x: \sigma} GS.
  \end{equation*}
  By \eqref{eq:fs_impl_typing1} $H'; a \vdash^{x: \sigma} GS$ and
  proposition~\ref{prop:2.19} yields $H' \vdash \Gamma; L$. Applying rule {\sc
  T-FS1} gives us $H'; a \vdash FS$.
\end{proof}

% TODO fix the statement
\begin{proposition}
  Let $HS|_b^e \in Q$ where $Q$ as in thm case {\sc E-Assign}. Then
  \begin{align*}
    &\reachable{(\accRoots{(FS',H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
  and if $a = \ocap$ or $b = \ocap$ then
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}
  \end{align*}
\end{proposition}

\begin{corollary}
  If $b = \ocap$ then 
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}
  \end{align*}
\end{corollary}

\begin{corollary}
  \begin{align*}
    &\reachable{(\accRoots{(FS',H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
\end{corollary}

\begin{proposition}
  Let $HS|_b^e \in Q$ where $Q$ as in thm case {\sc E-Assign}. Then
  \begin{align*}
    &\reachable{(\accRoots{(HS,H')}, \Graph{(H')})} \subseteq \\
    &\reachable{(\accRoots{(HS,H)}, \Graph{(H)})}\: \cup \\ 
    &\reachable{(\accRoots{(FS,H)}, \Graph{(H)})}
  \end{align*}
\end{proposition}

% TODO 2.20 can it be included in 2.5 perhaps?

\section{Proof of preservation}
\label{sec:proof_of_preservation}

\begin{proof} 
  First of all we have that $S \neq \Error$ since no step can be made from this
  state. Thus $S = H, P$ and
  \begin{equation*}
    \vdash H \andalso H \vdash P \andalso H \vdash P \tsep \ocr \andalso
    \isolated{(H, P)} \andalso H \vdash P \tsep \gsep
  \end{equation*}
  We also assume we have $S' = H', P'$ since otherwise $S' = \Error$ and the
  theorem holds trivially. What remains is to prove
  \begin{equation*}
    \vdash H' \andalso H' \vdash P' \andalso H' \vdash P' \tsep \ocr \andalso
    \isolated{(H', P')} \andalso H' \vdash P' \tsep \gsep.
  \end{equation*}
  We proceed by cases.
  \begin{description}
    \item[Case {\sc E-FSProp}:] According to this rule $P = Q \cup_D \left\{
        FS|_a^d \right\}$ and $P' = Q \cup \left\{ FS'|_a^d \right\}$. We proceed by cases.
      \begin{description}
        \item[Case {\sc E-FProp}:] By the rule definition $FS|_a^d = F \circ
          GS|_a^d$ and $FS'|_a^d = F' \circ GS|_a^d$. Furthermore we can assume
          that $F = \sframe{L, t}$ and $F' = \sframe{L', t'}$.
          We proceed by cases.
          \begin{description}
            \item[Case {\sc E-Null}:] By this rule we have $t =
              \Let{x}{\NullVal}{t'}$, $H = H'$ and $L' = L[x \mapsto \NullVal]$.
              Immediatelly we have $\vdash H'$.

              By {\sc T-Procs} and proposition~\ref{prop:2.13} we have 
              \begin{equation} \label{eq:enull1}
               H \vdash Q  \andalso H; a \vdash FS 
              \end{equation}
              Trivially $H' \vdash Q$. 
              By~\eqref{eq:enull1} and rule {\sc T-FS1} we have
              \begin{equation} \label{eq:enull2}
                H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma}
                \andalso H; a \vdash^{s: \sigma} GS.
              \end{equation}
              Let $\Gamma' = \Gamma, x: \NullType$. By {\sc T-Let}, {\sc
              T-Null} and \eqref{eq:enull2} we have
              \begin{equation} \label{eq:enull3}
                \TypeRel{\Gamma'}{a}{t'}{\sigma}.
              \end{equation}
              By {\sc T-FS1}, \eqref{eq:enull3} and \eqref{eq:enull2}
              \begin{equation}\label{eq:enull4}
                H;a \vdash FS'
              \end{equation}
              By \eqref{eq:enull4}, {\sc T-Procs} and $H = H'$ we get  
              \begin{equation}
                H' \vdash P'
              \end{equation}
              $H' \vdash P' \tsep \ocr$ and $\isolation{(H', P')}$ follows from
              the corollary of proposition~\ref{prop:2.11}. Then $H' \vdash P'
              \tsep \gsep$ follows from propositions~\ref{prop:2.8}
              and~\ref{prop:2.9} since we never use the $\gsep$ property to
              prove isolation.
            \item[Case {\sc E-LVal}:] Similarly.
            \item[Case {\sc E-Var}:] First, by rule {\sc E-Var} we have
              \begin{equation*} 
                \begin{gathered}
                  F = \sframe{L, t} \andalso t = \Let{x}{y}{t'} \\ 
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(y)].
                \end{gathered}
              \end{equation*}
              Also
              \begin{equation} \label{eq:evar1}
                H = H'
              \end{equation}
              so $\vdash H'$.
              By {\sc T-Procs}, {\sc T-FS1} and proposition \ref{prop:2.13}
              \begin{equation} \label{eq:evar3}
                H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma}
                \andalso H; a \vdash^{s: \sigma} GS
              \end{equation}
              By {\sc T-Let, T-Var} and $\TypeRel{\Gamma}{a}{t}{\sigma}$
              \begin{equation} \label{eq:evar4}
                \TypeRel{\Gamma}{a}{y}{\gamma} \andalso \TypeRel{\Gamma, x:
                \gamma}{a}{t'}{\sigma}.
              \end{equation}
              Let $\Gamma' = \Gamma, x: \gamma$.
              Then by \eqref{eq:evar4}
              \begin{equation} \label{eq:evar5}
                \TypeRel{\Gamma'}{a}{t'}{\sigma}.
              \end{equation}
              By $H \vdash \Gamma; L$, \eqref{eq:evar1}, \eqref{eq:evar5}, and
              rules {\sc WF-EnvVar}, {\sc WF-Env}
              \begin{equation*}
                \typeOf(L'(x), H') = \typeOf(L(y), H) \stof \Gamma(y) \stof
                \Gamma'(x).
              \end{equation*}
              From definitions of $\Gamma', L'$ and $H \vdash \Gamma;L$ we also have 
              \begin{equation*}
                \begin{aligned}
                  \forall z \in &\dom(\Gamma') \text{ s.t. } z \neq x. \\
                  & \typeOf(L'(z), H') \leq \Gamma'(z).
                \end{aligned}
              \end{equation*}
              Thus
              \begin{equation} \label{eq:evar6}
                H' \vdash \Gamma'; L'
              \end{equation}
              by applying rules {\sc WF-EnvVar} and {\sc WF-Env}.
              By {\sc T-FS1}, \eqref{eq:evar3}, \eqref{eq:evar5},
              \eqref{eq:evar6} we have
              \begin{equation} \label{eq:evar7}
                H'; a \vdash FS'.
              \end{equation}
              By proposition \ref{prop:2.13} and $H \vdash P$ we get
              \begin{equation*} 
                \forall HS|_b^d \in Q. \: H; b \vdash HS.
              \end{equation*}
              By this, \eqref{eq:evar1}, proposition \ref{prop:2.14} and \ref{prop:2.13}
              \begin{equation*}
                H' \vdash Q
              \end{equation*}
              Combining this with \eqref{eq:evar7} and {\sc T-Procs} finally
              yields
              \begin{equation*}
                H' \vdash P'
              \end{equation*}

              We now move on to OCAP reachability, isolation and global object
              separation. We note that all preconditions of the corollary of
              proposition~\ref{prop:2.11} holds. Thus we immediately have 
              \begin{equation*}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P').
              \end{equation*}
              $H' \vdash P' \tsep \gsep$ immediately follows by corollary to
              proposition \ref{prop:2.9}.
            \item[Case {\sc E-Select}:] By rule {\sc E-Select}
              \begin{equation} \label{eq:eselect1}
                \begin{gathered}
                  H = H' \andalso F = \sframe{L, t} \andalso t =
                  \Let{x}{\FSel{y}{f}}{t'} \\
                  L(y) = o \andalso H(o) = \Obj{C, FM} \andalso f \in \dom(FM)
                  \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto FM(f)]
                \end{gathered}
              \end{equation}
              We immediately see $\vdash H'$. By $\vdash H$ we have
              \begin{equation} \label{eq:eselect2}
                \typeOf(FM(f), H) \stof \ftype(f, C).
              \end{equation}
              $H \vdash P$, propositions \ref{prop:2.13}, \ref{prop:2.14} yields
              $H \vdash Q$ and thus $H' \vdash Q$.
              $H \vdash P$, proposition \ref{prop:2.13} gives 
              \begin{equation} \label{eq:eselect3}
                H; a \vdash FS
              \end{equation}
              which under inspection of rule {\sc T-FS1} immediately gives
              \begin{equation} \label{eq:eselect4}
                H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma}
                \andalso H; a \vdash^{s: \sigma} GS.
              \end{equation}
              $\TypeRel{\Gamma}{a}{t}{\sigma}$ together with rule {\sc T-Let}
              gives
              \begin{equation} \label{eq:eselect5}
                \TypeRel{\Gamma}{a}{\FSel{y}{f}}{\gamma} \andalso
                \TypeRel{\Gamma, x: \gamma}{a}{t'}{\sigma}.
              \end{equation}
              which combined with {\sc T-Select} and {\sc T-Var} gives us
              \begin{equation} \label{eq:eselect6}
                (y: C) \in \Gamma \andalso \ftype(f, C) = \gamma
              \end{equation}
              Let $\Gamma' = \Gamma, x: \gamma$. Similarly to case {\sc E-Var}
              we see that
              \begin{equation} \label{eq:eselect7}
                \forall z \in L \text{ s.t. } z \neq x . \: \typeOf(L(z), H')
                \stof \Gamma'(z).
              \end{equation}
              Furthermore, because of \eqref{eq:eselect2} and $H = H'$
              \begin{equation} \label{eq:eselect8}
                \begin{aligned}
                  \typeOf(L'(x), H') &= \typeOf(FM(f), H') \\
                                     &\stof \ftype(f, C) \\
                                     &= \Gamma'(x)
                \end{aligned}
              \end{equation}
              Using {\sc WF-Env, WF-EnvVar}, \eqref{eq:eselect7} and
              \eqref{eq:eselect8} we have
              \begin{equation} \label{eq:eselect9}
                H' \vdash \Gamma';L'.
              \end{equation}
              Using {\sc T-FS1} with \eqref{eq:eselect4}, \eqref{eq:eselect5}
              and \eqref{eq:eselect9} we finally get
              \begin{equation}
                H';a \vdash FS'
              \end{equation}
              which with the help of {\sc T-Procs} gives us 
              \begin{equation*}
                H'\vdash P'.
              \end{equation*}
              
              Moving on to OCAP reachability, isolation and global object
              separation we can easily see that the preconditions of proposition
              \ref{prop:2.11} holds and thus we immediately get
              \begin{equation*}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P')
              \end{equation*}
              Again using corollary to proposition \ref{prop:2.9} we get
              \begin{equation*}
                H' \vdash P' \tsep \gsep.
              \end{equation*}


            \item[Case {\sc E-Assign}:] The {\sc E-Assign} rule gives us that
              \begin{equation} \label{eq:eassign1}
                \begin{gathered}
                  F = \sframe{L, t} \andalso t = \Let{x}{\FAss{y}{f}{z}}{t'} \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(z)] \\
                  L(y) = o \andalso H(o) = \Obj{C, FM} \andalso f \in \dom(FM)
                  \\
                  FM' = FM[f \mapsto L(z)] \andalso H' = H[o \mapsto \Obj{C, FM'}]
                \end{gathered}
              \end{equation}
              We begin by proving $\vdash H'$. First we note
              that only change from $H$ to $H'$ is in what object $o$ maps to.
              Clearly from \eqref{eq:eassign1} we have
              \begin{equation} \label{eq:eassign2}
                \forall o \in \dom(H) = \dom(H'). \: \typeOf(o, H) = \typeOf(o,
                H')
              \end{equation}
              Thus by proposition \ref{prop:2.12} 
              \begin{equation} \label{eq:eassign3}
                \forall k \in \Values. \: \typeOf(k, H) = \typeOf(k,
                H')
              \end{equation}

              \begin{addmargin}[1em]{1em}
                \begin{remark}
                  This means that immediately it is clear that the conditions for
                  $\vdash H'$ holds for all $o' \in \dom(H')$ s.t. $o' \neq o$.
                \end{remark}
              \end{addmargin}

              By $\vdash H$, definition of $H'$ and \eqref{eq:eassign3}
              \begin{equation} \label{eq:eassign4}
                \begin{aligned}
                  \forall f' &\in \fields(C), f' \neq f. \\ 
                                 &\typeOf(FM'(f'), H') \stof \ftype(f, C)
                \end{aligned}
              \end{equation}
              By $H \vdash P$ and prop. \ref{prop:2.13}
              \begin{equation} \label{eq:eassign5}
                H;a \vdash FS.
              \end{equation}
              This and {\sc T-FS1} yields
              \begin{equation}\label{eq:eassign6}
                H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma}
                \andalso H; a \vdash^{s: \sigma} GS
              \end{equation}
              By $H;a \vdash^{s: \sigma} GS$, \eqref{eq:eassign2} and prop.
              \ref{prop:2.14} we have 
              \begin{equation} \label{eq:eassign7} 
                H'; a \vdash^{s: \sigma} GS
              \end{equation}
              $\TypeRel{\Gamma}{a}{t}{\sigma}$ and {\sc T-Let} gives
              \begin{equation} \label{eq:eassign8}
                \TypeRel{\Gamma}{a}{\FAss{y}{f}{z}}{\gamma} \andalso
                \TypeRel{\Gamma, x: \gamma}{a}{t'}{\sigma}
              \end{equation}
              which whith {\sc T-Assign} gives us
              \begin{equation} \label{eq:eassign9}
                \TypeRel{\Gamma}{a}{y}{C'} \andalso \ftype(f, C') = \alpha \\
                \TypeRel{\Gamma}{a}{z}{\alpha'} \andalso \alpha' \stof \alpha
              \end{equation}
              By {\sc T-Var} and \TypeRel{\Gamma}{a}{y}{C'}
              \begin{equation}\label{eq:eassign10}
                (y: C') \in \Gamma 
              \end{equation}
              or equivalently $\Gamma(y) = C'$.
              Similarly
              \begin{equation} \label{eq:eassign11}
                (z: \alpha') \in \Gamma.
              \end{equation}
              By $H \vdash \Gamma; L$ we have $H \vdash \Gamma; L; z$ and thus
              \begin{equation} \label{eq:eassign12}
                \begin{aligned}
                  \typeOf(L(z), H) &= \alpha'' \\ 
                                   &\stof \alpha' \\ 
                                   &\stof \alpha \\ 
                                   &= \ftype(f, C') \\ 
                                   &= \ftype(f, C)
                \end{aligned}
              \end{equation}
              where the last equality comes from the fact that the classes are
              well formed. By \eqref{eq:eassign1} we have $FM'(f) = L(z)$ and
              combining this with \eqref{eq:eassign12} we get
              \begin{equation} \label{eq:eassign13}
                \typeOf(FM'(f), H) \stof \ftype(f, C).
              \end{equation}
              Combined with \eqref{eq:eassign3}, \eqref{eq:eassign4} and the
              remark above we get
              \begin{equation*} 
                \vdash H'
              \end{equation*}

              $H' \vdash P'$ follows similarly to {\sc E-Var} case.

              We now move on to OCAP reachability, isolation and global object
              separation.  Note that the only insteresting case is if $L(z)$ is
              an object refence, since otherwise the preconditions to corollary
              \ref{cor:2.11} holds and we are done similarly to previous cases.
              Therefore we assume $L(z) \in \dom(H)$.  To help our efforts we
              state the following lemma.

              \begin{lemma} \label{lem:2.15}
                Let $HS|_b^e \in Q$ and $L(z) \in \dom(H)$. Then
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(FS', H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(FS, H), \Graph(H))
                  \end{aligned}
                \end{equation*}
                and
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(HS, H), \Graph(H)) \cup  \\
                    &\reachable(\accRoots(FS, H), \Graph(H)).
                  \end{aligned}
                \end{equation*}
                Furthermore, if $a = \ocap$ or $b = \ocap$ then
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(HS, H), \Graph(H))
                  \end{aligned}
                \end{equation*}
              \end{lemma}

              \begin{proof}
                Let $\Graph(H) = (V_H, E_H)$. Then clearly
                \begin{equation}
                  \Graph(H') = \left(V_H, E_H \setminus \{(o_y, FM(f))_f \} \cup
                  \{(o_y, o_z)_f \} \right)
                \end{equation}
                Let $L(y) = o_y$. We prove each part separately. 
                We begin with
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(FS', H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(FS, H), \Graph(H)).
                  \end{aligned}
                \end{equation*}
                Let
                \begin{equation*}
                  q \in \reachable(\accRoots(FS', H'), \Graph(H')).
                \end{equation*}
                Because of reachability equivalence (proposition
                \ref{prop:reacheq}) this means
                \begin{equation}
                  \begin{aligned}
                    o &\in \accRoots(FS', H'). \\
                    & \exists \text{ path } o_0, \dots, o_n \in \Graph(H')
                    \text{ s.t. } o_0 = o, o_n = q
                  \end{aligned}
                \end{equation}
                Let $f_i$ the associated field names from which the path is
                formed, i.e. $(o_i, o_{i+1}) \in \Graph(H')$.
                Clearly $o \in \accRoots(FS, H)$. 

                There are two cases:
                \begin{enumerate}
                  \item For some $i \in \left\{ 0, \dots, n-1 \right\}$ $o_i =
                    o_y, o_{i+1} = o_z$ and $f_i = f$.
                  \item There is no such $i$.
                \end{enumerate}
                We prove each case separately. For case 1 let $i$ be the last
                such index. Examine the path 
                \begin{equation}
                  o_{i+1}, \dots, o_n
                \end{equation}
                Clearly this path is in $\Graph(H)$ since we chose $i$ to be the
                last index that fulfills case 1.  Since $o_{i+1} = o_z$ and
                $o_z$ obviously is in $\accRoots(FS, H)$
                \begin{equation}
                  q \in \reachable(\accRoots(FS, H), \Graph(H)).
                \end{equation}

                For case 2 the new edge $(o_y, o_z)_f$ is not part of the path.
                Thus all edges $(o_i, o_{i+1})_{f_i}$ are in $\Graph(H)$ and and
                thus the path $o_0, \dots, o_n$ is a path in $\Graph(H)$ aswell.
                This means $q \in \reachable(\accRoots(FS, H), \Graph(H))$ which
                concludes the proof of the first part of the lemma.

                To prove 
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(HS, H), \Graph(H)) \cup  \\
                    &\reachable(\accRoots(FS, H), \Graph(H)).
                  \end{aligned}
                \end{equation*}
                take any
                \begin{equation}
                  q \in \reachable(\accRoots(HS, H'), \Graph(H')).
                \end{equation}
                Similarly to before
                \begin{equation}
                  \begin{aligned}
                    o &\in \accRoots(HS, H'). \\
                    & \exists \text{ path } o_0, \dots, o_n \in \Graph(H')
                    \text{ s.t. } o_0 = o, o_n = q
                  \end{aligned}
                \end{equation}
                We let $f_i$ be as before.
                We have exactly the same cases. For case 1 we let $i$ be the last
                such index. Then similarly to before we get that $o_{i+1} \in
                \accRoots(FS, H)$ and $q \in \reachable(\accRoots(FS, H),
                \Graph(H))$.
                
                Case 2 is analogous and reaches the conclusion that $q \in
                \reachable(\accRoots(HS, H), \Graph(H))$.

                Lastly we prove that if $a = \ocap$ or $b = \ocap$ then
                \begin{equation*}
                  \begin{aligned}
                    &\reachable(\accRoots(HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(HS, H), \Graph(H)).
                  \end{aligned}
                \end{equation*}
                To prove this implication we assume that either $a = \ocap$ or
                $b = \ocap$. As before we take any
                \begin{equation}
                  q \in \reachable(\accRoots(HS, H'), \Graph(H')).
                \end{equation}
                Similarly we get that there there must be an $o \in
                \accRoots(HS, H')$ such that
                \begin{equation}
                  \exists \text{ path } o_0, \dots, o_n \in \Graph(H') \text{ s.t. } o_0 = o,
                  o_n = q
                \end{equation}
                with related field names $f_i$. We get the exact same cases as
                above, but we instead let $i$ be the first index with the
                properties described. This means we have the edge $(o_y, o_z)_f$
                as part of our path. Specifically this means
                \begin{equation}
                  o_y \in \reachable(\accRoots(FS, H), \Graph(H))
                \end{equation}
                since $o_0, \cdot, o_i$ is a path in \Graph from $o$ to $o_y$.
                Moreover
                \begin{equation}
                  o_y \in \reachable(\accRoots(FS, H), \Graph(H))
                \end{equation}
                since $(y \mapsto o_y) \in L$ and from the {\sc E-Assign} rule
                definition it is clear that
                \begin{equation}
                  \typeOf(o_y, H) \not\stof \CellType.
                \end{equation}
                But this contradicts isolation. To see this first  note that
                $H \vdash P$ together with $a = \ocap$ or $b = \ocap$ implies
                $\isolated(H, FS, HS)$. Then apply proposition~\ref{prop:2.6}.
                
                For the second case it is clear that $o_0, \dots, o_n$ is also a
                path from $o$ to $q$ in $\Graph(H)$ which immediately implies
                $q \in \reachable(\accRoots(HS, H), \Graph(H))$.

                This concludes the proof of the lemma.
              \end{proof}


              
          \end{description}
      \end{description}
  \end{description}
\end{proof}








