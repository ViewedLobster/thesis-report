\chapter{Proof of Preservation and Progress}
\label{cha:proof_of_pnp}

\section{Preliminaries}%
\label{sec:preliminaries}

\begin{definition}[Heap Induced Graph]
  The induced graph of heap $H$, written $\Graph{(H)}$ is the directed graph
  $(V, E)$ such that $V = \dom{(H)}$ and 
  \begin{equation}
    E = \left\{ (o, o')_f \in \dom{(H)}^2 \times \FieldNames \mid
      H(o) = \Obj{C, \FM} \text{ and } \FM(f) = o' \right\}
  \end{equation}
\end{definition}

\begin{definition}[Graph Reachability]
  We say an object $o'$ is reachable from $o$ in graph $G = (V,
  E)$, written $\reach{(G, o, o')}$ if there is a finite sequence $o_0, \dots,
  o_n \in V$ such that $o = o_0, o_n = o'$ and
  \begin{equation}
    \forall i = 1,\dots, n-1. \: \exists f_i \in \FieldNames \text{ s.t. } (o_i,
    o_{i+1})_{f_i} \in E.
  \end{equation}
  The sequence $o_0, \dots, o_n$ is called a \emph{path}.
\end{definition}

\begin{definition}
  Given a graph $G = (V, E)$ and a set $O \subseteq V$, we define
  \begin{equation}
    \reachable{(O, G)} = \left\{ q \in V: \exists o\in O.\: \reach{(G, o, q)}
    \right\} \notag
  \end{equation}
\end{definition}

\begin{proposition}[Reachability equivalence]
  \label{prop:reacheq}
  For a heap $H$ 
  \begin{equation}
    \reach{(H, o, o')} \iff \reach{(\Graph{(H)}, o, o')}
  \end{equation}
\end{proposition}

\begin{proof}
  Both directions of implication are simple to prove.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of derivation tree.
    \item[Case $\impliedby$:] By induction on the path length in graph
      $\Graph{(H)}$.
  \end{description}
\end{proof}

\begin{proposition} For any heap $H$ and frame stack $\FS$ we have
  \begin{flalign*}
    &\ocrloc{(\FS, H)} &\\
    &\iff &\\
    &\begin{aligned}
    \forall q &\in \reachable{{(\accRoots{(\FS,H)}, \Graph{(H)})}}. \notag\\
    & \ocap{(\typeOf{(q, H)})}
    \end{aligned}&
  \end{flalign*}
\end{proposition}

\begin{proof}
  Follows from definition of $\ocrloc$, $\accRoots$ and $\reachable$.
\end{proof}

\begin{proposition} \label{prop:csep_eq}
  For any heap $H$ and object references $o, o'$ we have
  \begin{flalign*}
    &\csep{(H, o, o')} \iff &\\
    & \begin{aligned}
        \forall q \in \: &\reachable{(\{o\}, \Graph{(H)})} \cap \reachable{(\{o'\},
        \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

\begin{proof}
  First of all we let $R = \reachable{(\{o\}, \Graph{(H)})}, R' =
  \reachable{(\{o'\}, \Graph{(H)})}$.
  We prove each direction of implication separately.
  \begin{description}
    \item[Case $\implies$:] Take any $q \in  R\cap R'$. By definition of
      $\reachable$, reachability equivalence (prop.~\ref{prop:reacheq}) and 
      definition of $\csep{(H, o, o')}$ we have $\typeOf{(q, H)} \stof \CellType$.
    \item[Case $\impliedby$:] Take any $q, q'\in \dom{(H)}$ such that
      $\reach{(H, o, q)}$ and $\reach{(H, o', q')}$. If $q \neq q$ we are done.
      Otherwise $q = q'$ and by definition of $\reachable$, $q \in R \cap R'$.
      By assumption $\typeOf{(q, H)} \stof \CellType$.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:2.6}
  For any heap $H$ and frame stacks $\FS, \HS$ we have
  \begin{flalign*}
    &\isolated{(H, \FS, \HS)}  \iff &\\
    &\begin{aligned}
        \forall q \in \:&\reachable{(\accRoots{(\FS, H)}, \Graph{(H)})} \cap \\
        & \reachable{(\accRoots{(\HS, H)}, \Graph{(H)})}. \\
        & \typeOf{(q, H)} \stof \CellType
    \end{aligned}&
  \end{flalign*}
\end{proposition}

\begin{proof}
  We let 
  \begin{equation*}
    \begin{gathered}
      R = \reachable(\accRoots(\FS, H), \Graph(H))  \\
      R' = \reachable(\accRoots(\HS, H), \Graph(H))  
    \end{gathered}
  \end{equation*}
  We prove each direction of implication separately.
  \begin{description}
    \item[Case $\implies$:] Take $q \in R \cap R'$. Then 
      \begin{equation*}
        \exists o \in \accRoots(\FS, H), o' \in \accRoots(\HS, H)
      \end{equation*}
      such that
      \begin{equation*}
        q \in \reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\}, \Graph(H)).
      \end{equation*}
      Thus by $\isolated(H, \FS, \HS)$ we have $\csep(H, o, o')$. 
      Proposition~\ref{prop:csep_eq} yields $\typeOf(q, H) \stof \CellType$.
    \item[Case $\impliedby$:] Take any $o, o'$ such that
      \begin{equation*}
        o \in \accRoots(\FS, H) \andalso o' \in \accRoots(\HS, H).
      \end{equation*}
      By definition
      \begin{gather*}
        \reachable(\{o\}, \Graph(H)) \subseteq R \\
        \reachable(\{o'\}, \Graph(H)) \subseteq R'.
      \end{gather*}
      Thus by assumption 
      \begin{align*}
        \forall q \in &\reachable(\{o\}, \Graph(H)) \cap \reachable(\{o'\},
        \Graph(H)). \\ 
        &\typeOf(q, H) \stof \CellType.
      \end{align*}
      Finally by Proposition~\ref{prop:csep_eq}, we have $\csep(H, o, o')$. Since
      $o, o'$ arbitrary we are done.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:2.11}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ \FS|_a^\iota \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ \FS'|_a^\iota \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall \HS|_b^{\iota'} \in Q.$ \\ 
      $\reachable{(\accRoots{(\HS, H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(\HS, H)}, \Graph{(H)})}$
    \item $\reachable{(\accRoots{(\FS', H')}, \Graph{(H')})} \subseteq$ \\
      $\reachable{(\accRoots{(\FS, H)}, \Graph{(H)})}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{proposition}

\begin{remark}
  Note that $\Graph{(H)} = \Graph{(H')}$ implies $\dom{(H)} = \dom{(H')}$.
  Otherwise many of the preconditions above would not make sense.
\end{remark}

\begin{proof}
  We prove that 
  \begin{equation*}
    \forall \text{ distinct } \HS|_b^{\iota'}, \GS|_c^{\iota''} \in P'.\; b = \ocap \lor c = \ocap \implies
    \isolated(H', \HS, \GS).
  \end{equation*}
  This implies $\isolation(H', P')$ by rule {\sc ISO-Procs}.
  Thus take any distinct $\HS|_b^{\iota'}, \GS|_c^{\iota''} \in P'$. Then by assumption 3, 4 and basic set
  properties
  \begin{equation} \label{eq:reachinclusion1}
    \begin{gathered}
      \reachable(\accRoots(\HS, H'), \Graph(H')) \cap \reachable(\accRoots(\GS, H'),
      \Graph(H')) \\
      \subseteq \\
      \reachable(\accRoots(\HS, H), \Graph(H)) \cap \reachable(\accRoots(\GS, H),
      \Graph(H)).
    \end{gathered}
  \end{equation}
  By this, Proposition~\ref{prop:2.6}, $\isolation(H, \HS, \GS)$ and assumption 5, we have
  $\isolation(H', \HS, \GS)$. By \eqref{eq:reachinclusion1} and assumption 3,4 and 5
  we have $H' \vdash P' \tsep \ocr$.
\end{proof}

\begin{corollary} \label{cor:2.11}
  Let $H, H'$ be heaps and $P, P'$ thread sets such that
  \begin{enumerate}
    \item $P = Q \cup_D \left\{ \FS|_a^\iota \right\}$, $\isolation{(H, P)}$, $H
      \vdash P \tsep \ocr$ and $P' = Q \cup_D \left\{ \FS'|_a^\iota \right\}$
    \item $\Graph{(H)} = \Graph{(H')}$
    \item $\forall \HS|_b^{\iota'} \in Q. \: \accRoots{(\HS, H')} \subseteq \accRoots{(\HS, H)}$
    \item $\accRoots{(\FS', H')} \subseteq \accRoots{(\FS, H)}$
    \item $\forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}$
  \end{enumerate}
  Then $\isolation{(H', P')}$ and $H' \vdash P' \tsep \ocr$.
\end{corollary}

\begin{proof}
  Assumption 2,3 and 4 implies assumption 2,3 and 4 of
  Proposition~\ref{prop:2.11}
\end{proof}

\begin{definition} \label{def:ptilde}
  Let $\FS_g$ be any frame stack where 
  \begin{equation*}
    \accRoots(\FS_g, H) = \left\{ o_g \right\}
  \end{equation*}
  Furthermore let $H; \nocap \vdash \FS_g$.
  $\FS_g$ thus is any well typed frame stack that only has the global object as
  an accessible root.  Now, for any thread set $P$, let $\tilde{P}$ be the
  thread set
  \begin{equation*}
    \tilde{P} = P \cup \left\{ \FS_g|_{\nocap}^\iota \right\}
  \end{equation*}
  for some fresh $\iota$.
\end{definition}

\begin{proposition} \label{prop:ocrtilde_eq}
  For any $H, P$ we have
  \begin{equation*}
    H \vdash P \tsep \ocr \iff H \vdash \tilde{P} \tsep \ocr
  \end{equation*}
  and
  \begin{equation*}
    H \vdash P  \iff H \vdash \tilde{P}. 
  \end{equation*}
\end{proposition}
\begin{proof}
  Follows almost immediately from Proposition~\ref{prop:2.13} and the
  definitions of OCAP reachability and $\tilde{P}$.
\end{proof}

\begin{proposition} \label{prop:2.8}
  For any heap $H$ and thread set $P$
  \begin{equation*}
    \isolation{(H, \tilde{P})} \iff \isolation{(H, P)} \text{ and } H \vdash P
    \tsep \gsep 
  \end{equation*}
\end{proposition}

\begin{proof}
  This follows almost immediately by the definitions of isolation and global
  object separation, and the fact that $\accRoots(\FS_g) = \left\{
    o_g \right\}$ 
\end{proof}

We state the following without proof.
\begin{proposition} \label{prop:tilde_trans}
  Let $H, P \Rrightarrow^{R^{\iota, \beta}} H', P'$. Then $H, \tilde{P}
  \Rrightarrow^{R^{\iota, \beta}} H', \tilde{P'}$
\end{proposition}

\begin{proposition} \label{prop:2.9}
  For any $H, H', P, P'$ such that $\vdash H, H \vdash P$, $H \vdash P \tsep
  \ocr$ and $H, P \Rrightarrow^{R^{\iota, \beta}} H', P'$, if
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \isolation(H, \tilde{P}) \implies \isolation(H', \tilde{P'})
  \end{equation*}
\end{proposition}

\begin{proof}
  By Proposition~\ref{prop:tilde_trans}, $H, \tilde{P} \Rrightarrow^{R^{\iota,
  \beta}} H', \tilde{P'}$. It is easy to see that $\vdash H$, $H \vdash
  \tilde{P}$ and $H \vdash \tilde{P} \tsep \ocr$.
  Since the assumption of the proposition refers to any $H, H', P, P'$ for which
  these three properties hold the statement also holds for $H, H',
  \tilde{P}, \tilde{P'}$.
\end{proof}

\begin{remark}
  This proposition may seem a bit circular, but what it does is allow us to get
  the global separation property for free in any case of the proof of
  Theorem~\ref{thm:preservation} where we do not rely on the global separation
  property in order to prove preservation of isolation. This ends up to be a
  substantial number of cases. We state this in the following corollary and it
  can be proven by combining Proposition~\ref{prop:2.9} with
  Proposition~\ref{prop:2.8}. 
\end{remark}

\begin{corollary} \label{cor:2.9}
  For any $H, H', P, P'$ such that $\vdash H, H \vdash P$, $H \vdash P \tsep
  \ocr$ and $H, P \Rrightarrow^{R^{\alpha, \beta}} H', P'$, if
  \begin{equation*}
      \isolation(H, P) 
      \implies 
      \isolation(H', P')
  \end{equation*}
  then
  \begin{equation*}
    \begin{gathered}
      \isolation(H, P) \text{ and } H \vdash P \tsep \gsep \\
      \implies \\
      \isolation(H', P') \text{ and } H \vdash P' \tsep \gsep
    \end{gathered}
  \end{equation*}
\end{corollary}
\begin{remark}
  In particular we can use this corollary in all cases where we can also use
  Proposition~\ref{prop:2.11} or its corollary \ref{cor:2.11}.
\end{remark}

% TODO define \Values set
\begin{proposition} \label{prop:2.12}
  Let $H, H'$ be heaps. If $\dom{(H)} = \dom{(H')}$ and
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}
  \end{equation*}
  then 
  \begin{equation*}
    \forall k \in \Values. \: \typeOf{(k, H)} = \typeOf{(k, H')}
  \end{equation*}
\end{proposition}

\begin{proof}
  It is easy to see since the only values in $\Values$ where its type depends on
  $H$ is the object references $o$.
\end{proof}

\begin{proposition} \label{prop:2.19}
  If
  \begin{equation*}
    \forall o \in \dom(H) \subseteq \dom(H'). \: \typeOf(o, H) = \typeOf(o, H')
  \end{equation*}
  and $H \vdash \Gamma; L$, then $H' \vdash \Gamma; L$.
\end{proposition}

\begin{proof}
  It is obvious from the structure of the rules {\sc WF-EnvVar} and {\sc
  WF-Env} and the assumptions of the proposition.
\end{proof}

\begin{proposition} \label{prop:2.13}
  For any $H, P$ we have 
  \begin{equation}
    H \vdash P \iff \forall \HS|_b^{\iota'} \in P.\: H;b \vdash \HS
  \end{equation}
\end{proposition}

\begin{proof} (Sketch) Done in each direction separately.
  \begin{description}
    \item[Case $\implies$:] By induction on the shape of the derivation tree.
    \item[Case $\impliedby$:] By induction on size of $P$.
  \end{description}
\end{proof}

\begin{proposition} \label{prop:2.14}
  Let $H, H'$ be heaps such that $\dom{(H)} \subseteq \dom{(H')}$ and 
  \begin{equation*}
    \forall o \in \dom{(H)}. \: \typeOf{(o, H)} = \typeOf{(o, H')}.
  \end{equation*}
  Then for any frame stack $\FS$
  \begin{equation}\label{eq:fs_impl_typing1}
    H; a \vdash \FS \implies H'; a \vdash \FS
  \end{equation}
  and
  \begin{equation} \label{eq:fs_impl_typing2}
    H; a \vdash^{x :\sigma} \FS \implies H'; a \vdash^{x: \sigma} \FS 
  \end{equation}
\end{proposition}

\begin{proof}
  We first prove \eqref{eq:fs_impl_typing2} by induction on the lenght $n$ of
  $\FS$. To prove the implication we assume that $H; a \vdash^{x: \tau} \FS$.
  
  If $n = 0$ we have $\FS = \varepsilon$. By {\sc T-FSEmpty2} we are done.
  
  If $n = i + 1$ we have $\FS = F \circ \GS$ where length of $\GS$ is $i$. By  
  $H; a \vdash^{x: \sigma} \FS$ and {\sc T-FS2} we have 
  \begin{equation*}
    F = \xframe{L, t}^{y} \andalso H \vdash \Gamma; L \andalso \TypeRel{\Gamma, x:
    \sigma}{a}{t}{\tau} \andalso H; a \vdash^{y: \tau} \GS.
  \end{equation*}
  By induction hypothesis we then have $H'; a \vdash^{y: \tau} \GS$. We get $H'
  \vdash \Gamma; L$ from Proposition \ref{prop:2.19}. Applying rule {\sc T-FS2}
  yields $H'; a \vdash^{x: \sigma} \FS$.

  Now we prove \eqref{eq:fs_impl_typing1}. Similarly assuming $H; a \vdash \FS$
  we have two cases. If $\FS = \varepsilon$ we are done by {\sc T-FSEmpty1}. If
  $\FS = F \circ \GS$ we by {\sc T-FS1} have
  \begin{equation*}
    F = \xframe{L, t}^{x} \andalso H \vdash \Gamma; L \andalso
    \TypeRel{\Gamma}{a}{t}{\tau} \andalso H; a \vdash^{x: \sigma} \GS.
  \end{equation*}
  By \eqref{eq:fs_impl_typing2}, $H'; a \vdash^{x: \sigma} \GS$. 
  Proposition~\ref{prop:2.19} then yields $H' \vdash \Gamma; L$. Applying rule {\sc
  T-FS1} gives us $H'; a \vdash \FS$.
\end{proof}

\begin{proposition} \label{prop:ocrloc_eq}
  For any $H, \HS$ we have
  \begin{equation*}
    \begin{gathered}
      \ocrloc(\HS, H) \\
      \iff  \\
      \begin{aligned}
        \forall q &\in \reachable(\accRoots(\HS, H), \Graph(H)). \\
        & \ocap(\typeOf(q, H))
      \end{aligned}
    \end{gathered}
  \end{equation*}
\end{proposition}
\begin{proof}
  Follows immediately from reachability equivalence and the definition of
  $\ocrloc$.
\end{proof}


\section{Proof of preservation}
\label{sec:proof_of_preservation}

\begin{theorem*}[Preservation]
  Let $S, S'$ be states such that $\vdash S \tsep \stateok$ and $S \Rrightarrow
  S'$. Then $\vdash S' \tsep \stateok$.
\end{theorem*}

\begin{proof} 
  First of all we have that $S \neq \Error$ since no step can be made from this
  state. Thus $S = H, P$ and
  \begin{equation*}
    \begin{gathered}
      \vdash H \andalso H \vdash P \andalso H \vdash P \tsep \ocr \\
      \isolated{(H, P)} \andalso H \vdash P \tsep \gsep \andalso \uniqMain(P).
    \end{gathered}
  \end{equation*}
  We also assume we have $S' = H', P'$ since otherwise $S' = \Error$ and the
  theorem holds trivially. What remains is to prove
  \begin{equation*}
    \begin{gathered}
      \vdash H' \andalso H' \vdash P' \andalso H' \vdash P' \tsep \ocr \\
      \isolated{(H', P')} \andalso H' \vdash P' \tsep \gsep \andalso
      \uniqMain(P).
    \end{gathered}
  \end{equation*}
  We easily see that $\uniqMain(P')$ must hold since no reduction rule changes
  the OCAP status of threads, and the only rule which spawns new threads is {\sc
  E-Spawn} which spawns an OCAP thread.

  To prove everything else we proceed by cases.
  \begin{description}
    \item[Case {\sc E-FSProp}:] The \EFSProp{} rule definition says $P =
      Q \cup_D \left\{ \FS|_a^\iota \right\}$ and $P' = Q \cup \left\{
        \FS'|_a^\iota \right\}$. We proceed by cases.
      \begin{description}
        \item[Case {\sc E-FProp}:] By \EFProp{} rule definition, $\FS = F \circ
          \GS$ and $\FS' = F' \circ \GS$. Furthermore we can assume
          that $F = \sframe{L, t}$ and $F' = \sframe{L', t'}$.
          We proceed by cases.
          \begin{description}
            \item[Case {\sc E-Null}:] By this rule we have $t =
              \Let{x}{\NullVal}{t'}$, $H = H'$ and $L' = L[x \mapsto \NullVal]$.
              Immediatelly we have $\vdash H'$ by $H = H'$.

              By {\sc T-Procs} and Proposition~\ref{prop:2.13} we have 
              \begin{equation} \label{eq:enull1}
               H \vdash Q  \andalso H; a \vdash \FS 
              \end{equation}
              Trivially $H' \vdash Q$. 
              By~\eqref{eq:enull1} and rule {\sc T-FS1} we have
              \begin{equation} \label{eq:enull2}
                \begin{gathered}
                  H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
                  \sigma' \stof \sigma \andalso H; a \vdash^{s: \sigma} \GS.
                \end{gathered}
              \end{equation}
              Let $\Gamma' = \Gamma, x: \NullType$. By {\sc T-Let}, {\sc
              T-Null} and \eqref{eq:enull2} we have
              \begin{equation} \label{eq:enull3}
                \TypeRel{\Gamma'}{a}{t'}{\sigma'}.
              \end{equation}
              Since $\typeOf(L(x), H') \stof \NullType$, by inspection of rules
              {\sc WF-EnvVar} and {\sc WF-Env} we can see that
              \begin{equation} \label{eq:enull4}
                H' \vdash \Gamma';L'
              \end{equation}
              By {\sc T-FS1}, \eqref{eq:enull2}, \eqref{eq:enull3} and \eqref{eq:enull4}
              \begin{equation}\label{eq:enull5}
                H';a \vdash \FS'
              \end{equation}
              By \eqref{eq:enull5}, {\sc T-Procs} and $H = H'$ we get  
              \begin{equation}
                H' \vdash P'
              \end{equation}
              $H' \vdash P' \tsep \ocr$ and $\isolation{(H', P')}$ follows from
              the Corollary~\ref{cor:2.11}. Then $H' \vdash P'
              \tsep \gsep$ follows from Corollary~\ref{cor:2.9} (see remarks
              for Proposition~\ref{prop:2.9} and Corollary~\ref{cor:2.9}).

            \item[Case {\sc E-LVal}:] Similarly.

            \item[Case {\sc E-Var}:] First, by rule {\sc E-Var} we have
              \begin{equation} 
                \begin{gathered}
                  F = \sframe{L, t} \andalso t = \Let{x}{y}{t'} \\ 
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(y)].
                \end{gathered}
              \end{equation}
              Also
              \begin{equation} \label{eq:evar1}
                H = H'
              \end{equation}
              so $\vdash H'$.
              By $H \vdash P$, {\sc T-FS1} and Proposition \ref{prop:2.13}
              \begin{equation} \label{eq:evar3}
                \begin{gathered}
                  H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
                  \sigma' \stof \sigma \andalso H; a \vdash^{s: \sigma} \GS
                \end{gathered}
              \end{equation}
              By {\sc T-Let, T-Var} and $\TypeRel{\Gamma}{a}{t}{\sigma'}$
              \begin{equation} \label{eq:evar4}
                \TypeRel{\Gamma, x: \gamma}{a}{t'}{\sigma'} \andalso \Gamma(y) =
                \gamma
              \end{equation}
              Let $\Gamma' = \Gamma, x: \gamma$.
              Then by \eqref{eq:evar4}
              \begin{equation} \label{eq:evar5}
                \TypeRel{\Gamma'}{a}{t'}{\sigma'}.
              \end{equation}
              By $H \vdash \Gamma; L$, \eqref{eq:evar1}, \eqref{eq:evar5}, and
              rules {\sc WF-EnvVar}, {\sc WF-Env}
              \begin{equation} \label{eq:evar8}
                \typeOf(L'(x), H') = \typeOf(L(y), H) \stof \Gamma(y) =
                \Gamma'(x).
              \end{equation}
              From definitions of $\Gamma', L'$ and $H \vdash \Gamma;L$ we also have 
              \begin{equation} \label{eq:evar9}
                \begin{aligned}
                  \forall z \in &\dom(\Gamma') \text{ s.t. } z \neq x. \\
                  & \typeOf(L'(z), H') \leq \Gamma'(z).
                \end{aligned}
              \end{equation}
              Thus by {\sc WF-EnvVar}, {\sc WF-Env}, \eqref{eq:evar8} and
              \eqref{eq:evar9} 
              \begin{equation} \label{eq:evar6}
                H' \vdash \Gamma'; L'
              \end{equation}
              By {\sc T-FS1}, \eqref{eq:evar3}, \eqref{eq:evar5} and
              \eqref{eq:evar6} we have
              \begin{equation} \label{eq:evar7}
                H'; a \vdash \FS'.
              \end{equation}
              By Proposition \ref{prop:2.13} and $H \vdash P$ we get
              \begin{equation*} 
                \forall \HS|_b^{\iota'} \in Q. \: H; b \vdash \HS.
              \end{equation*}
              By this, \eqref{eq:evar1} and Proposition \ref{prop:2.13}
              \begin{equation*}
                H' \vdash Q
              \end{equation*}
              Combining this with \eqref{eq:evar7} and {\sc T-Procs} finally
              yields
              \begin{equation*}
                H' \vdash P'
              \end{equation*}

              We now move on to OCAP reachability, isolation and global object
              separation. We note that all preconditions of
              Corollary~\ref{cor:2.11} holds. Thus we immediately have 
              \begin{equation*}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P').
              \end{equation*}
              $H' \vdash P' \tsep \gsep$ immediately follows by
              Corollary~\ref{cor:2.9}.

            \item[Case {\sc E-Select}:] By rule {\sc E-Select}
              \begin{equation} \label{eq:eselect1}
                \begin{gathered}
                  H = H' \andalso F = \sframe{L, t} \andalso t =
                  \Let{x}{\FSel{y}{f}}{t'} \\
                  L(y) = o \andalso H(o) = \Obj{C, \FM} \andalso f \in \dom(\FM)
                  \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto \FM(f)]
                \end{gathered}
              \end{equation}
              We immediately see $\vdash H'$. By $\vdash H$ we have
              \begin{equation} \label{eq:eselect2}
                \typeOf(\FM(f), H) \stof \ftype(f, C).
              \end{equation}
              $H \vdash P$ and propositions \ref{prop:2.13} and \ref{prop:2.14} yields
              $H \vdash Q$ and thus $H' \vdash Q$.
              $H \vdash P$ and Proposition \ref{prop:2.13} gives 
              \begin{equation} \label{eq:eselect3}
                H; a \vdash \FS
              \end{equation}
              which under inspection of rule {\sc T-FS1} immediately gives
              \begin{equation} \label{eq:eselect4}
                \begin{gathered}
                  H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
                  \sigma' \stof \sigma \andalso H; a \vdash^{s: \sigma} \GS.
                \end{gathered}
              \end{equation}
              $\TypeRel{\Gamma}{a}{t}{\sigma'}$ together with rule {\sc T-Let}
              gives
              \begin{equation} \label{eq:eselect5}
                \TypeRel{\Gamma}{a}{\FSel{y}{f}}{\gamma} \andalso
                \TypeRel{\Gamma, x: \gamma}{a}{t'}{\sigma'}.
              \end{equation}
              which combined with {\sc T-Select} and {\sc T-Var} gives us
              \begin{equation} \label{eq:eselect6}
                (y: C) \in \Gamma \andalso \ftype(f, C) = \gamma
              \end{equation}
              Let $\Gamma' = \Gamma, x: \gamma$. Similarly to case {\sc E-Var}
              we see that
              \begin{equation} \label{eq:eselect7}
                \forall z \in L \text{ s.t. } z \neq x . \: \typeOf(L(z), H')
                \stof \Gamma'(z).
              \end{equation}
              Furthermore, because of \eqref{eq:eselect2} and $H = H'$
              \begin{equation} \label{eq:eselect8}
                \begin{aligned}
                  \typeOf(L'(x), H') &= \typeOf(\FM(f), H') \\
                                     &\stof \ftype(f, C) \\
                                     &= \Gamma'(x)
                \end{aligned}
              \end{equation}
              Using {\sc WF-Env, WF-EnvVar}, \eqref{eq:eselect7} and
              \eqref{eq:eselect8} we have
              \begin{equation} \label{eq:eselect9}
                H' \vdash \Gamma';L'.
              \end{equation}
              Using {\sc T-FS1} with $H = H'$, \eqref{eq:eselect4}, \eqref{eq:eselect5}
              and \eqref{eq:eselect9} we finally get
              \begin{equation}
                H';a \vdash \FS'
              \end{equation}
              which with the help of {\sc T-Procs} and $H' \vdash Q$ gives us 
              \begin{equation*}
                H'\vdash P'.
              \end{equation*}
              
              Moving on to OCAP reachability, isolation and global object
              separation we can easily see that the preconditions of Proposition
              \ref{prop:2.11} holds and thus we immediately get
              \begin{equation*}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P')
              \end{equation*}
              Again using Corollary~\ref{cor:2.9} similarly to previous cases, we get
              \begin{equation*}
                H' \vdash P' \tsep \gsep.
              \end{equation*}


            \item[Case {\sc E-Assign}:] The {\sc E-Assign} rule gives us that
              \begin{equation} \label{eq:eassign1}
                \begin{gathered}
                  F = \sframe{L, t} \andalso t = \Let{x}{\FAss{y}{f}{z}}{t'} \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(z)] \\
                  L(y) = o_y \andalso H(o) = \Obj{C, \FM} \andalso f \in \dom(\FM)
                  \\
                  \FM' = \FM[f \mapsto L(z)] \andalso H' = H[o \mapsto \Obj{C, \FM'}]
                \end{gathered}
              \end{equation}
              We begin by proving $\vdash H'$. First we note
              that only change from $H$ to $H'$ is in what object $o_y$ maps to.
              Clearly from \eqref{eq:eassign1} we have
              \begin{equation} \label{eq:eassign2}
                \forall o \in \dom(H) = \dom(H'). \: \typeOf(o, H) = \typeOf(o,
                H')
              \end{equation}
              Thus by Proposition \ref{prop:2.12} 
              \begin{equation} \label{eq:eassign3}
                \forall k \in \Values. \: \typeOf(k, H) = \typeOf(k,
                H')
              \end{equation}
              \begin{addmargin}[1em]{1em}
                \begin{remark}
                  This means that immediately it is clear that the conditions
                  for $\vdash H'$ (see equations \eqref{eq:defwth1} and
                  \eqref{eq:defwth2}) holds for all $o' \in \dom(H')$ s.t. $o'
                  \neq o_y$.
                \end{remark}
              \end{addmargin}

              \vspace{2em}
              By $\vdash H$, definition of $H'$ and \eqref{eq:eassign3}
              \begin{equation} \label{eq:eassign4}
                \begin{aligned}
                  \forall f' &\in \fields(C), f' \neq f. \\ 
                                 &\typeOf(\FM'(f'), H') \stof \ftype(f, C)
                \end{aligned}
              \end{equation}
              By $H \vdash P$ and Proposition \ref{prop:2.13}
              \begin{equation} \label{eq:eassign5}
                H;a \vdash \FS.
              \end{equation}
              This and {\sc T-FS1} yields
              \begin{equation}\label{eq:eassign6}
                \begin{gathered}
                  H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
                  \sigma' \stof \sigma \andalso H; a \vdash^{s: \sigma} \GS
                \end{gathered}
              \end{equation}
              By $H;a \vdash^{s: \sigma} \GS$, \eqref{eq:eassign2} and prop.
              \ref{prop:2.14} we have 
              \begin{equation} \label{eq:eassign7} 
                H'; a \vdash^{s: \sigma} \GS
              \end{equation}
              $\TypeRel{\Gamma}{a}{t}{\sigma'}$ and {\sc T-Let} gives
              \begin{equation} \label{eq:eassign8}
                \TypeRel{\Gamma}{a}{\FAss{y}{f}{z}}{\gamma} \andalso
                \TypeRel{\Gamma, x: \gamma}{a}{t'}{\sigma'}
              \end{equation}
              which whith {\sc T-Assign} gives us
              \begin{equation} \label{eq:eassign9}
                \begin{gathered}
                  \TypeRel{\Gamma}{a}{y}{C'} \andalso \ftype(f, C') = \alpha \\
                  \TypeRel{\Gamma}{a}{z}{\alpha'} \andalso \alpha' \stof \alpha
                \end{gathered}
              \end{equation}
              By {\sc T-Var} and \TypeRel{\Gamma}{a}{y}{C'}
              \begin{equation}\label{eq:eassign10}
                (y: C') \in \Gamma 
              \end{equation}
              or equivalently $\Gamma(y) = C'$.
              Similarly
              \begin{equation} \label{eq:eassign11}
                (z: \alpha') \in \Gamma.
              \end{equation}
              By $H \vdash \Gamma; L$ we have $H \vdash \Gamma; L; z$ and thus
              \begin{equation} \label{eq:eassign12}
                \begin{aligned}
                  \typeOf(L(z), H) &= \alpha'' \\ 
                                   &\stof \alpha' \\ 
                                   &\stof \alpha \\ 
                                   &= \ftype(f, C') \\ 
                                   &= \ftype(f, C)
                \end{aligned}
              \end{equation}
              where the last equality comes from the fact that the classes are
              well formed. By \eqref{eq:eassign1} we have $\FM'(f) = L(z)$ and
              combining this with \eqref{eq:eassign12} we get
              \begin{equation} \label{eq:eassign13}
                \typeOf(\FM'(f), H) \stof \ftype(f, C).
              \end{equation}
              Combined with \eqref{eq:eassign3}, \eqref{eq:eassign4} and the
              remark above we get
              \begin{equation*} 
                \vdash H'
              \end{equation*}

              $H' \vdash P'$ follows similarly to {\sc E-Var} case.

              We now move on to OCAP reachability, isolation and global object
              separation.  Note that the only insteresting case is if $L(z)$ is
              an object refence, since otherwise the preconditions to Corollary
              \ref{cor:2.11} holds and we are done similarly to previous cases.
              Therefore we assume $L(z) \in \dom(H)$.  To help our efforts we
              state the following lemma.

              \begin{lemma} \label{lem:2.15}
                We let everything be as in case \EAssign{} above. Furthermore we
                let $L(z) \in \dom(H)$. Then
                \begin{equation} \label{eq:lem2.15a}
                  \begin{aligned}
                    &\reachable(\accRoots(\FS', H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(\FS, H), \Graph(H))
                  \end{aligned}
                \end{equation}
                If $\HS|_b^{\iota'} \in Q$
                \begin{equation}\label{eq:lem2.15b}
                  \begin{aligned}
                    &\reachable(\accRoots(\HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(\HS, H), \Graph(H)) \cup  \\
                    &\reachable(\accRoots(\FS, H), \Graph(H)).
                  \end{aligned}
                \end{equation}
                Furthermore, if $a = \ocap$ or $b = \ocap$ then
                \begin{equation}\label{eq:lem2.15c}
                  \begin{aligned}
                    &\reachable(\accRoots(\HS, H'), \Graph(H')) \subseteq \\
                    &\reachable(\accRoots(\HS, H), \Graph(H))
                  \end{aligned}
                \end{equation}
              \end{lemma}

              \begin{proof}
                Let $\Graph(H) = (V_H, E_H)$. Then clearly
                \begin{equation}
                  \begin{gathered}
                    \Graph(H') = (V_H, E_{H'}) \\
                    E_{H'} = (E_H \setminus \{(o_y, \FM(f))_f \}) \cup \{(o_y,
                    o_z)_f \}
                  \end{gathered}
                \end{equation}
                We prove each part separately.  We begin with
                \eqref{eq:lem2.15a}.  Let
                \begin{equation*}
                  q \in \reachable(\accRoots(\FS', H'), \Graph(H')).
                \end{equation*}
                Because of reachability equivalence (Proposition
                \ref{prop:reacheq}) this means there is an $o \in \accRoots(\FS',
                H')$ such that
                \begin{equation}
                  \exists \text{ path } o_0, \dots, o_n \in \Graph(H')
                  \text{ s.t. } o_0 = o, o_n = q
                \end{equation}
                Let $f_i$ be the associated field names from which the path is
                formed, i.e. $(o_i, o_{i+1})_{f_i} \in \Graph(H')$.
                By \eqref{eq:eassign1}
                \begin{equation}
                  \accRoots(\FS', H') \subseteq \accRoots(\FS, H).
                \end{equation}
                Clearly $o \in \accRoots(\FS, H)$.

                There are two cases:
                \begin{enumerate}
                  \item For some $i \in \left\{ 0, \dots, n-1 \right\}$ $o_i =
                    o_y, o_{i+1} = o_z$ and $f_i = f$, i.e. the edge $(o_y,
                    o_z)_{f}$ is part of the path.
                  \item There is no such $i$.
                \end{enumerate}
                We prove each case separately. For case 1 let $i$ be the last
                such index. Examine the path 
                \begin{equation}
                  o_{i+1}, \dots, o_n
                \end{equation}
                Clearly this path is in $\Graph(H)$ since we chose $i$ to be the
                last index that fulfills case 1.  Since $o_{i+1} = o_z$ and
                $o_z$ obviously is in $\accRoots(\FS, H)$
                \begin{equation}
                  q \in \reachable(\accRoots(\FS, H), \Graph(H)).
                \end{equation}

                For case 2 the new edge $(o_y, o_z)_f$ is not part of the path.
                Thus all edges $(o_i, o_{i+1})_{f_i}$ are in $\Graph(H)$ and and
                thus the path $o_0, \dots, o_n$ is a path in $\Graph(H)$ aswell.
                This means $q \in \reachable(\accRoots(\FS, H), \Graph(H))$ which
                concludes the proof of the first part of the lemma.

                To prove \eqref{eq:lem2.15b} take any
                \begin{equation}
                  q \in \reachable(\accRoots(\HS, H'), \Graph(H')).
                \end{equation}
                Similarly to before there is an $o \in \accRoots(\HS,H')$ such
                that
                \begin{equation}
                  \exists \text{ path } o_0, \dots, o_n \in \Graph(H')
                  \text{ s.t. } o_0 = o, o_n = q
                \end{equation}
                We let $f_i$ be the corresponding field names as before.
                We have exactly the same cases. For case 1 we let $i$ be the last
                such index. Then similarly to before we get that $o_{i+1} \in
                \accRoots(\FS, H)$ and $q \in \reachable(\accRoots(\FS, H),
                \Graph(H))$.
                
                Case 2 is analogous and reaches the conclusion that $q \in
                \reachable(\accRoots(\HS, H), \Graph(H))$.

                Lastly we prove that if $a = \ocap$ or $b = \ocap$ then
                \eqref{eq:lem2.15c} holds. To prove this implication we assume
                that either $a = \ocap$ or $b = \ocap$. As before we take any
                \begin{equation}
                  q \in \reachable(\accRoots(\HS, H'), \Graph(H')).
                \end{equation}
                Similarly we get that there there must be an $o \in
                \accRoots(\HS, H')$ such that
                \begin{equation}
                  \exists \text{ path } o_0, \dots, o_n \in \Graph(H') \text{ s.t. } o_0 = o,
                  o_n = q
                \end{equation}
                with related field names $f_i$ as before. We get the exact same
                cases as above. For case 1 we instead let $i$ be the first index with
                the properties described. As noted this means we have the edge
                $(o_y, o_z)_f$ as part of our path. Specifically this means
                \begin{equation}\label{eq:lemma2.15-p3-1}
                  o_y \in \reachable(\accRoots(\HS, H), \Graph(H))
                \end{equation}
                since $o_0, \dots, o_i$ is a path in $\Graph(H)$ from $o$ to
                $o_y$, due to the way $i$ was chosen.  Moreover
                \begin{equation}\label{eq:lemma2.15-p3-2}
                  o_y \in \reachable(\accRoots(\FS, H), \Graph(H))
                \end{equation}
                since $(y \mapsto o_y) \in L$. From \eqref{eq:eassign1} it is clear that
                \begin{equation}\label{eq:lemma2.15-p3-3}
                  \typeOf(o_y, H) \not\stof \CellType.
                \end{equation}
                Now \eqref{eq:lemma2.15-p3-1}, \eqref{eq:lemma2.15-p3-2} and
                \eqref{eq:lemma2.15-p3-3} contradicts $\isolation(H, P)$ since $b =
                \ocap$. Since case 1 leads to a contradiction, it is impossible.
                
                For case 2 it is clear that $o_0, \dots, o_n$ is also a
                path from $o$ to $q$ in $\Graph(H)$ which immediately implies 
                \begin{equation}
                  q \in \reachable(\accRoots(\HS, H), \Graph(H)).
                \end{equation}
              \end{proof}

              Continuing with the proof of case {\sc E-Assign} first off we use
              the lemma to prove OCAP reachability.  We first take any thread
              $\HS|_b^{\iota'} \in Q$. Studying the $\ocr$ rules it is clear that we can
              prove that $H'; b \vdash \HS \tsep \ocr$ holds trivially for any
              thread $\HS|_b^{\iota'}$ for which $b = \nocap$. Therefore we from now on
              assume that $b = \ocap$.  By $H \vdash P \tsep \ocr$, $H; b \vdash
              \FS \tsep \ocr$. By Proposition~\ref{prop:ocrloc_eq} and $b =
              \ocap$,
              \begin{equation}\label{eq:eassign14}
                \begin{aligned}
                  \forall o &\in \reachable(\accRoots(\HS, H), H). \\
                            &\ocap(\typeOf(o, H)).
                \end{aligned}
              \end{equation}
              Lemma~\ref{lem:2.15} (equation \eqref{eq:lem2.15c}) and equations
              \eqref{eq:eassign2} and \eqref{eq:eassign14} means 
              \begin{equation}
                \begin{aligned}
                  \forall o &\in \reachable(\accRoots(\HS, H'), \Graph(H')). \\
                            &\ocap(\typeOf(o, H')).
                \end{aligned}
              \end{equation}
              But this is equivalent to $H';b \vdash \HS \tsep \ocr$ by
              Proposition~\ref{prop:ocrloc_eq}. 

              In order to prove $H' \vdash P' \tsep \ocr$ the only thing that
              remains is to show $H';a \vdash \FS' \tsep \ocr$. This is anologous
              to the above reasoning about $H';b \vdash \HS~\ocr$ using
              \eqref{eq:lem2.15a} instead. Thus we have
              \begin{equation*}
                H' \vdash P' \tsep \ocr.
              \end{equation*}

              $\isolation(H', P')$ follows immediately from $\isolation(H, P)$,
              Proposition~\ref{prop:2.6}, Lemma~\ref{lem:2.15}, equation
              \eqref{eq:eassign2} and applying rule {\sc ISO-Procs}. We also
              note that nowhere have we relied on the fact that
              $H~\vdash~P~\tsep~\gsep$ so using Corollary~\ref{cor:2.9} we also
              have $H'~\vdash~P'~\tsep~\gsep$.

            % TODO add definition of \default, maybe \fdecls also
            \item[Case {\sc E-New}:] According to rule {\sc E-New}
              \begin{equation} \label{eq:enew1}
                \begin{gathered} 
                  F = \sframe{L, t} \andalso t = \Let{x}{\New{C}}{t'} \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto o_x] \\
                  o_x \text{ fresh object reference } \\
                  \FM = [f \mapsto \default(\sigma) \mid (\VarDecl{f}{\sigma}) \in
                  \fdecls(C)] \\
                  H' = H[o_x \mapsto \Obj{C, \FM}]
                \end{gathered}
              \end{equation}
              If we let $\Graph(H) = (V_H, E_H)$ it is easy to see that
              \begin{equation}
                \Graph(H') = ( V_H \cup \left\{ o_x \right\}, E_H )
              \end{equation}
              By definition of $\default$
              \begin{equation} \label{eq:enew-h1}
                \begin{aligned}
                  \forall f &\in \fields(C).\\
                  &f \in \dom(\FM) \land \typeOf(\FM(f), H') \stof \ftype(f, C).
                \end{aligned}
              \end{equation}
              Also
              \begin{equation}
                \forall o \in \dom(H). \: H(o) = H'(o) \label{eq:enew-h2},
              \end{equation}
              and thus
              \begin{equation}
                \forall o \in \dom(H). \: \typeOf(o, H) = \typeOf(o, H').
                \label{eq:enew-h3}
              \end{equation}
              Using the definition of a well typed heap together with
              \eqref{eq:enew-h1}, \eqref{eq:enew-h2} and \eqref{eq:enew-h3} we
              can easily show that $\vdash H'$.

              By Proposition~\ref{prop:2.13}
              \begin{equation} 
                H \vdash Q \andalso H; a \vdash \FS.
              \end{equation}
              Propositions \ref{prop:2.13} and \ref{prop:2.14} implies
              \begin{equation} \label{eq:enew-typing1}
                H' \vdash Q.
              \end{equation}
              $H;a \vdash \FS$ and {\sc T-FS1} yields
              \begin{equation}
                \begin{gathered}
                  H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'}
                  \\
                  \sigma' \stof \sigma \andalso H;a \vdash^{s: \sigma} \GS.
                \end{gathered} 
              \end{equation}
              Applying {\sc T-Let} and {\sc T-New} we get
              \begin{equation} \label{eq:enew-typing5}
                \TypeRel{\Gamma, x: C}{a}{t'}{\sigma'} \andalso a = \ocap
                \implies \ocap(C).
              \end{equation}
              Letting $\Gamma' = \Gamma, x: C$ we have
              \begin{equation} \label{eq:enew-typing2}
                \TypeRel{\Gamma'}{a}{t'}{\sigma'}.
              \end{equation}
              We have that $H' \vdash \Gamma';L';x$ since $\typeOf(L'(x), H')
              \stof \Gamma'(x)$. Thus we have
              \begin{equation} \label{eq:enew-typing3}
                H' \vdash \Gamma'; L'.
              \end{equation}
              By Proposition \ref{prop:2.14}
              \begin{equation} \label{eq:enew-typing4}
                H';a \vdash^{s: \sigma} \GS.
              \end{equation}
              Using {\sc T-FS1} together with $\sigma' \stof \sigma$, \eqref{eq:enew-typing2},
              \eqref{eq:enew-typing3} and \eqref{eq:enew-typing4} we get
              \begin{equation}
                H';a \vdash \FS',
              \end{equation}
              and combined with \eqref{eq:enew-typing1} and {\sc T-Procs} we finally
              get
              \begin{equation}
                H' \vdash P'.
              \end{equation}

              Moving on to OCAP reachability. For any $\HS|_b^{\iota'} \in Q$,
              we see that
              \begin{equation} \label{eq:enew-ocr1}
                \begin{aligned}
                  &\reachable(\accRoots(\HS, H'), \Graph(H')) = \\
                  &\reachable(\accRoots(\HS, H), \Graph(H)) 
                \end{aligned}
              \end{equation}
              and furthermore that
              \begin{equation} \label{eq:enew-ocr2}
                \begin{aligned}
                  &\reachable(\accRoots(\FS', H'), \Graph(H')) = \\
                  &\reachable(\accRoots(\FS, H), \Graph(H)) \cup \left\{ o_x
                  \right\}.
                \end{aligned}
              \end{equation}
              Clearly $\typeOf(o_x, H') = C$. Combining this with
              \eqref{eq:enew-h3}, \eqref{eq:enew-typing5}, \eqref{eq:enew-ocr1},
              \eqref{eq:enew-ocr2}, {\sc OCR-P}, $H \vdash P \tsep \ocr$ and
              Proposition~\ref{prop:ocrloc_eq} we see that
              \begin{equation}
                H' \vdash P' \tsep \ocr.
              \end{equation}

              Similarly it is easy to show $\isolation(H', P')$ using equations
              \eqref{eq:enew-h3}, \eqref{eq:enew-ocr1} and \eqref{eq:enew-ocr2}
              together with Proposition~\ref{prop:2.6} and {\sc ISO-Procs}.
              Since the isolation proof never relies on $H \vdash P \tsep \gsep$
              we can apply Corollary~\ref{cor:2.9}.
              \begin{equation}
                \isolation(H', P') \andalso H' \vdash P' \tsep \gsep
              \end{equation}

            \item[Case {\sc E-NewCell}:] We have
              \begin{equation}
                H' = H[o \mapsto \Cell{\DEP, \bot_{\LatVals}}] \andalso \DEP = \emptyset
              \end{equation}
              for some fresh object reference $o$. 
              Since $\DEP$ is empty \eqref{eq:defwth2} holds vacuously and since
              all other heap elements are the same as in $H$ we have
              \begin{equation}
                \vdash H'.
              \end{equation}
              Proving the rest is similar to case {\sc E-New}.

            \item[Case {\sc E-Put}:] According to rule {\sc E-Put}
              \begin{equation}
                \begin{gathered}
                  F = \sframe{L, t} \andalso t = \Let{x}{\Put{y}{z}}{t'} \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(y)] \\
                  L(y) = o_y \andalso H(o_y) = \Cell{\DEP, l} \\
                  L(z) = l' \andalso H' = H[o_y \mapsto \Cell{\DEP, l \sqcup
                  l'}].
                \end{gathered}
              \end{equation}
              Since the only change to the heap is $l$ being updated to $l
              \sqcup l'$, by inspecting the definition for a well typed heap and
              using $\vdash H$ it is easy to conclude that
              \begin{equation}
                \vdash H'.
              \end{equation}
              The proof of $H' \vdash P'$ follows similar to case {\sc E-Var}.
              The preconditions of Corollary~\ref{cor:2.11} clearly hold. Thus 
              \begin{equation}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P').
              \end{equation}
              We apply Corollary~\ref{cor:2.9} to get
              \begin{equation}
                H' \vdash P' \tsep \gsep
              \end{equation}

            \item[Case {\sc E-When}:] From rule {\sc E-When} we know
              \begin{equation}
                \begin{gathered}
                  F = \sframe{L, t} \\ 
                  t = \Let{x}{\When{y}{z}{\CB{\overline{cap}}{w}{t''}}}{t'} \\
                  F' = \sframe{L', t'} \andalso L' = L[x \mapsto L(y)] \\
                  L(y) = o_y \andalso H(o_y) = \Cell{\DEP, l} \andalso L(z) = l' \\
                  L_{\text{env}} = [u \mapsto L(u') \mid (\Capt{u}{u'}) \in
                  \overline{cap}] \andalso cb = (L_{\text{env}}, w \Rightarrow
                  t'') \\
                  \iota \text{ fresh thread id} \andalso \DEP' = \DEP \cup (l',
                  cb)^\iota
                  \\
                  H' = H[o_y \mapsto \Cell{\DEP', l}].
                \end{gathered}
              \end{equation}
              We note that $\dom(H) = \dom(H')$ and that
              \begin{equation} \label{eq:ewhen-h5}
                \begin{aligned}
                  \forall o &\in \dom(H).  \\
                    &\typeOf(o, H) = \typeOf(o, H'),
                \end{aligned}
              \end{equation}
              and thus
              \begin{equation}
                \begin{aligned}
                  \forall k \in \Values . \\
                    &\typeOf(k, H) = \typeOf(k, H').
                \end{aligned}
              \end{equation}
              Combining this with the fact that the only object on heap changed
              is $H(o_y)$ we have shown $\vdash H'$ if we can show that
              \begin{equation}
                \begin{aligned}
                  \forall (l^{\text{cb}}&, (L^{\text{cb}}_{\text{env}},
                  z^{\text{cb}} \Rightarrow t^{\text{cb}}))^{\iota^{\text{cb}}} \in
                  \DEP'. \\
                  &\forall (x \mapsto k) \in L^{\text{cb}}_{\text{env}}.\: \typeOf{(k, H')} \stof
                  \CellType \: \land \\
                  &\TypeRel{\Gamma_{\CellType{}}(L^{\text{cb}}_{\text{env}}), z^{\text{cb}}:
                  \LatType}{\ocap}{t^{\text{cb}}}{\gamma} .
                \end{aligned}
              \end{equation}
              It is simple to see that, because of $\vdash H$ and that the only
              difference between $\DEP$ and $\DEP'$ is the addition of $(l',
              (L_{\text{env}}, w \Rightarrow t''))$, we have proved $\vdash H'$
              if we can prove
              \begin{equation} \label{eq:ewhen-h1}
                \forall (x \mapsto k) \in L_{\text{env}}.\: \typeOf{(k, H')} \stof
                \CellType
              \end{equation}
              and
              \begin{equation} \label{eq:ewhen-h2}
                \TypeRel{\Gamma_{\CellType{}}(L_{\text{env}}), w:
                \LatType}{\ocap}{t''}{\gamma}.
              \end{equation}
              Similarly to earlier cases, using $H \vdash P$ together with
              typing rules such as {\sc T-Let} and {\sc T-When} we can easily
              get
              \begin{equation}\label{eq:ewhen-h3}
                H \vdash \Gamma; L \andalso \forall (\Capt{u}{u'}) \in
                \overline{cap}. \: \TypeRel{\Gamma}{a}{u'}{\CellType} 
              \end{equation}
              and
              \begin{equation} \label{eq:ewhen-h4}
                \begin{gathered}
                  \Gamma_{\text{cells}} = [u \mapsto \CellType \mid (\Capt{u}{u'}) \in
                  \overline{cap}] \\
                  \TypeRel{\Gamma_{\text{cells}}, w:
                  \LatType}{\ocap}{t''}{\gamma'}.
                \end{gathered}
              \end{equation}
              \eqref{eq:ewhen-h4} is just a different formulation of
              \eqref{eq:ewhen-h2} since the actual value of $\gamma$ does not
              matter. Moreover, using equations \eqref{eq:ewhen-h5} and
              \eqref{eq:ewhen-h3} it is simple to prove \eqref{eq:ewhen-h1} with
              the help of rules {\sc WF-EnvVar}, {\sc WF-Env} and {\sc T-Var}.
              Thus we are done and have
              \begin{equation}
                \vdash H'.
              \end{equation}

              Proof of $H' \vdash P'$ is similar to case {\sc E-Var} and
              similarly to other cases we can apply corollaries \ref{cor:2.11}
              and \ref{cor:2.9} to get
              \begin{equation}
                H' \vdash P' \tsep \ocr \andalso \isolation(H', P') \andalso H'
                \vdash P' \tsep \gsep.
              \end{equation}

              {\bf This concludes the case} {\sc E-FProp}.
          \end{description}

        \item[Case {\sc E-Call}:] From rule {\sc E-Call}
          \begin{equation} \label{eq:ecall1}
            \begin{gathered}
              \FS = \sframe{L, t} \circ \GS \andalso t = \Let{x}{\Call{y}{m}{z}}{t''}\\
              \FS' = \xframe{L', t'}^x \circ \sframe{L, t} \circ \GS \\
              L(y) = o_y \andalso H(o_y) = \Obj{C, \FM} \\
              \mbody(m, C) = u \to t' \\
              L_{\text{base}} =
              \begin{cases}
                \emptyset & \text{ if } a = \ocap \\
                L_0       & \text{ if } a = \nocap
              \end{cases} \\
              L' = L_{\text{base}}[\This \mapsto L(y), u \mapsto L(z)] \\
              H = H'.
            \end{gathered}
          \end{equation}
          Since $H = H'$ 
          \begin{equation*}
            \vdash H'.
          \end{equation*}
          By $H = H'$, $H \vdash P$ and propositions~\ref{prop:2.13},
          and \ref{prop:2.14},  we have
          \begin{equation}
            \begin{gathered}
              H' \vdash Q \andalso H;a \vdash \FS.
            \end{gathered}
          \end{equation}
          Using the second of these and rule {\sc T-FS1} we have
          \begin{equation} \label{eq:ecall-hp0}
            \begin{gathered}
              H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
              \sigma' \stof \sigma \andalso H; a \vdash^{s:\sigma} \GS.
            \end{gathered}
          \end{equation}
          Since $H = H'$
          \begin{equation} \label{eq:ecall-hp5}
            H' \vdash \Gamma;L \andalso H'; a \vdash^{s: \sigma} \GS.
          \end{equation}
          Using $\TypeRel{\Gamma}{a}{t}{\sigma}$ with rules {\sc T-Let, T-Call} and
          {\sc T-Var} we have that
          \begin{equation} \label{eq:ecall-hp1}
            \begin{gathered}
              \TypeRel{\Gamma}{a}{\Call{y}{m}{z}}{\tau} \andalso \TypeRel{\Gamma,
              x: \tau}{a}{t''}{\sigma'} \\
              \Gamma(y) = C' \andalso \mtype(m, C') = \gamma \mapsto \tau \\
              \Gamma(z) = \gamma' \andalso \gamma' \leq \gamma.
            \end{gathered}
          \end{equation}
          Using {\sc T-FS2} with \eqref{eq:ecall-hp0}, \eqref{eq:ecall-hp5} and
          \eqref{eq:ecall-hp1} we get 
          \begin{equation} \label{eq:ecall-hp6}
            H';a \vdash^{x: \tau} \FS.
          \end{equation}
          By $H' \vdash \Gamma;L$ we have
          \begin{equation} \label{eq:ecall-hp2}
            \typeOf(L'(u), H') = \typeOf(L(z), H') \stof \gamma' \stof \gamma,
          \end{equation}
          and similarly
          \begin{equation} \label{eq:ecall-hp3}
            \typeOf(L'(\This), H') = \typeOf(L(y), H') \stof C \stof C'.
          \end{equation}

          Now, $a$ can be either $\nocap$ or $\ocap$. We first assume that $a =
          \nocap$.
          By our program and thus by extension our classes being well formed, together
          with $C \stof C'$, we must have a class $C''$ s.t. $C \stof C'' \stof
          C'$ such that the the class definition of $C''$ includes the method
          definition
          \begin{equation*}
            \MethodDef{m}{u}{\gamma}{\tau}{t'}.
          \end{equation*}
          By $C''$ being well formed
          \begin{equation}
            C'' \vdash \MethodDef{m}{u}{\gamma}{\tau}{t'}.
          \end{equation}
          By {\sc WF-Method} this means that
          \begin{equation} \label{eq:ecall-hp4}
            \TypeRel{\Gamma_0,\This: C'', u: \gamma}{\nocap}{t'}{\tau'}
            \andalso \tau' \stof \tau.
          \end{equation}
          We let
          \begin{equation}
            \Gamma_{\nocap}' = \Gamma_0, \This: C'', u: \gamma.
          \end{equation}
          It is not hard to prove that 
          \begin{equation} \label{eq:ecall-hp7}
            H' \vdash \Gamma_{\nocap}'; L'.
          \end{equation}
          By \eqref{eq:ecall-hp4} we clearly have
          \begin{equation} \label{eq:ecall-hp8}
            \TypeRel{\Gamma_{\nocap}'}{a}{t'}{\tau'} \andalso \tau' \stof \tau.
          \end{equation}
          Using  \eqref{eq:ecall-hp6}, \eqref{eq:ecall-hp7},
          \eqref{eq:ecall-hp8} and rule {\sc T-FS1} we have
          \begin{equation}
            H';a \vdash \FS'.
          \end{equation}
          Combining this with $H' \vdash Q$ and {\sc T-Procs} we get
          \begin{equation}
            H' \vdash P'.
          \end{equation}

          Now assume that $a = \ocap$. By $H \vdash P \tsep \ocr$ we have
          \begin{equation}
            \ocrloc(\FS, H)
          \end{equation}
          and thus by Proposition~\ref{prop:ocrloc_eq}
          \begin{equation}
            \begin{aligned}
              \forall q &\in \reachable(\accRoots(\FS, H), \Graph(H)) \\
              & \ocap(\typeOf(q, H)).
            \end{aligned}
          \end{equation}
          
          Of course this means that $\ocap(\typeOf(L(y), H))$ or equivalently
          $\ocap(C)$. Proceeding similarly to the case $a = \nocap$ we
          additionally have $\ocap(C'')$ due to rule {\sc OCAP-Class}, which
          demands that parent classes to $C$ should be ocap aswell. Again using
          {\sc OCAP-Class}, we get that 
          \begin{equation}
            C'' \vdash_{\ocap} \MethodDef{m}{u}{\gamma}{\tau}{t'}.
          \end{equation}
          By {\sc OCAP-Method} we get that 
          \begin{equation} \label{eq:ecall-hp9}
            \TypeRel{\This: C'', u: \gamma}{\nocap}{t'}{\tau'}
            \andalso \tau' \stof \tau.
          \end{equation}
          The rest is similar to the case where $a = \nocap$,
          replacing $\Gamma_{\nocap}'$ with 
          \begin{equation}
            \Gamma'_{\ocap} = \This: C'', u: \gamma.
          \end{equation}

          We now prove isolation, OCAP reachability and global object
          separation. Instead of working with $P$ directly we instead use
          $\tilde{P}$. It is clear from Propositions~\ref{prop:2.8} and
          \ref{prop:ocrtilde_eq} that in order to show 
          \begin{equation}
            H' \vdash P' \tsep \ocr \andalso \isolation(H', P') \andalso H'
            \vdash P' \tsep \gsep
          \end{equation}
          we can instead show
          \begin{equation}
            H' \vdash \tilde{P'} \tsep \ocr \andalso \isolation(H', \tilde{P'}).
          \end{equation}

          To show this we start by using propositions~\ref{prop:2.8} and
          \ref{prop:ocrtilde_eq} to get
          \begin{equation}
            H \vdash \tilde{P} \tsep \ocr \andalso \isolation(H, \tilde{P}).
          \end{equation}
          We also note that 
          \begin{equation}
            \tilde{P} = \tilde{Q} \cup_D \left\{ \FS|_a^\iota \right\} \text{ and }
            \tilde{P'} = \tilde{Q} \cup_D \left\{ \FS'|_a^\iota \right\}.
          \end{equation}

          We first assume that $a = \ocap$. It is easy to see that
          \begin{equation}
            \accRoots(\FS', H') \subseteq \accRoots(\FS, H)
          \end{equation}
          and that
          \begin{equation}
            \begin{aligned}
              \forall \HS|_b^{\iota'} &\in \tilde{Q}. \\
              &\accRoots(\HS, H') = \accRoots(\HS, H).
            \end{aligned}
          \end{equation}
          Clearly then, the preconditions to Corollary~\ref{cor:2.11} holds and
          we have $\isolation(H', \tilde{P'})$ and $H' \vdash \tilde{P'} \tsep
          \ocr$. Thus we are done.

          Now instead assume $a = \nocap$. Since $\isolation(H, \tilde{P})$ we have
          $\isolated(H, \HS_1, \HS_2)$ for any two distinct $\HS_1|_b^{\iota'},
          \HS_2|_c^{\iota''}
          \in \tilde{Q}$ such that $b = \ocap$ or $c = \ocap$. Therefore, since $H = H'$
          \begin{equation}
            \begin{aligned}
              \forall &\text{ distinct } \HS_1|_b^{\iota'}, \HS_2|_c^{\iota''} \in \tilde{Q}. \\ 
              & b = \ocap \lor c = \ocap \implies \isolated(H', \HS_1, \HS_2).
            \end{aligned}
          \end{equation}
          Thus all we need for $\isolation(H', \tilde{P'})$ is to show that
          \begin{equation}
            \begin{aligned}
              \forall \HS|_b^{\iota'} &\in \tilde{Q} . \\
              &b = \ocap \implies \isolated(H', \FS', \HS)
            \end{aligned}
          \end{equation}
          since $a = \nocap$. To prove this implication we take any
          $\HS|_b^{\iota'} \in
          \tilde{Q}$ such that $b = \ocap$. Note that this implies $\HS \neq
          \FS_g$. Because of $a = \nocap$ and the definition of $L'$ in
          \eqref{eq:ecall1}
          \begin{equation} \label{eq:ecall-iso1}
            \accRoots(\FS', H') = \accRoots(\FS, H) \cup \left\{ o_g \right\}.
          \end{equation}
          By $\isolation(H, \tilde{P})$  and $b = \ocap$,
          \begin{equation} \label{eq:ecall-iso2}
            \isolated(H, \HS, \FS_g)
          \end{equation}
          and
          \begin{equation} \label{eq:ecall-iso4}
            \isolated(H, \FS, \HS).
          \end{equation}
          By definition
          \begin{equation} \label{eq:ecall-iso3}
            \accRoots(\FS_g, H) = \left\{o_g \right\}.
          \end{equation}
          By inspecting \eqref{eq:ecall-iso1}, \eqref{eq:ecall-iso2},
          \eqref{eq:ecall-iso3} and \eqref{eq:ecall-iso4} and considering
          Proposition~\ref{prop:2.6} it is fairly easy to show
          \begin{equation}
            \isolated(H, \FS', \HS).
          \end{equation}
          Specifically, to show this, assume for a contradiction that we do not
          have $\isolated(H, \FS', \HS)$. This would entail that
          \begin{equation}
            \begin{aligned}
              \exists q &\in \dom(H), o \in \accRoots(\HS, H), o' \in
              \accRoots(\FS', H) . \\
              &\typeOf(q, H) \not\stof \CellType \land \reach(H, o, q) \land
              \reach(H, o', q).
            \end{aligned}
          \end{equation}
          If $o' = o_g$ this immediately contradicts $\isolated(H, \HS, \FS_g)$ by
          Proposition~\ref{prop:2.6}. If we instead have $o' \neq o_g$ then by
          \eqref{eq:ecall-iso1} we must have
          \begin{equation}
            o' \in \accRoots(\FS, H).
          \end{equation}
          Similarly this would contradict \eqref{eq:ecall-iso4}.  Since
          $\HS|_b^{\iota'}$ was arbitrary and $H = H'$ we have 
          \begin{equation}
            \isolation(H', \tilde{P'}).
          \end{equation}

          By $H \vdash \tilde{P} \tsep \ocr$, $H = H'$ and
          Proposition~\ref{prop:ocrtilde_eq} we get
          \begin{equation} \label{eq:ecall-ocr1}
            H \vdash \tilde{Q} \tsep \ocr.
          \end{equation}
          Since $a = \nocap$ we have that 
          \begin{equation} \label{eq:ecall-ocr2}
            H'; a \vdash \FS' \tsep \ocr 
          \end{equation} 
          follows vacuously. Using rule {\sc OCR-P} together with
          \eqref{eq:ecall-ocr1} and \eqref{eq:ecall-ocr2} we get
          \begin{equation}
            H' \vdash \tilde{P'} \tsep \ocr.
          \end{equation}  
          Thus we are done with case $a = \nocap$.
          
        \item[Case {\sc E-Ret}:] Clearly from rule {\sc E-Ret} we have
          \begin{equation}
            \begin{gathered}
              \FS = \xframe{L, z}^x \circ \sframe{L', t'} \circ \GS \\
              \FS' = \sframe{L'', t'} \circ \GS \\
              L'' = L'[x \mapsto L(z)] \\
              H = H'.
            \end{gathered}
          \end{equation}
          By $H \vdash P$ and Proposition~\ref{prop:2.13} we have
          \begin{equation} \label{eq:eret-hp0}
            H \vdash Q \andalso H; a \vdash \FS.
          \end{equation}
          $H = H'$ immediately yields
          \begin{equation}
            H' \vdash Q.
          \end{equation}
          $H; a \vdash \FS$ together with rule {\sc T-FS1} gives us that
          \begin{equation}
            \begin{gathered}
              H \vdash \Gamma; L \andalso \TypeRel{\Gamma}{a}{z}{\tau'} \\
              \tau' \stof \tau \andalso H; a \vdash^{x: \tau} \sframe{L', t'} \circ \GS,
            \end{gathered}
          \end{equation}
          the last of which together with {\sc T-FS2} gives us
          \begin{equation} \label{eq:eret-hp1}
            \begin{gathered}
              H \vdash \Gamma'; L' \andalso \TypeRel{\Gamma', x:
              \tau}{a}{t'}{\sigma'} \\
              \sigma' \stof \sigma \andalso H; a \vdash^{s: \sigma} \GS
            \end{gathered}
          \end{equation}
          We let $\Gamma'' = \Gamma', x : \tau$. By $H = H'$, $H \vdash \Gamma;
          L$ and $\tau' \stof \tau$, it is obvious that
          \begin{equation} \label{eq:eret-hp3}
            \typeOf(L''(x), H') = \typeOf(L(z), H') \stof \tau.
          \end{equation}
          Using $H \vdash \Gamma'; L'$, \eqref{eq:eret-hp3} and rules {\sc WF-EnvVar}, {\sc
          WF-Env} we get
          \begin{equation} \label{eq:eret-hp4}
            H' \vdash \Gamma'', L''.
          \end{equation}
          By definition of $\Gamma''$, \eqref{eq:eret-hp1}, \eqref{eq:eret-hp4}
          and rule {\sc T-FS1} we have that
          \begin{equation} \label{eq:eret-hp2}
            H';a \vdash \FS'
          \end{equation}
          Applying {\sc T-Procs} together with \eqref{eq:eret-hp0} and
          \eqref{eq:eret-hp2} we finally get
          \begin{equation}
            H' \vdash P'
          \end{equation}

          Similarly to many previous cases we can apply corollarys
          \ref{cor:2.11} and \ref{cor:2.9} to get
          \begin{equation*}
            H' \vdash P' \tsep \ocr \andalso \isolation(H', P') \andalso H'
            \vdash P' \tsep \gsep
          \end{equation*}
      \end{description}
      {\bf This concludes the {\sc E-FSProp} case.}
      
    \item[Case {\sc E-Spawn}:] By rule {\sc E-Spawn} we have
      \begin{equation}
        \begin{gathered} \label{eq:espawn1}
          o \in \dom(H) \andalso H(o) = \Cell{\DEP, l} \\
          l' \sqsubseteq l \andalso (l', cb)^\iota \in \DEP \andalso cb =
          (L_{\text{env}}, z \Rightarrow t') \\
          L' = L_{\text{env}}[z \mapsto l'] \\
          H' = H[o \mapsto \Cell{\DEP - (l', cb)^\iota, l}] \\
          P' = P \cup \left\{ \FS'|_{\ocap}^\iota \right\} \\
          \FS' = \xframe{L', t'}^- \circ \varepsilon.
        \end{gathered}
      \end{equation}
      
      By definition of $H'$, $\vdash H$ and equation \eqref{eq:defwth2} from the
      definition of the well typed heap it should be fairly obvious that
      \begin{equation}
        \vdash H'
      \end{equation}
      since the only heap change is a removal of an element from $\DEP$. 


      We note that
      \begin{equation} \label{eq:espawn-hp0}
        \begin{aligned}
          \forall o &\in \dom(H) = \dom(H'). \\
            &\typeOf(o, H) = \typeOf(o, H').
        \end{aligned}
      \end{equation}
      By propositions \ref{prop:2.13} and \ref{prop:2.14} we have
      \begin{equation} \label{eq:espawn-hp4}
        H' \vdash P
      \end{equation}
      From $\vdash H$ we can see that
      \begin{equation} \label{eq:espawn-hp1}
        \begin{aligned}
          \forall (x \mapsto k) &\in L_{\text{env}}. \\
            &\typeOf(k, H) \stof \CellType
        \end{aligned}
      \end{equation}
      and
      \begin{equation} \label{eq:espawn-hp2}
        \TypeRel{\Gamma_{\CellType}(L_{\text{env}}), z:
        \LatType}{\ocap}{t'}{\gamma}.
      \end{equation}
      Letting
      \begin{equation}
        \Gamma' = \Gamma_{\CellType}(L_{\text{env}}), z: \LatType
      \end{equation}
      we can use \eqref{eq:espawn-hp0},\eqref{eq:espawn-hp1} and rules {\sc
      WF-EnvVar, WF-Env} to get
      \begin{equation} \label{eq:espawn-hp3}
        H' \vdash \Gamma', L'
      \end{equation}
      By rules {\sc T-FSEmpty2, T-FS1} and \eqref{eq:espawn-hp2},
      \eqref{eq:espawn-hp3} we get
      \begin{equation}
        H'; \ocap \vdash \FS'
      \end{equation}
      which combined with \eqref{eq:espawn-hp4} and {\sc T-Procs} yields
      \begin{equation}
        H' \vdash P'.
      \end{equation}
      
      Next we prove OCAP reachability. It is easy to see that
      \begin{equation} \label{eq:espawn-ocr0}
        \Graph(H') = \Graph(H).
      \end{equation}
      Because of this, $H \vdash P \tsep \ocr$, \eqref{eq:espawn-hp0} and
      Proposition~\ref{prop:ocrloc_eq},
      \begin{equation}
        H' \vdash P \tsep \ocr.
      \end{equation}
      This leaves only to prove
      \begin{equation}
        H'; \ocap \vdash \FS' \tsep \ocr.
      \end{equation}
      in order to get $H' \vdash P' \tsep \ocr$.
      Inspecting {\sc OCR-FS} we note that we are done if we can prove
      \begin{equation} \label{eq:espawn-ocr1}
        \ocrloc(\FS', H').
      \end{equation}
      But this is easy. By definition of $\FS'$
      \begin{equation}
        \forall o \in \accRoots(\FS', H'). \: \typeOf(o, H') \stof \CellType
      \end{equation}
      which implies
      \begin{equation} \label{eq:espawn-ocr2}
        \begin{aligned}
          \forall o &\in \reachable(\accRoots(\FS', H'), \Graph(H')). \\
            &\typeOf(o, H') \stof \CellType
        \end{aligned}
      \end{equation}
      The only objects of type \CellType{} on the heap are cell objects 
      whose exact type are \CellType{}, which is $\ocap$ by {\sc OCAP-Cell}.
      Combined with \eqref{eq:espawn-ocr2} this yields
      \begin{equation}
        \begin{aligned}
          \forall o &\in \reachable(\accRoots(\FS', H'), \Graph(H')). \\
            &\ocap(\typeOf(o, H')).
        \end{aligned}
      \end{equation}
      By Proposition \ref{prop:ocrloc_eq} we have shown \eqref{eq:espawn-ocr1}.

      Continuing by showing isolation we note that by \eqref{eq:espawn-hp0},
      \eqref{eq:espawn-ocr0} and \ref{prop:2.6} we have that
      \begin{equation}
        \isolation(H', P).
      \end{equation}
      Thus by Proposition \ref{prop:2.6} we are done if we can prove 
      \begin{equation}
        \HS|_b^{\iota'} \in P. \: \isolated(H', \FS', \HS).
      \end{equation}
      Again using Proposition~\ref{prop:2.6} we are done if we show
      \begin{equation}
        \begin{aligned}
          \forall q \in \: &\reachable(\accRoots(\FS', H'), \Graph(H')) \cap \\
            &\reachable(\accRoots(\HS, H'), \Graph(H')) . \\
            &\typeOf(q, H') \stof \CellType.
        \end{aligned}
      \end{equation}
      But this follows immediately from \eqref{eq:espawn-ocr2} and 
      by the above we have
      \begin{equation}
        \isolation(H', P').
      \end{equation} 
      Furthermore we never relied on the fact that $H \vdash P \tsep \gsep$ to
      prove this and thus get
      \begin{equation}
        H' \vdash P' \tsep \gsep 
      \end{equation}
      for free using Corollary~\ref{cor:2.9}.

    \item[Case {\sc E-Term}:] Trivial.
  \end{description}
\end{proof}


\section{Proof of Progress}
\label{sec:proof_of_progress}

\begin{theorem*}[Progress]
  Let $S$ be a state such that $\vdash S \tsep \stateok$. Then either 
  \begin{enumerate}
    \item $\exists S'$ s.t. $S \Rrightarrow S'$, 
    \item $S = H, \emptyset$ for some heap $H$ s.t. $\noSpawn{(H)}$ or
    \item $S = \Error$.
  \end{enumerate}
\end{theorem*}

\begin{proof}
  Assume for a contradiction that $\vdash S \tsep \stateok$ but that neither 1,
  2 or 3 from the theorem holds. We must then have that the following three
  statements hold
  \begin{enumerate}
    \item $\not\exists S'$ s.t. $S \Rrightarrow S'$.
    \item $S = H, \emptyset$ but $\noSpawn(H)$ does not hold, or $S = H, P$
      where $P \neq \emptyset$.
    \item $S \neq \Error$.
  \end{enumerate}
  This gives us two cases: Either $S = H, \emptyset$ and $\noSpawn(H)$ does not hold,
  or $S = H, P$ and $P \neq \emptyset$.

  We begin with the case where $S = H, \emptyset$ and $\noSpawn(H)$ does not
  hold. Looking at the definition of $\noSpawn$ this means that there is at
  least one $o \in \dom(H)$ such that $H(o) = \Cell{\DEP, l}$ and
  \begin{equation*}
    \exists (l', cb)^\iota \in \DEP. \: l' \sqsubseteq l.
  \end{equation*}
  This clearly satisfies the preconditions of execution rule {\sc E-Spawn} and
  thus there is another state $S' = H', P'$ such that $S \Rrightarrow S'$. But
  this contradicts statement 1 above.

  We proceed with the case where $S = H, P$ and $P \neq \emptyset$. This means
  that
  \begin{equation*}
    P = Q \cup_D \left\{ \FS|_a^\iota \right\} \andalso \FS = \sframe{L, t} \circ \GS
  \end{equation*}
  By $\vdash S \tsep \stateok$ we must have
  \begin{equation*}
    H \vdash P.
  \end{equation*}
  By Proposition \ref{prop:2.13} this means that 
  \begin{equation*}
    H;a \vdash \FS.
  \end{equation*}
  Inspecting rule {\sc T-FS1} we see that
  \begin{equation} \label{eq:prog_tbase}
    \begin{gathered}
      H \vdash \Gamma;L \andalso \TypeRel{\Gamma}{a}{t}{\sigma'} \\
      \sigma' \stof \sigma \andalso H;a \vdash^{s: \sigma} \GS.
    \end{gathered}
  \end{equation}
  We proceed by cases on the form of $t$. 
  
  \begin{note}
    Note that we only state which \emph{base rule} is used for each step found below.
    This means that if, e.g., the rule used is a frame reduction rule (one of the
    rules defined in Figure~\ref{fig:frame_red_rules}) the application of {\sc
    E-FProp} and {\sc E-FSProp} is implied. We will use the symbol \lightning to
    indicate a contradiction.
  \end{note}

  \begin{description}
    \item[Case $t = x$:] 
      If $\GS = \varepsilon$ then we can make a step to $S' = H, Q$ by applying
      rule {\sc E-Term}. \contradiction

      Otherwise we have that $\GS = \xframe{L', t'}^{s'} \circ \HS$. This means we
      can step to $S' = H, P'$ where
      \begin{equation*}
        \begin{gathered}
          P' = Q \cup_D \left\{ \FS'|_a^\iota \right\} \andalso \FS' = \xframe{L'',
          t'}^{s'} \circ \HS \\ 
          L'' = L'[s \mapsto L(x)],
        \end{gathered} \end{equation*}
      by base rule {\sc E-Ret}. $L(x)$ is defined by $H \vdash \Gamma; L$. \contradiction
    
    \item[Case $t = \Let{x}{e}{t'}$:]
      We proceed on cases of $e$.
      \begin{description}
        \item[Case $e = \NullVal$:] 
          We can step to $S' = H, P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto \NullVal]
            \end{gathered}
          \end{equation*}
          by base rule {\sc E-Null}. \contradiction

        \item[Case $e = l$:]
          We can step to $S' = H, P'$ where 
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto l]
            \end{gathered}
          \end{equation*}
          by rule {\sc E-LVal}. \contradiction

        \item[Case $e = y$:]
          We can step to $S' = H, P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto L(y)]
            \end{gathered}
          \end{equation*}
          by rule {\sc E-Var}. $L(y)$ is defined by $H \vdash \Gamma;L$. \contradiction

        \item[Case $e = \FSel{y}{f}$:]
          By \eqref{eq:prog_tbase}, {\sc T-Let}, {\sc T-Select} and {\sc T-Var}
          \begin{equation*}
            \Gamma(y) = C \andalso \ftype(f, C) = \tau.
          \end{equation*}
          By $H \vdash \Gamma;L$
          \begin{equation*}
            \typeOf(L(y), H) \stof C
          \end{equation*}
          which means that either $\typeOf(L(y), H) = C' \stof C$ or \\
          $\typeOf(L(y), H) = \NullType$. 
          
          If $\typeOf(L(y), H) = \NullType$ by definition of $\typeOf$
          \begin{equation*}
            L(y) = \NullVal
          \end{equation*}
          Then we can step to $S' = \Error$ by {\sc E-NullSelect}.
          \contradiction

          If $\typeOf(L(y), H) = C'$ then
          \begin{equation*}
            L(y) = o_y \andalso H(o_y) = \Obj{C', \FM}
          \end{equation*}
          By $C' \stof C$, $\ftype(f, C) = \tau$ and well-formedness of
          classes,
          \begin{equation*}
            f \in \fields(C') \andalso \ftype(f, C') = \tau.
          \end{equation*}
          Then $\vdash H$ implies
          \begin{equation*}
            f \in \dom(\FM).
          \end{equation*}
          But then by rule {\sc E-Select} we can step to $S' = H, P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto \FM(f)].
            \end{gathered}
          \end{equation*}
          \contradiction

        \item[Case $e = \FAss{y}{f}{z}$:]
          By \eqref{eq:prog_tbase}, {\sc T-Let}, {\sc T-Assign} and {\sc T-Var}
          \begin{equation*}
            \begin{gathered}
              \Gamma(y) = C \andalso \ftype(f,C) = \tau  \\
              \Gamma(z) = \tau' \andalso \tau' \stof \tau.
            \end{gathered}
          \end{equation*}
          By $H \vdash \Gamma;L$
          \begin{equation*}
            \typeOf(L(y), H) \stof C,
          \end{equation*}
          which means that either $\typeOf(L(y), H) = C' \stof C$ or \\
          $\typeOf(L(y), H) = \NullType$.

          If $\typeOf(L(y), H) = \NullType$ we get
          \begin{equation*}
            L(y) = \NullVal.
          \end{equation*}
          We can then step to $\Error$ by rule {\sc E-NullAssign}.
          \contradiction

          If $\typeOf(L(y), H) = C'$ then
          \begin{equation*}
            L(y) = o_y \andalso H(o_y) = \Obj{C', \FM}.
          \end{equation*}
          By $C' \stof C$, $\ftype(f, C) = \tau$ and well-formedness of classes
          \begin{equation*}
            f \in \fields(C') \andalso \ftype(f, C') = \tau.
          \end{equation*}
          Then by $\vdash H$ we have 
          \begin{equation*}
            f \in \dom(\FM).
          \end{equation*}
          We can then by {\sc E-Assign} step to $S' = H', P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto L(z)] \andalso \FM' = \FM[f \mapsto L(z)] \\
              H' = H[o_y \mapsto \Obj{C', \FM'}]
            \end{gathered}
          \end{equation*}
          $L(z)$ is defined by $H \vdash \Gamma; L$. \contradiction

        \item[Case $e = \New{C}$:]
          By \eqref{eq:prog_tbase}, {\sc T-Let} and {\sc T-New}
          \begin{equation*}
            \TypeRel{\Gamma}{a}{\New{C}}{C}.
          \end{equation*}
          Since the program is well formed the class $C$ exists. 
          \begin{equation*}
            \FM = [f \mapsto \default(\tau): (\VarDecl{f}{\tau}) \in \fdecls(C)]
          \end{equation*}
          is therefore well defined. By {\sc E-New} we can therefore step to $S'
          = H', P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto o] \andalso o \text{ fresh object reference } \\
              H' = H[o \mapsto \Obj{C, \FM}].
            \end{gathered}
          \end{equation*}
          \contradiction

        \item[Case $e = \NewCell$:]
          We can immediately step to $S' = H', P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto o] \andalso o \text{ fresh object reference } \\
              H' = H[o \mapsto \Cell{\emptyset, \bot_{\LatVals}}]
            \end{gathered}
          \end{equation*}
          by rule {\sc E-NewCell}. \contradiction
      
        \item[Case $e = \Call{y}{m}{z}$:]
          By \eqref{eq:prog_tbase}, {\sc T-Let}, {\sc T-Call} and {\sc T-Var}
          \begin{equation*}
            \begin{gathered}
              \Gamma(y) = C \andalso \mtype(m, C) = \gamma \to \tau \\
              \Gamma(z) = \gamma' \andalso \gamma' \stof \gamma.
            \end{gathered}
          \end{equation*}
          By $H \vdash \Gamma;L$ 
          \begin{equation*}
            \typeOf(L(y), H) \stof C.
          \end{equation*}
          Then either $\typeOf(L(y), H) = C' \stof C$ or $\typeOf(L(y)) =
          \NullType$.

          If $\typeOf(L(y), H) = \NullType$ then
          \begin{equation*}
            L(y) = \NullVal
          \end{equation*}
          and we can apply rule {\sc E-NullCall} to step to \Error.
          \contradiction

          If $\typeOf(L(y), H) = C'$
          \begin{equation*}
            L(y) = o_y \andalso H(o_y) = \Obj{C', \FM}.
          \end{equation*}
          $C' \stof C$ and classes being well typed means that if $\mtype(m, C)$
          is defined then $\mbody(m, C')$ is defined aswell. Thus let
          \begin{equation*}
            \mbody(m, C) = w \to t''.
          \end{equation*}
          By rule {\sc E-Call} we can then step to $S' = H, P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \xframe{L'',
              t''}^x \circ \sframe{L, t'} \\
              L_{\text{base}} =
              \begin{cases}
                \emptyset & \text{ if } a = \ocap \\
                L_0       & \text{ if } a = \nocap
              \end{cases} \\
              L'' = L_{\text{base}}[\This \mapsto L(y), w \mapsto L(z)].
            \end{gathered}
          \end{equation*}
          $L(z)$ is defined by $H \vdash \Gamma; L$. \contradiction

        \item[Case $e = \Put{y}{z}$:]
          By \eqref{eq:prog_tbase}, {\sc T-Let}, {\sc T-Put} and {\sc T-Var}
          \begin{equation*}
            \Gamma(y) = \CellType \andalso \Gamma(z) = \LatType.
          \end{equation*}
          Thus by $H \vdash \Gamma; L$
          \begin{equation*}
            \typeOf(L(y), H) \stof \CellType \andalso \typeOf(L(z), H) \stof
            \LatType.
          \end{equation*}
          By definition of $\typeOf$ and the structure of the type lattice this
          means that $\typeOf(L(z), H) = \LatType$ and that either
          $\typeOf(L(y), H) = \CellType$ or $\typeOf(L(y), H) = \NullType$. \\
          $\typeOf(L(z), H) = \LatType$ implies
          \begin{equation*}
            L(z) = l' \andalso l' \in \LatVals.
          \end{equation*}

          If $\typeOf(L(y), H) = \NullType$
          \begin{equation*}
            L(y) = \NullVal
          \end{equation*}
          and we can apply {\sc E-NullPut} to step to $\Error$. \contradiction

          If $\typeOf(L(y), H) = \CellType$ then 
          \begin{equation*}
            L(y) = o_y \andalso H(o_y) = \Cell{\DEP, l}
          \end{equation*}
          Then we can use rule {\sc E-Put} to step to $S' = H', P'$ where 
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto L(y)] \andalso c' = \Cell{\DEP, l \sqcup l'} \\
              H' = H[o_y \mapsto c']
            \end{gathered}
          \end{equation*}
          \contradiction

        \item[Case $e = \When{y}{z}{(\overline{cap}, w \Rightarrow t'')}$:]
          From \eqref{eq:prog_tbase}, {\sc T-Let}, {\sc T-When} and {\sc T-Var}
          \begin{equation*}
            \begin{gathered}
              \Gamma(y) = \CellType \andalso \Gamma(z) = \LatType \\
              \forall(\Capt{u}{u'}) \in \overline{cap}. \: \Gamma(u') = \CellType \\
              \Gamma_{\text{cells}} = [(u: \CellType) \mid (\Capt{u}{u'}) \in
              \overline{cap}] \\
              \TypeRel{\Gamma_{\text{cells}}, w: \LatType}{\ocap}{t}{\gamma}.
            \end{gathered}
          \end{equation*}
          Combinig the first two with $H \vdash \Gamma;L$
          \begin{gather*}
            \typeOf(L(y), H) \stof \CellType \\
            \typeOf(L(z), H) \stof \LatType.
          \end{gather*}
          Similarly to the previous case we have
          \begin{equation*}
            L(z) = l' \andalso l' \in \LatVals.
          \end{equation*}
          Also, either
          \begin{equation*}
            \typeOf(L(y), H) = \CellType
          \end{equation*}
          or
          \begin{equation*}
            \typeOf(L(z), H) = \NullType.
          \end{equation*}

          If $\typeOf(L(y), H) = \NullType$ then
          \begin{equation*}
            L(y) = \NullVal.
          \end{equation*}
          By {\sc E-NullWhen} we can step to $\Error$. \contradiction

          If $\typeOf(L(y), H) = \CellType$
          \begin{equation*}
            L(y) = o_y  \andalso H(o_y) = \Cell{\DEP, l}
          \end{equation*}
          By {\sc E-When} we can step to $S' = H', P'$ where
          \begin{equation*}
            \begin{gathered}
              P' = Q \cup \left\{\FS'|_a^\iota \right\} \andalso \FS' = \sframe{L',
              t'} \\
              L' = L[x \mapsto L(y)] \andalso L_{\text{env}} = [u \mapsto L(u')
              \mid
              (\Capt{u}{u'}) \in \overline{cap}] \\
              cb = ( L_{\text{env}}, w \Rightarrow t'' ) \andalso \DEP' = \DEP
              \cup (l', cb)^\iota \\
              \iota \text{ fresh thread id } \andalso H' = H[o_y \mapsto \Cell{\DEP',
              l}].
            \end{gathered}
          \end{equation*}
          $L(u')$ is defined for all $u'$s by $H \vdash \Gamma; L$. \contradiction
      \end{description}
      {\bf This concludes the case $t = \Let{x}{e}{t'}$.}
  \end{description}
  Clearly all cases for $t$ leads to a contradiction and therefore we are done.
\end{proof}


