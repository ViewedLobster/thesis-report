\chapter{Proof of Quasi Determinism}

\begin{notation}
  We denote a partial function/map $f$ from $A$ to $B$ as
  \begin{equation*}
    f: A \rightharpoonup B.
  \end{equation*}
  If a map $g: A \to B$ is a bijection we write
  \begin{equation*}
    g: A \hookrightarrow B.
  \end{equation*}
\end{notation}

\begin{definition} \label{def:pirho}
  Let $S = H, P$ and let 
  \begin{equation*}
    g: \OIDs(S) \hookrightarrow \OIDs' \andalso h: \TIDs(S) \hookrightarrow \TIDs' 
  \end{equation*}
  where $\OIDs'$ ($\TIDs'$)is some subset of $\OIDs$ ($\TIDs$).
  Then 
  \begin{equation}
    \pi(H, g, h) = H^* \in \Heaps
  \end{equation}
  where
  \begin{equation}
    \begin{gathered}
      H^*(o) =
      \begin{cases}
        \Obj{C, FM^*}   & \text{ if } H(g^{-1}(o)) = \Obj{C, FM} \\
        \Cell{DEP^*, l} & \text{ if } H(g^{-1}(o)) = \Cell{DEP, l}
      \end{cases} \\
      FM^* = \delta(FM, g) \andalso DEP^* = \eta(DEP, g, h).
    \end{gathered}
  \end{equation}

  Furthermore writing
  \begin{equation}
    P = \left\{ FS_i|_{a_i}^{d_i} \right\}_{i = 1}^n
  \end{equation}
  we let
  \begin{equation*}
    \rho(P, g, h) = P^*
  \end{equation*}
  where
  \begin{equation*}
    \begin{gathered}
      FS_i = \xframe{L_{m_i}, t_{m_i}}^{s_{m_i}} \circ \dots \circ \xframe{L_1,
      t_1}^{s_1} \circ \varepsilon \\
      FS_i^* = \xframe{\delta(L_{m_i}, g), t_{m_i}}^{s_{m_i}} \circ \dots \circ
      \xframe{\delta(L_1,g), t_1}^{s_1} \circ \varepsilon \\
      P^* = \left\{ FS_i^*|_{a_i}^{h(d_i)} \right\}_{i = 1}^n.
    \end{gathered}
  \end{equation*}
\end{definition}

\begin{note}
  The $\pi$ and $\rho$ functions more or less just replaces object and thread
  identifiers as specified by $g$ and $h$.
\end{note}

\begin{definition}
  Let $M: A \rightharpoonup B, g: C \hookrightarrow D, C \subseteq B, D
  \subseteq B$. Then $\delta(M, g): A \rightharpoonup B$ and is defined as
  follows for any element $a \in A$.
  \begin{equation*}
    \delta(M, g)(a) = 
    \begin{cases}
      g(c) & \text{ if } M(a) = c \in C \\
      M(a) & \text{o.w.}
    \end{cases}
  \end{equation*}
\end{definition}

\begin{definition}
  Let $g, h$ be as in definition \ref{def:pirho}. 
  \begin{equation*}
    \eta(DEP, g, h) = \left\{ (l, (\delta(L_{\text{env}}, g), z \Rightarrow
    t))^{h(d)}: (l,
    (L_{\text{env}}, z \Rightarrow t))^d \in DEP \right\}
  \end{equation*}
  I.e. we replace all object identifiers occuring in callback environments
  according to the replacement map $g$, and change the corresponding thread
  identifier $d$ to $h(d)$.
\end{definition}


\begin{proof}{(Proposition~\ref{prop:eqrel}, sketch)} 
  To prove that $\simeq$ is an equivalence relation we need to prove
  reflexivity, symmetry and transitivity.
  \begin{description}
    \item[Reflexivity:] Let $S$ be a state. If $S = \Error$ then reflexivity
      follows trivially. Thus let $S = H, P$. We need to prove that there are $g: 
      \OIDs(S) \hookrightarrow \OIDs(S), h: \TIDs(S) \hookrightarrow \TIDs(S)$
      such that $H = \pi(H, g, h)$ and $P = \rho(P, g, h)$. This is easy since
      \begin{equation*}
        g = \Id_{\OIDs(S)} \andalso h = \Id_{\TIDs(S)}
      \end{equation*}
      can be easily seen to fulfill this.
    \item[Symmetry:] Let $S \simeq S'$. If $S = \Error$ then $S' = \Error$ and
      we have $S' \simeq S$. If $S = H, P; S' = H', P'$ we must have
      \begin{equation*}
        g: \OIDs(S) \hookrightarrow \OIDs(S') \andalso h: \TIDs(S)
        \hookrightarrow \TIDs(S')
      \end{equation*}
      such that
      \begin{equation*}
        H' = \pi(H, g, h) \andalso P' = \rho(P, g, h).
      \end{equation*}
      It can easily be shown that $g^{-1}$ and $h^{-1}$ are bijections such that
      \begin{equation*}
        H = \pi(H', g^{-1}, h^{-1}) \andalso P = \rho(P', g^{-1}, h^{-1}).
      \end{equation*}
      We thus get that $S' \simeq S$.

    \item[Transitivity:] Let $S \simeq S'$ and $S' \simeq S''$. The case where
      $S = \Error$ is trivial. Thus let $S = H,P; S' = H',P'; S'' = H'', P''$.
      We must have
      \begin{equation*}
        \begin{gathered}
          g: \OIDs(S) \hookrightarrow \OIDs(S') \andalso h: \TIDs(S)
          \hookrightarrow \TIDs(S') \\
          g': \OIDs(S') \hookrightarrow \OIDs(S'') \andalso h': \TIDs(S')
          \hookrightarrow \TIDs(S'')
        \end{gathered}
      \end{equation*}
      such that
      \begin{equation*}
        \begin{gathered}
          H' = \pi(H, g, h) \andalso P' = \rho(P, g, h)  \\
          H'' = \pi(H', g', h') \andalso P'' = \rho(P', g', h').
        \end{gathered}
      \end{equation*}
      It is easily shown that $g \circ g'$ and $h \circ h'$ are bijections such
      that 
      \begin{equation*}
        H'' = \pi(H', g \circ g', h \circ h') \andalso P'' = \rho(P', g \circ
        g', h \circ h').
      \end{equation*}
      Thus $S \simeq S''$.
  \end{description}
\end{proof}

\begin{proof}{(Proposition~\ref{prop:eqrel_stateok}, sketch)}
  Since $\simeq$ is an equivalence relation we only need to prove one direction.
  Thus assume
  \begin{equation}
    \vdash S \tsep \stateok.
  \end{equation}
  Letting $S = H, P; S' = H', P'$ we need to show
  \begin{equation} 
    \begin{gathered}
      \vdash H' \andalso H' \vdash P' \andalso H' \vdash P' \tsep \ocr \\
      \isolation(H', P') \andalso H' \vdash P \tsep \gsep.
    \end{gathered}
  \end{equation}
  Since the application of $\pi$ to $H$ amounts only to a renaming of the object
  and thread identifiers we have that $\Graph(H)$ is the same as $\Graph(H')$ up to a
  renaming of vertices. It does not change any types i.e. 
  \begin{equation} \label{eq:eqrel_stateok1}
    \typeOf(o, H) = \typeOf(g(o), H').
  \end{equation}
  Thus it is not hard to prove $\vdash H'$. 
  
  The application of $\rho$ similarly does the same kind of operation to $P$.
  Thus it is not hard proving $H' \vdash P'$ either.
  $H' \vdash P' \tsep \ocr$ follows from the graph equivalence mentioned above
  and \eqref{eq:eqrel_stateok1}. Using the same properties we can show
  $\isolation(H', P')$ and $H' \vdash P' \tsep \gsep$.
\end{proof}

We make the following observation
\begin{claim}
  A transition between two states can be uniquely identified by
  \begin{itemize}
    \item Start state $S$
    \item Base rule name $R$ e.g. $R = \ENew$ or $R = \ESpawn$. We say base rule
      because in many cases the step involves more than one rule in its
      derivation tree of a complete state step. However the use of these extra
      rules are implied by which rule is used as the "base" of the tree. E.g.\
      using $\ECall$ to step one thread implies use of $\EFSProp$ to advance the
      state, and using $\ENew$ to advance one thread frame implies use of
      $\EFProp$ and $\EFSProp$ in order to advance the state.
    \item Thread identifier $\alpha$. In the cases where we advance or terminate
      one thread e.g. $\ENull$ or $\ECall$ this is the thread identifier of that
      thread. In the case where we spawn a new thread this is the callback
      identifier.
    \item A fresh object or thread identifier $\beta$ which could be of value
      \begin{itemize}
        \item Object identifier $o' \in \OIDs$ in the cases where the rule
          references a fresh object identifier, i.e. $\ENew$ and $\ENewCell$.
        \item Thread id $\alpha' \in \TIDs$ for the case where a fresh thread id is
          referenced, i.e. $\EWhen$.
        \item $\smiley$ for all other cases.
      \end{itemize}
  \end{itemize}
\end{claim}

Because of this claim we can make the following definition

\begin{definition}
  We write a \emph{transition identifier} as $R^{\alpha, \beta}$. The
  \emph{application} of $R^{\alpha, \beta}$ to state $S$ (if possible) is the
  use of a rule as specified by $R$, $\alpha$ and $\beta$ to step from $S$ to
  some state $S'$. We write this as
  \begin{equation*}
    S \Rrightarrow^{R^{\alpha, \beta}} S'
  \end{equation*}
\end{definition}

\begin{definition}
  A \emph{transition sequence} $\bar{R}$ is a finite length sequence of
  transition identifiers
  \begin{equation*}
    R_1^{\alpha_1, \beta_1}, R_2^{\alpha_2, \beta_2}, \dots, R_n^{\alpha_n,
    \beta_n}.
  \end{equation*}
  The application of this sequence to a state $S$ is the consecutive application
  of
  \begin{equation*}
    R_i^{\alpha_i, \beta_i} \andalso i = 1, \dots, n
  \end{equation*}
  beginning with state $S$. I.e.
  \begin{equation*} 
    S \Rrightarrow^{R_1^{\alpha_1, \beta_1}} S_1 \Rrightarrow^{R^{\alpha_2,
    \beta_2}} S_2  \: \dots \: S_{n-1} \Rrightarrow^{R_n^{\alpha_n, \beta_n}} S_n
  \end{equation*}
  We shorten this to
  \begin{equation*}
    S \Rrightarrow^{\bar{R}} S_n.
  \end{equation*}
\end{definition}


\section{Proof of Quasi Determinism}
\label{sec:proof_of_quasi_determinism}

\begin{lemma}
  Let $S$ be a state where the two transitions
  \begin{equation*}
    \begin{gathered}
      R_1^{\alpha_1, \beta_1} \neq R_2^{\alpha_2, \beta_2} \\
      \alpha_1 \neq \alpha_2 \andalso \beta_1 \neq \beta_2 \text{ or } \beta_1 =
      \beta_2 = - 
    \end{gathered}
  \end{equation*}
  are applicable.
  Let
  \begin{equation*}
    \bar{R}_1  = R_1^{\alpha_1, \beta_1}, R_2^{\alpha_2, \beta_2} \andalso
    \bar{R}_2 = R_2^{\alpha_2, \beta_2}, R_1^{\alpha_1, \beta_1}
  \end{equation*}
  Then both $\bar{R}_1, \bar{R}_2$ applicable to $S$ and
  \begin{equation*}
    \begin{gathered}
      S \Rrightarrow^{\bar{R}_1} S'_1 \andalso S \Rrightarrow^{\bar{R}_2} S'_2
      \\
      S'_1 = S'_2
    \end{gathered}
  \end{equation*}
\end{lemma}

\begin{proof}
  All execution rules are of the form
  \begin{equation*}
    H, P_0 \cup_D P_1 \Rrightarrow H', P_0 \cup_D P'_1
  \end{equation*}
  where $P_1$ and $P'_1$ are sets of 0 or 1 threads. Moreover, by rule
  inspection, if $|P_1| = 1$ and $P'_1 = 1$ then
  \begin{equation*}
    P_1 =  \left\{ FS|_a^\alpha \right\} \andalso P'_1 = \left\{ FS'|_a^\alpha
    \right\}.
  \end{equation*}
  Also there is no rule such that $|P_1| = |P'_1| = 0$.
  Therefore since $\alpha_1 \neq \alpha_2$ and the fact that all threads or
  callbacks have unique IDs it is simple to verify that both $\bar{R_1}$ and
  $\bar{R_2}$ are applicable to $S$. Since there are very many cases this is not
  done here.

  The only thing remaining is to verify that $S'_1 = S'_2$. There are very many
  cases, most of which are very trivial to verify. Thus we are only going to do
  a few here, the others can be done similarly. One thing to note is that the
  cases are symmetric in $R_1^{\alpha_1, \beta_1}$ and $R_2^{\alpha_2,
  \beta_2}$. We proceed by cases on the value of $R_1$ and $R_2$.
  \begin{description}
    \item[Case $R_1 = \EAssign, R_2 = \EAssign$:] We note that this means that
      $\beta_1 = \beta_2 = \smiley$.
  \end{description}
\end{proof}

\begin{lemma}
  Let $S$ be a state. Let
  \begin{equation*}
    \bar{R} = R_1^{\alpha_1, \beta_1}, \dots, R_n^{\alpha_n, \beta_n} \andalso
    S \Rrightarrow^{\bar{R}} S_{\bar{R}}
  \end{equation*}
  Let $R^{\alpha, \beta}$ be a transition such that
  \begin{equation*}
    \alpha \neq \alpha_i \andalso \forall i \in \left\{ 1, \dots, n \right\},
  \end{equation*}
  and
  \begin{equation*}
    S \Rrightarrow^{R^{\alpha, \beta}} S_{R^{\alpha, \beta}} \andalso
    S_{\bar{R}} \Rrightarrow^{R^{\alpha, \beta}} S'.
  \end{equation*}
  Then
  \begin{equation*}
    S_{R^{\alpha, \beta}} \Rrightarrow^{\bar{R}} S'.
  \end{equation*}
\end{lemma}

\begin{lemma}
  Let $S, S', T$ be states and $\bar{R}$ a transition sequence such that
  \begin{equation*}
    S \Rrightarrow^{\bar{R}} T \andalso S \simeq S'.
  \end{equation*}
  Then there is a state $T'$ and a transition sequence $\bar{R'}$ of the same
  length as $\bar{R}$ such that
  \begin{equation*}
    S' \Rrightarrow^{\bar{R'}} T' \andalso T \simeq T'.
  \end{equation*}
\end{lemma}






