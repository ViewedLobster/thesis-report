\chapter{Proof of Quasi-Determinism}
\label{cha:proof_of_qd}

\section{Preliminaries}
\label{sec:preliminaries}

\begin{notation}
  We denote a partial function/map $f$ from $A$ to $B$ as
  \begin{equation*}
    f: A \rightharpoonup B.
  \end{equation*}
  If a map $g: A \to B$ is a bijection we write
  \begin{equation*}
    g: A \hookrightarrow B.
  \end{equation*}
\end{notation}

\begin{definition} \label{def:pirho}
  Let $S = H, P$ and let 
  \begin{equation*}
    g: \OIDs \hookrightarrow \OIDs \andalso h: \TIDs \hookrightarrow \TIDs .
  \end{equation*}
  Then 
  \begin{equation}
    \pi(H, g, h) = H^* \in \Heaps
  \end{equation}
  where
  \begin{equation}
    \begin{gathered}
      H^*(o) =
      \begin{cases}
        \Obj{C, FM^*}   & \text{ if } H(g^{-1}(o)) = \Obj{C, FM} \\
        \Cell{DEP^*, l} & \text{ if } H(g^{-1}(o)) = \Cell{DEP, l}
      \end{cases} \\
      FM^* = \delta(FM, g) \andalso DEP^* = \eta(DEP, g, h).
    \end{gathered}
  \end{equation}

  Furthermore writing
  \begin{equation}
    P = \left\{ FS_i|_{a_i}^{\iota_i} \right\}_{i = 1}^n
  \end{equation}
  we let
  \begin{equation*}
    \rho(P, g, h) = P^*
  \end{equation*}
  where
  \begin{equation*}
    \begin{gathered}
      FS_i = \xframe{L_{m_i}, t_{m_i}}^{s_{m_i}} \circ \dots \circ \xframe{L_1,
      t_1}^{s_1} \circ \varepsilon \\
      FS_i^* = \xframe{\delta(L_{m_i}, g), t_{m_i}}^{s_{m_i}} \circ \dots \circ
      \xframe{\delta(L_1,g), t_1}^{s_1} \circ \varepsilon \\
      P^* = \left\{ FS_i^*|_{a_i}^{h(\iota_i)} \right\}_{i = 1}^n.
    \end{gathered}
  \end{equation*}
\end{definition}

\begin{note}
  The $\pi$ and $\rho$ functions more or less just replaces object and thread
  identifiers as specified by $g$ and $h$.
\end{note}

\begin{definition}
  Let $M: A \rightharpoonup B, g: B \hookrightarrow B$. Then $\delta(M, g): A
  \rightharpoonup B$ and is defined as follows for any element $a \in A$.
  \begin{equation*}
    \delta(M, g)(a) = g(M(a))
  \end{equation*}
\end{definition}

\begin{definition}
  Let $g, h$ be as in definition \ref{def:pirho}. 
  \begin{equation*}
    \eta(DEP, g, h) = \left\{ (l, (\delta(L_{\text{env}}, g), z \Rightarrow
    t))^{h(\iota)}: (l,
    (L_{\text{env}}, z \Rightarrow t))^\iota \in DEP \right\}
  \end{equation*}
  I.e. we replace all object identifiers occuring in callback environments
  according to the replacement map $g$, and change the corresponding thread
  identifier $\iota$ to $h(\iota)$.
\end{definition}


\begin{proof}{(Proposition~\ref{prop:eqrel}, sketch)} 
  To prove that $\simeq$ is an equivalence relation we need to prove
  reflexivity, symmetry and transitivity.
  \begin{description}
    \item[Reflexivity:] Let $S$ be a state. If $S = \Error$ then reflexivity
      follows trivially. Thus let $S = H, P$. We need to prove that there are $g: 
      \OIDs \hookrightarrow \OIDs, h: \TIDs \hookrightarrow \TIDs$
      such that $H = \pi(H, g, h)$ and $P = \rho(P, g, h)$. This is easy since
      \begin{equation*}
        g = \Id_{\OIDs} \andalso h = \Id_{\TIDs}
      \end{equation*}
      can be seen to fulfill this.

    \item[Symmetry:] Let $S \simeq S'$. If $S = \Error$ then $S' = \Error$ and
      we have $S' \simeq S$. If $S = H, P; S' = H', P'$ we must have
      \begin{equation*}
        g: \OIDs \hookrightarrow \OIDs \andalso h: \TIDs
        \hookrightarrow \TIDs
      \end{equation*}
      such that
      \begin{equation*}
        H' = \pi(H, g, h) \andalso P' = \rho(P, g, h).
      \end{equation*}
      It can easily be verified that $g^{-1}$ and $h^{-1}$ are bijections such that
      \begin{equation*}
        H = \pi(H', g^{-1}, h^{-1}) \andalso P = \rho(P', g^{-1}, h^{-1}).
      \end{equation*}
      We thus get that $S' \simeq S$.

    \item[Transitivity:] Let $S \simeq S'$ and $S' \simeq S''$. The case where
      $S = \Error$ is trivial. Thus let $S = H,P; S' = H',P'; S'' = H'', P''$.
      We must have
      \begin{equation*}
        \begin{gathered}
          g: \OIDs \hookrightarrow \OIDs \andalso h: \TIDs
          \hookrightarrow \TIDs \\
          g': \OIDs \hookrightarrow \OIDs \andalso h': \TIDs
          \hookrightarrow \TIDs
        \end{gathered}
      \end{equation*}
      such that
      \begin{equation*}
        \begin{gathered}
          H' = \pi(H, g, h) \andalso P' = \rho(P, g, h)  \\
          H'' = \pi(H', g', h') \andalso P'' = \rho(P', g', h').
        \end{gathered}
      \end{equation*}
      It is easily shown that $g \circ g'$ and $h \circ h'$ are bijections such
      that 
      \begin{equation*}
        H'' = \pi(H', g \circ g', h \circ h') \andalso P'' = \rho(P', g \circ
        g', h \circ h').
      \end{equation*}
      Thus $S \simeq S''$.
  \end{description}
\end{proof}

\begin{proof}{(Proposition~\ref{prop:eqrel_stateok}, sketch)}
  Since $\simeq$ is an equivalence relation we only need to prove one direction.
  Thus assume
  \begin{equation}
    \vdash S \tsep \stateok.
  \end{equation}
  Letting $S = H, P; S' = H', P'$ we need to show
  \begin{equation} 
    \begin{gathered}
      \vdash H' \andalso H' \vdash P' \andalso H' \vdash P' \tsep \ocr \\
      \isolation(H', P') \andalso H' \vdash P \tsep \gsep.
    \end{gathered}
  \end{equation}
  Since the application of $\pi$ to $H$ amounts only to a renaming of the object
  and thread identifiers we have that $\Graph(H)$ is the same as $\Graph(H')$ up to a
  renaming of vertices. It does not change any types i.e. 
  \begin{equation} \label{eq:eqrel_stateok1}
    \typeOf(o, H) = \typeOf(g(o), H').
  \end{equation}
  Thus it is not hard to prove $\vdash H'$. 
  
  The application of $\rho$ similarly does the same kind of operation to $P$.
  Thus it is not hard proving $H' \vdash P'$ either.
  $H' \vdash P' \tsep \ocr$ follows from the graph equivalence mentioned above
  and \eqref{eq:eqrel_stateok1}. Using the same properties we can show
  $\isolation(H', P')$ and $H' \vdash P' \tsep \gsep$.
\end{proof}

\begin{proof}{(Proposition~\ref{prop:eqrel_stateok})}
  Follows from the fact that applying $\pi$ and $\rho$ to a state is simply a
  renaming of object and thread identifiers.
\end{proof}

\section{Proof of Quasi-Determinism}
\label{sec:proof_of_quasi_determinism}

\begin{lemma} \label{lem:lemma1}
  Let $S$ be a state s.t. $\vdash S \tsep \stateok$ where the two transitions
  \begin{equation*}
    \begin{gathered}
      R_1^{\iota_1, \beta_1} \neq R_2^{\iota_2, \beta_2} \\
      \iota_1 \neq \iota_2 \andalso \beta_1 \neq \beta_2 \text{ or } \beta_1 =
      \beta_2 = - 
    \end{gathered}
  \end{equation*}
  are applicable.
  Let
  \begin{equation*}
    \bar{R}_1  = R_1^{\iota_1, \beta_1}, R_2^{\iota_2, \beta_2} \andalso
    \bar{R}_2 = R_2^{\iota_2, \beta_2}, R_1^{\iota_1, \beta_1}
  \end{equation*}
  Then both $\bar{R}_1, \bar{R}_2$ applicable to $S$ and
  \begin{equation*}
    \begin{gathered}
      S \Rrightarrow^{\bar{R}_1} S'_1 \andalso S \Rrightarrow^{\bar{R}_2} S'_2
      \\
      S'_1 = S'_2
    \end{gathered}
  \end{equation*}
\end{lemma}

\begin{proof}
  All execution rules are of the form
  \begin{equation*}
    H, P_0 \cup_D P_1 \Rrightarrow H', P_0 \cup_D P'_1
  \end{equation*}
  where $P_1$ and $P'_1$ are sets of 0 or 1 threads. Moreover, by rule
  inspection, if $|P_1| = 1$ and $P'_1 = 1$ then
  \begin{equation*}
    P_1 =  \left\{ FS|_a^\iota \right\} \andalso P'_1 = \left\{ FS'|_a^\iota
    \right\}.
  \end{equation*}
  Also there is no rule such that $|P_1| = |P'_1| = 0$.
  Therefore since $\iota_1 \neq \iota_2$ and the fact that all threads or
  callbacks have unique IDs it is simple to verify that both $\bar{R_1}$ and
  $\bar{R_2}$ are applicable to $S$. Since there are a large abundance of cases
  this is not done here.

  The only thing remaining is to verify that $S'_1 = S'_2$. There are very many
  cases, most of which are very to verify. Thus we are only going to do
  a few here to convince the reader. The others can be done similarly.  We
  proceed by cases on the value of $R_1$ and $R_2$. One thing to note is that
  the proofs are symmetric in $R_1$ and $R_2$, meaning that if we prove case
  $R_1 = R, R_2 = R'$ we have also proven case $R_1 = R', R_2 = R$.

  \begin{description}
    \item[Case $R_1 = \EAssign, R_2 = \EAssign$:] We note that this means that
      $\beta_1 = \beta_2 = \smiley$. Furthermore by the rules being applicable
      to $S$ we have
      \begin{equation}
        \begin{gathered}
          S = H, P \andalso P = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS_1 = \xframe{L_1, \Let{w_1}{\FAss{x_1}{f_1}{y_1}}{t'_1}}^{s_1} \circ GS_1
          \\ 
          FS_1 = \xframe{L_2, \Let{w_2}{\FAss{x_2}{f_2}{y_2}}{t'_2}}^{s_2}
          \circ GS_2 \\
          L_1(x_1) = o_1 \andalso L_2(x_2) = o_2 \\
          H(o_1) = \Obj{C_1, FM_1} \andalso H(o_2) = \Obj{C_2, FM_2} \\
          f_1 \in \dom(FM_1) \andalso f_2 \in \dom(FM_2) \\
          S_1 = H_1, P_1 \andalso S \Rrightarrow^{R_1^{\iota_1, \smiley}} S_1
          \\
          P_1 = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS'_1 = \xframe{L'_1, t'_1}^{s_1} \circ GS_1  \andalso L'_1 = L_1[w_1 \mapsto
          L_1(y_1)] \\
          FM'_1 = FM_1[f_1 \mapsto L_1(y_1)] \andalso H_1 = H[o_1 \mapsto
          \Obj{C_1, FM'_1}]
          \\
          S_2 = H_2, P_2 \andalso S \Rrightarrow^{R_2^{\iota_2, \smiley}} S_2
          \\
          P_2 = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          FS'_2 = \xframe{L'_2, t'_2}^{s_2} \circ GS_2  \andalso L'_2 = L_2[w_2 \mapsto
          L_2(y_2)] \\
          FM'_2 = FM_2[f_2 \mapsto L_2(y_2)] \andalso H_2 = H[o_2 \mapsto
          \Obj{C_2, FM'_2}]
          \\
        \end{gathered}
      \end{equation}
      By $\vdash S \tsep \stateok$ we have
      \begin{equation}
        \uniqMain(P) \andalso \isolation(H, P).
      \end{equation}
      These two implies that
      \begin{equation}
        o_1 \neq o_2.
      \end{equation}
      Using this and inspecting $R_2^{\iota_2, \smiley}$ it is not hard to see
      that 
      \begin{equation}
        \begin{gathered}
          S_{12} = H_{12}, P_{12} \andalso S_1 \Rrightarrow^{R_2^{\iota_2,
          \smiley}} S_{12}
          \\
          P_{12} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{12} = H[o_1 \mapsto \Obj{C_1, FM'_1}, o_2 \mapsto \Obj{C_2, FM'_2}]
        \end{gathered}
      \end{equation}
      and similarly 
      \begin{equation}
        \begin{gathered}
          S_{21} = H_{21}, P_{21} \andalso S_2 \Rrightarrow^{R_1^{\iota_1,
          \smiley}} S_{21}
          \\
          P_{21} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{21} = H[o_1 \mapsto \Obj{C_1, FM'_1}, o_2 \mapsto \Obj{C_2, FM'_2}]
        \end{gathered}
      \end{equation}
      Clearly then $S_{12} = S_{21}$ and we are done.
      \begin{remark}
        The main point made here is that the two transition identifiers operate
        on different parts of the heap because of isolation of threads. Thus all
        cases where we have this property follow similarly.
      \end{remark}
    \item[Case $R_1 = \EVar, R_2 = \EAssign$:] We first note that
      \begin{equation*}
        \beta_1 = \beta_2 = \smiley.
      \end{equation*}
      Since the transition identifiers are applicable to $S$ we have
      \begin{equation}
        \begin{gathered}
          S = H, P \andalso P = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS_1 = \xframe{L_1, \Let{x_1}{y_1}{t'_1}}^{s_1} \circ GS_1
          \\ 
          FS_1 = \xframe{L_2, \Let{x_2}{\FAss{y_2}{f_2}{z_2}}{t'_2}}^{s_2}
          \circ GS_2 \\
          L_2(y_2) = o_2 \andalso H(o_2) = \Obj{C_2, FM_2} \\
          f_2 \in \dom(FM_2) \\
          S_1 = H_1, P_1 \andalso S \Rrightarrow^{R_1^{\iota_1, \smiley}} S_1
          \\
          P_1 = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS'_1 = \xframe{L'_1, t'_1}^{s_1} \circ GS_1  \andalso L'_1 = L_1[x_1 \mapsto
          L_1(y_1)] \\
          H_1 = H
          \\
          S_2 = H_2, P_2 \andalso S \Rrightarrow^{R_2^{\iota_2, \smiley}} S_2
          \\
          P_2 = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          FS'_2 = \xframe{L'_2, t'_2}^{s_2} \circ GS_2  \andalso L'_2 = L_2[x_2 \mapsto
          L_2(y_2)] \\
          FM'_2 = FM_2[f_2 \mapsto L_2(y_2)] \andalso H_2 = H[o_2 \mapsto
          \Obj{C_2, FM'_2}]
          \\
        \end{gathered}
      \end{equation}
      Furthermore it is not hard to see that 
      \begin{equation}
        \begin{gathered}
          S_{12} = H_{12}, P_{12} \andalso S_1 \Rrightarrow^{R_2^{\iota_2,
          \smiley}} S_{12}
          \\
          P_{12} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{12} = H[o_2 \mapsto \Obj{C_2, FM'_2}]
        \end{gathered}
      \end{equation}
      and 
      \begin{equation}
        \begin{gathered}
          S_{21} = H_{21}, P_{21} \andalso S_2 \Rrightarrow^{R_1^{\iota_1,
          \smiley}} S_{21}
          \\
          P_{21} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{21} = H[o_2 \mapsto \Obj{C_2, FM'_2}]
        \end{gathered}
      \end{equation}
      Clearly $S_{12} = S_{21}$ and we are done.
      \begin{remark}
        This case is very simple since one of the transition identifiers
        operate solely on the local state of a thread. All cases with this
        property follow similarly.
      \end{remark}
    \item[Case $R_1 = \EPut, R_2 = \EPut$:] Clearly
      \begin{equation*}
        \beta_1 = \beta_2 = \smiley.
      \end{equation*}
      Similarly to previous cases we have
      \begin{equation}
        \begin{gathered}
          S = H, P \andalso P = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS_1 = \xframe{L_1, \Let{x_1}{\Put{y_1}{z_1}}{t'_1}}^{s_1} \circ GS_1
          \\ 
          FS_1 = \xframe{L_2, \Let{x_2}{\Put{y_2}{z_2}}{t'_2}}^{s_2}
          \circ GS_2 \\
          L_1(y_1) = o_1 \andalso L_2(y_2) = o_2 \\
          L_1(z_1) = l_1 \andalso L_2(z_2) = l_2
        \end{gathered}
      \end{equation}
      Now we have two cases since isolation does not prevent sharing of
      references to $\CellType$ objects. If $o_1 \neq o_2$ we are done similarly
      to case $R_1 = \EAssign, R_2 = \EAssign$. If $o_1 = o_2 = o$ we proceed as
      follows.
      
      Firstly
      \begin{equation}
        H(o) = \Cell{DEP, l}.
      \end{equation}
      Then
      \begin{equation}
        \begin{gathered}
          S_1 = H_1, P_1 \andalso S \Rrightarrow^{R_1^{\iota_1, \smiley}} S_1
          \\
          P_1 = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS'_1 = \xframe{L'_1, t'_1}^{s_1} \circ GS_1  \andalso L'_1 = L_1[x_1 \mapsto
          L_1(y_1)] \\
          H_1 = H[o \mapsto \Cell{DEP, l \sqcup l_1}]
        \end{gathered}
      \end{equation}
      and similarly
      \begin{equation}
        \begin{gathered}
          S_2 = H_2, P_2 \andalso S \Rrightarrow^{R_2^{\iota_2, \smiley}} S_2
          \\
          P_1 = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          FS'_2 = \xframe{L'_2, t'_2}^{s_2} \circ GS_2  \andalso L'_2 = L_2[x_2 \mapsto
          L_2(y_2)] \\
          H_2 = H[o \mapsto \Cell{DEP, l \sqcup l_2}]
        \end{gathered}
      \end{equation}
      We also have
      \begin{equation}
        \begin{gathered}
          S_{12} = H_{12}, P_{12} \andalso S_1 \Rrightarrow^{R_2^{\iota_2,
          \smiley}} S_{12}
          \\
          P_{12} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{12} = H[o_2 \mapsto \Cell{DEP, (l \sqcup l_1) \sqcup l_2}]
        \end{gathered}
      \end{equation}
      and
      \begin{equation}
        \begin{gathered}
          S_{21} = H_{21}, P_{21} \andalso S_2 \Rrightarrow^{R_1^{\iota_1,
          \smiley}} S_{21}
          \\
          P_{21} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS'_2|_{a_2}^{\iota_2} \right\} \\
          H_{21} = H[o_2 \mapsto \Cell{DEP, (l \sqcup l_2) \sqcup l_1}]
        \end{gathered}
      \end{equation}
      By commutability of the least upper bound operation $\sqcup$ we have
      \begin{equation}
        (l \sqcup l_1) \sqcup l_2 = (l \sqcup l_2) \sqcup l_1
      \end{equation}
      and thus we have $S_{12} = S_{21}$.
    \item[Case $R_1 = \EWhen, R_2 = \EWhen$:] We have that
      \begin{equation}
        \beta_1 = \iota'_1 \andalso \beta_2 = \iota'_2 \andalso \iota'_1 \neq
        \iota'_2.
      \end{equation}
      Similarly to previous cases we have
      \begin{equation}
        \begin{gathered}
          S = H, P \andalso P = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS_2|_{a_2}^{\iota_2} \right\} \\
          FS_1 = \xframe{L_1, \Let{x_1}{\When{y_1}{z_1}{\dots}}{t'_1}}^{s_1} \circ GS_1
          \\ 
          FS_1 = \xframe{L_2, \Let{x_2}{\When{y_2}{z_2}{\dots}}{t'_2}}^{s_2}
          \circ GS_2 \\
          L_1(y_1) = o_1 \andalso L_2(y_2) = o_2 \\
          L_1(z_1) = l_1 \andalso L_2(z_2) = l_2
        \end{gathered}
      \end{equation}
      Where we use $\dots$ for things that are not really vital.

      If $o_1 \neq o_2$ we are done similar to previous case. If $o_1 = o_2 = o$
      then we proceed as follows. Since many things are similar to the previous
      case we only write out the parts that are significantly different.
      \begin{equation}
        \begin{gathered}
          H_1 = H[o \mapsto \Cell{DEP_1, l}] \andalso DEP_1 = DEP \cup \{ (l_1,
          \dots)^{\iota'_1} \} \\
          H_2 = H[o \mapsto \Cell{DEP_2, l}] \andalso DEP_2 = DEP \cup \{ (l_2,
          \dots)^{\iota'_2} \} \\
          H_{12} = H[o \mapsto \Cell{DEP_{12}, l}] \andalso DEP_{12} = DEP \cup \{ (l_1,
          \dots)^{\iota'_1}, (l_2, \dots)^{\iota'_2} \} \\
          H_{21} = H[o \mapsto \Cell{DEP_{21}, l}] \andalso DEP_{21} = DEP \cup \{ (l_1,
          \dots)^{\iota'_1}, (l_2, \dots)^{\iota'_2} \} \\
        \end{gathered}
      \end{equation}
      Thus $S_{12} = S_{21}$.

    \item[Case $R_1 = \EWhen, R_2 = \ESpawn$:] First 
      \begin{equation}
        \beta_1 = \iota'_1 \andalso \beta_2 = \smiley.
      \end{equation}
      We have
      \begin{equation}
        \begin{gathered}
          S = H, P \andalso P = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1}
          \right\} \\
          FS_1 = \xframe{L_1, \Let{x_1}{\When{y_1}{z_1}{\dots}}{t'_1}}^{s_1} \circ GS_1
          \\ 
          L_1(y_1) = o_1 \andalso L_1(z_1) = l_1 \\
          o_2 \in \dom(H) \andalso H(o_2) = \Cell{DEP, l} \\
          (l_2, (L_{\text{env}}, z_2 \Rightarrow t''))^{\iota_2} \in DEP
        \end{gathered}
      \end{equation}
      Similarly to previous cases we have the case where $o_1 \neq o_2$ which
      follows similarly to case $R_1 = \EAssign, R_2 = \EAssign$ and the case
      $o_1 = o_2 = o$ for which we proceed as follows.

      First we note that
      \begin{equation}
        H(o) = \Cell{DEP, l}.
      \end{equation}
      We have that 
      \begin{equation} \label{eq:lem1_ewhen_espawn_1}
        \begin{gathered}    
          S_1 = H_1, P_1 \andalso S \Rrightarrow^{R_1^{\iota_1, \beta_1}} S_1
          \\
          P_1 = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1} \right\} \\
          FS'_1 = \xframe{L'_1, t'_1}^{s_1} \circ GS_1  \andalso L'_1 = L_1[x_1 \mapsto
          L_1(y_1)] \\
          H_1 = H[o \mapsto \Cell{DEP_1, l}] \andalso DEP_1 = DEP \cup \{ (l_1,
          \dots)^{\iota'_1} \}
        \end{gathered}
      \end{equation}
      Stepping accoriding to $R_2^{\iota_2, \smiley}$ from $S$ gives
      \begin{equation} \label{eq:lem1_ewhen_espawn_2}
        \begin{gathered}
          S_2 = H_2, P_2 \andalso S \Rrightarrow^{R_2^{\iota_2, \smiley}} S_2
          \\
          P_2 = P_0 \cup_D \left\{ FS_1|_{a_1}^{\iota_1},
          FS_2|_{\ocap}^{\iota_2} \right\} \\
          FS_2 = \xframe{L_{\text{env}}[z \mapsto l_2], t''}^{-} \circ
          \varepsilon \\
          H_2 = \Cell{DEP_2, l} \andalso DEP_2 = DEP \setminus \{ (l_2,
          \dots)^{\iota_2} \}
        \end{gathered}
      \end{equation}
      Given \eqref{eq:lem1_ewhen_espawn_1} and \eqref{eq:lem1_ewhen_espawn_2} it
      is not hard to verify that
      \begin{equation} 
        \begin{gathered}
          S_{12} = H_{12}, P_{12} \andalso S_1 \Rrightarrow^{R_2^{\iota_2,
          \smiley}} S_{12}
          \\
          P_{12} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS_2|_{\ocap}^{\iota_2} \right\} \\
          H_{12} = H[o \mapsto \Cell{DEP_{12}, l}] \\ 
          DEP_{12} = DEP \cup \{ (l_1, \dots)^{\iota'_1} \} \setminus \{ (l_2,
          \dots)^{\iota_2} \}
        \end{gathered}
      \end{equation}
      \begin{equation} 
        \begin{gathered}
          S_{21} = H_{21}, P_{21} \andalso S_2 \Rrightarrow^{R_1^{\iota_1,
          \iota'_1}} S_{21}
          \\
          P_{21} = P_0 \cup_D \left\{ FS'_1|_{a_1}^{\iota_1},
          FS_2|_{\ocap}^{\iota_2} \right\} \\
          H_{21} = H[o \mapsto \Cell{DEP_{12}, l}] \\ 
          DEP_{21} = DEP \setminus \{ (l_2, \dots)^{\iota_2} \} \cup \{ (l_1,
          \dots)^{\iota'_1} \} 
        \end{gathered}
      \end{equation}
      Since $\iota'_1$ is fresh it is clear that $DEP_{12} = DEP_{21}$ and
      therefore we have $S_{12} = S_{21}$.
      \begin{remark}
        The main point here is that $\iota'_1$ being a fresh thread identifier
        makes the removal and addition to the dependency set $DEP$ commute.
      \end{remark}
  \end{description}
  All other cases follow similarly to these and it should not be hard to verify
  them.
\end{proof}

\begin{definition} \label{def:betacompat}
  Let $R^{\iota, \beta}$ be a transition
  identifier. We call $\beta$ \emph{compatible} to a state $S$ if either
  \begin{equation*}
    \beta = \smiley \text{ or } \beta \text{ fresh at } S
  \end{equation*}
\end{definition}
\begin{remark}
  Note that $\beta$ being compatible to $S$ is a necessary condition of
  $R^{\iota, \beta}$ being applicable at $S$. Furthermore if a $\beta$ is
  compatible to $S$ it will be compatible to all states preceeding $S$ in the
  computation.
\end{remark}

\begin{definition}
  Let $R_1^{\iota_1, \beta_1}, R_2^{\iota_2, \beta_2}$ be two transition
  identifiers. We call $\beta_1$ and $\beta_2$ compatible if
  \begin{equation*}
    \beta_1 \neq \beta_2 \text{ of } \beta_1 = \beta_2 = \smiley.
  \end{equation*}
\end{definition}


\begin{lemma} \label{lem:lemma2}
  Let $S$ be a state. Let
  \begin{equation*}
    \bar{R} = R_1^{\iota_1, \beta_1}, \dots, R_n^{\iota_n, \beta_n} \andalso
    S \Rrightarrow^{\bar{R}} S_{\bar{R}}
  \end{equation*}
  Let $R^{\iota, \beta}$ be a transition such that
  \begin{equation} \label{eq:lemma2_1}
    \iota \neq \iota_i \andalso \forall i \in \left\{ 1, \dots, n \right\},
  \end{equation}
  and
  \begin{equation*}
    S \Rrightarrow^{R^{\iota, \beta}} S_{R^{\iota, \beta}} \andalso
    S_{\bar{R}} \Rrightarrow^{R^{\iota, \beta}} S'.
  \end{equation*}
  Furthermore let $\beta$ be compatible with $\beta_i$ for all $i = 1, \dots,
  n$.
  Then
  \begin{equation*}
    S_{R^{\iota, \beta}} \Rrightarrow^{\bar{R}} S'.
  \end{equation*}
\end{lemma}

% TODO make figure explaining the proof
\begin{proof}
  By induction on $n$, the length of $\bar{R}$.
  \begin{description}
    \item[Case $n = 1$:] Follows immediately from lemma~\ref{lem:lemma1}.
    \item[Case $n = i+1, i \geq 1$:] Let
      \begin{equation*}
        \bar{R_2} = R_2^{\iota_2, \beta_2}, \dots, R_n^{\iota_n, \beta_n}.
      \end{equation*}
      Since $\bar{R}$ applicable to $S$ we have 
      \begin{equation}
        S \Rrightarrow^{R_1^{\iota_1, \beta_1}} S_1.
      \end{equation}
      Then clearly
      \begin{equation}
        S_1 \Rrightarrow^{\bar{R_2}} S_{\bar{R}}.
      \end{equation}
      
      Since $R^{\iota, \beta}$ is applicable at $S$, \eqref{eq:lemma2_1} and
      the compatibility of $\beta$ it is not hard to see that
      $R^{\iota, \beta}$ is applicable at $S_1$, i.e.
      \begin{equation}
        S_1 \Rrightarrow^{R^{\iota, \beta}} S_{1,R^{\iota, \beta}}.
      \end{equation}
      Then, by induction hypothesis
      \begin{equation} \label{eq:lemma2_2}
        S_{1,R^{\iota, \beta}} \Rrightarrow^{\bar{R_2}} S'.
      \end{equation}
      By lemma~\ref{lem:lemma1} 
      \begin{equation} \label{eq:lemma2_3}
        S \Rrightarrow^{R^{\iota, \beta}} S_{R^{\iota, \beta}}
        \Rrightarrow^{R_1^{\iota_1, \beta_1}} S_{1, R^{\iota, \beta}}.
      \end{equation}
      But then combining \eqref{eq:lemma2_2} and \eqref{eq:lemma2_3} we have
      \begin{equation}
        S_{R^{\iota, \beta}} \Rrightarrow^{\bar{R}} S'.
      \end{equation}
  \end{description}
\end{proof}

\begin{proposition}
  Let $S = H, P \simeq H', P' = S'$ and let $g, h$ be the bijections such that
  \begin{equation} \label{eq:propnewgh1}
    H' = \pi(H, g, h) \andalso P' = \eta(P, g, h).
  \end{equation}
  Let $o, o' \in \OIDs$ be fresh at $S, S'$ respectively.
  Let $\iota, \iota' \in \TIDs$ be fresh at $S, S'$ respectively.
  Then there are bijections
  \begin{equation*}
    g': \OIDs \hookrightarrow \OIDs \andalso h': \TIDs \hookrightarrow \TIDs
  \end{equation*}
  such that 
  \begin{equation} \label{eq:propnewgh2}
    g'(o) = o', h'(\iota) = \iota'
  \end{equation} 
  and
  \begin{equation} \label{eq:propnewgh3}
    H' = \pi(H, g', h') \andalso P' = \eta(P, g', h').
  \end{equation}
\end{proposition}

\begin{proof}
  By the definition of the identifiers being fresh
  \begin{equation*}
    o, o' \not\in \OIDs \andalso \iota, \iota' \not\in \TIDs.
  \end{equation*}
  The role of $g$ and $h$ is merely to define a renaming of references in
  $\OIDs(S)$ and $\TIDs(S)$ respectively. Thus it should be clear that whether
  \eqref{eq:propnewgh1} holds or not only depends on what what values
  $g$ and $h$ takes for the identifiers in $\OIDs(S)$ and $\TIDs(S)$
  respectively. Since clearly our fresh identifiers are not in these sets it should
  be clear that the following bijections are well defined and satisfies the
  result of our proposition.
  \begin{equation*}
    \begin{gathered}
      g'(o_{0}) =
      \begin{cases}
        o' & \text{ if } o_0 = o \\
        g(o) &\text{ if } g(o_0) = o' \\
        g(o_{0}) & \text{ otherwise.} 
      \end{cases} \\
      h'(\iota_0) =
      \begin{cases}
        \iota' & \text{ if } \iota_0 = \iota \\
        h(\iota) & \text{ if } h(\iota_0) = \iota' \\
        h(\iota_0) & \text{ otherwise.} 
      \end{cases}
    \end{gathered}
  \end{equation*}
\end{proof}

Because of this proposition the following is well defined.

\begin{definition} \label{def:bijectionmod}
  Let $S = H, P \simeq H', P' = S'$ and let $g, h$ be the bijections such that
  \begin{equation} 
    H' = \pi(H, g, h) \andalso P' = \eta(P, g, h).
  \end{equation}
  Let $o, o' \in \OIDs$ be fresh at $S, S'$ respectively.
  Let $\iota, \iota' \in \TIDs$ be fresh at $S, S'$ respectively.
  Then define
  \begin{equation}
    g[o \mapsto o']: \OIDs \hookrightarrow \OIDs 
    \andalso h[\iota \mapsto \iota']: \TIDs \hookrightarrow \TIDs
  \end{equation}
  as any bijections satisfying \eqref{eq:propnewgh2} and \eqref{eq:propnewgh3}
  with $g' = g[o \mapsto o'], h' = h[\iota \mapsto \iota']$.
\end{definition}

\begin{lemma} \label{lem:lemma3}
  Let $S, S', T$ be states and $\bar{R}$ a transition sequence such that
  \begin{equation*}
    S \Rrightarrow^{\bar{R}} T \andalso S \simeq S'.
  \end{equation*}
  Then there is a state $T'$ and a transition sequence $\bar{R'}$ of the same
  length as $\bar{R}$ such that
  \begin{equation*}
    S' \Rrightarrow^{\bar{R'}} T' \andalso T \simeq T'.
  \end{equation*}
\end{lemma}


\begin{proof}
  By induction on the length $n$ of $\bar{R}$.
  \begin{description}
    \item[Case $n = 0$:] $\bar{R}$ is the empty sequence and thus $S = T$. Take
      $T' = S', \bar{R'} = \bar{R}$ and we are done.
    \item[Case $n = i + 1, i \geq 0$:] Let
      \begin{equation*}
        \begin{gathered}
          \bar{R} = R_1^{\iota_1, \beta_1}, \dots, R_{i+1}^{\iota_{i+1},
          \beta_{i+1}} \\
          \bar{R_i} = R_1^{\iota_1, \beta_1}, \dots, R_{i}^{\iota_{i},
          \beta_{i}}
        \end{gathered}
      \end{equation*}
      By assumption
      \begin{equation*}
        S \Rrightarrow^{\bar{R_i}} S_i \Rrightarrow^{R_{i+1}^{\iota_{i+1},
        \beta_{i+1}}} T
      \end{equation*}
      for some state $S_i$. By induction hypothesis there is $\bar{R'_i}, S'_i$
      such that
      \begin{equation}
        S' \Rrightarrow^{\bar{R'_i}} S'_i \andalso S_i \simeq S'_i.
      \end{equation}
      Since $S_i$ can take another step
      \begin{equation*}
        S_i = H, P \andalso S'_i = H', P'.
      \end{equation*}
      
      Now consider $R_{i+1}^{\iota_{i+1}, \beta_{i+1}}$. Since $S_i \simeq
      S'_i$ there are
      \begin{equation*}
        g: \OIDs \hookrightarrow \OIDs \andalso h: \TIDs \hookrightarrow \TIDs
      \end{equation*}
      such that
      \begin{equation*}
        H' = \pi(H, g, h)  \andalso P' = \eta(P, g, h).
      \end{equation*}
      Now let 
      \begin{equation*}
        \begin{gathered}
          R = R_{i+1} \andalso \iota = h(\iota_{i+1}) \\
          \beta = 
          \begin{cases}
            \smiley         & \text{ if } \beta_{i+1} = \smiley \\
            o'_{\text{new}} & 
            \begin{aligned}[t]
              \text{ if }&\beta_{i+1} = o_{\text{new}} \in \OIDs \\
              &o_{\text{new}} \text{ is fresh at } S_i \\
              &o'_{\text{new}} \text{ is fresh at } S'_i 
            \end{aligned} \\
            \iota'_{\text{new}} & \begin{aligned}[t]
              \text{ if }&\beta_{i+1} = \iota_{\text{new}} \in \TIDs \\
              &\iota_{\text{new}} \text{ is fresh at } S_i \\
              &\iota'_{\text{new}} \text{ is fresh at } S'_i
            \end{aligned}
          \end{cases} \\
          g_{\text{new}} = 
          \begin{cases}
            g & \text{ if } \beta_{i+1} = \smiley \text{ or } \beta_{i+1} = 
            \iota_{\text{new}} \\
            g[o_{\text{new}} \mapsto o'_{\text{new}}] & \text{ if } \beta_{i+1}
            = o_{\text{new}}
          \end{cases} \\
          h_{\text{new}} = 
          \begin{cases}
            h & \text{ if } \beta_{i+1} = \smiley \text{ or } \beta_{i+1} = 
            o_{\text{new}} \\
            h[\iota_{\text{new}} \mapsto \iota'_{\text{new}}] & \text{ if } \beta_{i+1}
            = \iota_{\text{new}}
          \end{cases}
        \end{gathered}
      \end{equation*}

      Since
      \begin{equation}
        S_i \Rrightarrow^{R_{i+1}^{\iota_{i+1}, \beta_{i+1}}} T,
      \end{equation}
      by rule inspection it is easy to verify that
      \begin{equation}
        S'_i \Rrightarrow^{R^{\iota, \beta}} T'
      \end{equation}
      for some $T'$. If $T = \Error$ then by rule inspection we must have $T' =
      \Error$ and trivially that $T \simeq T'$. Furthermore, if $T = H_{T},
      P_{T}$ then by rule inspection $T' = H_{T'}, P_{T'}$. By considering
      definition~\ref{def:bijectionmod} it is not hard to verify that
      we have
      \begin{equation*}
        H_{T'} = \pi(H_T, g_{\text{new}}, h_{\text{new}}) \andalso P_{T'} =
        \eta(P_T, g_{\text{new}}, h_{\text{new}}).
      \end{equation*}
      Thus $T \simeq T'$.
  \end{description}
\end{proof}

\begin{lemma} \label{lem:lemma4}
  Let 
  \begin{equation*}
    \bar{R} = R_1^{\iota_1, \beta_1}, \dots, R_n^{\iota_n, \beta_n}
  \end{equation*}
  be a transition sequence and $S, T$ be states such that.
  \begin{equation*}
    S \Rrightarrow^{\bar{R}} T.
  \end{equation*}
  Then there is a state $T'$ and a series of mutually compatible 
  \begin{equation*}
    \beta'_i, i = 1, \dots, n
  \end{equation*}
  such that
  \begin{equation*}
    \begin{gathered}
      \beta'_i \not\in \OIDs(S), \beta'_i \not\in \TIDs(S) \andalso i =
      1, \dots, n, \\
      \bar{R'} = R_1^{\iota_1, \beta'_1}, \dots, R_n^{\iota_1, \beta'_n} \\
      S \Rrightarrow^{\bar{R'}} T'.
    \end{gathered}
  \end{equation*}
\end{lemma}

\begin{proof}
  This is obvious from these two facts:
  \begin{itemize}
    \item There are infinitely many elements in both $\OIDs$ and $\TIDs$ and
      only finitely many in $\OIDs(S)$ and $\TIDs(S)$. This follows from
      definition of these sets.
    \item All choices of fresh identifiers results in equivalent states. I.e.
      for any state $S$, and transition identifiers $R^{\iota, \beta},
      R^{\iota, \beta'}$ such that 
      \begin{equation*}
        S \Rrightarrow^{R^{\iota, \beta}} S_1 \andalso S
        \Rrightarrow^{R^{\iota, \beta'}} S'_1,
      \end{equation*}
      we have
      \begin{equation*}
        S_1 \simeq S'_1.
      \end{equation*}
      This is not hard to prove.
  \end{itemize}
\end{proof}

Finally we restate and prove theorem~\ref{thm:qd}.
\begin{theorem*}
  Let $S, S', T, T'$ be well typed states not equal to $\Error$ such that
  \begin{equation*}
    \begin{gathered}
      S \simeq S' \\
      S \Rrightarrow^{\bar{R}} T \andalso S' \Rrightarrow^{\bar{R'}} T'.
    \end{gathered}
  \end{equation*}
  Furthermore we assume that neither $T$ or $T'$ can make a step.
  Then
  \begin{equation*}
    T \simeq T'.
  \end{equation*}
\end{theorem*}

\begin{proof}{(Theorem~\ref{thm:qd}, Quasi-Determinism)}
  If $S \neq S'$ by lemma~\ref{lem:lemma3} there is a state $T''$ and a
  transition sequence $\bar{R''}$ such that
  \begin{equation}
    S \Rrightarrow^{\bar{R''}} T'' \andalso T' \simeq T''.
  \end{equation}
  Because of this and transistiveness of $\simeq$ WLOG we can assume that $S =
  S'$.

  We proceed by induction on $n$ and $n'$, the lengths of $\bar{R}$ and
  $\bar{R'}$ respectively.
  \begin{description}
    \item[Case $n, n' \leq 1$:] Clearly $n = n'$. Otherwise, when considering
      lemma~\ref{lem:lemma3} we would have a contradiction with the assumption
      that neither $T$ or $T'$ can take another step .
      If $n = n' = 0$ we are done since $T = S \simeq S' = T'$. Thus we assume
      that $n = n' = 1$. We let
      \begin{equation*}
        \bar{R} = R^{\iota, \beta} \andalso \bar{R'} = R'^{\iota', \beta'}.
      \end{equation*}
      We must have 
      \begin{equation} \label{eq:qd_1}
        R = R' \andalso \iota = \iota'
      \end{equation} 
      since otherwise $T$ and $T'$ can take another step.  If $\beta = \beta'$
      then we are done since this implies $T = T'$.  Otherwise let $g, h$ be the
      bijections that witnesses the relation $S \simeq S$. Because of
      \eqref{eq:qd_1} we must have that either $\beta, \beta' \in \OIDs$ or
      $\beta, \beta' \in \TIDs$. In the first case 
      \begin{equation}
        g[\beta \mapsto \beta'] \andalso h
      \end{equation}
      witnesses the relation $T \simeq T'$. In the second case it is witnessed
      by
      \begin{equation*}
        g \andalso h[\beta \mapsto \beta'].
      \end{equation*}
      Thus $T \simeq T'$.
    \item[Case $1 < n, n' \leq i+1$ and $i \geq 1$:] We let 
      \begin{equation*}
        \begin{gathered}
          \bar{R} = R_1^{\iota_1, \beta_1}, \dots, R_n^{\iota_n, \beta_n} \\
          \bar{R'} = {R'_1}^{\iota'_1, \beta'_1}, \dots, {R'_{n'}}^{\iota'_{n'},
          \beta'_{n'}}.
        \end{gathered}
      \end{equation*}
      Furthermore let
      \begin{equation*}
        \bar{R}_{>1} = R_2^{\iota_2, \beta_2}, \dots, R_n^{\iota_n, \beta_n} \\
      \end{equation*}
      Consider the first tranisition identifier of $\bar{R}$. We let
      Let $k$ be such
      that ${R'_k}^{\iota'_k, \beta'_k}$ is the first transition identifier in
      $\bar{R'}$ for which 
      \begin{equation*}
        \iota_1 = \iota'_k = \iota.
      \end{equation*} 
      This $k$ must exist since
      otherwise $T'$ can take another step. By the remark following
      definition~\ref{def:trans_id} we have 
      \begin{equation*}
        R_1 = R'_k = R.
      \end{equation*} 
      We let
      \begin{equation*}
        \begin{gathered}
          \bar{R'}_{<k} = {R'_1}^{\iota'_1, \beta'_1}, \dots,
          {R'_{k-1}}^{\iota'_{k-1}, \beta'_{k-1}}  \\
          \bar{R'}_{>k} = {R'_{k+1}}^{\iota'_{k+1}, \beta'_{k+1}}, \dots,
          {R'_{n'}}^{\iota'_{n'}, \beta'_{n'}}.
        \end{gathered}
      \end{equation*}

      WLOG we can assume that
      \begin{equation*}
        \beta_1 = \beta'_k = \beta
      \end{equation*}
      since otherwise we could just reassign $\beta_1, \dots, \beta_n, \beta'_1, \dots,
      \beta'_n$, in accordance with lemma~\ref{lem:lemma4}.

%      By lemma~\ref{lem:lemma3} we can (using similar reasoning as before) WLOG
%      assume that $\beta'_k$ is compatible with $\beta'_i$ for all $i = 1,
%      \dots, k-1$.
%
%      Now either $\beta'_k = \beta_1 = \smiley$, $\beta'_k, \beta_1 \in \OIDs$
%      or $\beta'_k, \beta_1 \in \TIDs$. In the first case it is immediately
%      clear that ${R'_k}^{\iota'_k, \beta'_k}$ is applicable at $S$. In the
%      other two cases WLOG we can assume that $\beta'_k$ is fresh at $S$ due to
%      lemma~\ref{lem:lemma3}. This makes $R^{\iota, \beta'_k}$
%      applicable at $S$.

      Then by lemma~\ref{lem:lemma2} we have
      \begin{equation*}
        S \Rrightarrow^{{R}^{\iota, \beta}} S_1 \Rrightarrow^{\bar{R'}_{<k}}
        S_2 \Rrightarrow^{\bar{R'}_{>k}} T'
      \end{equation*}
      Furthermore, by $\bar{R}$ being applicable at $S$ we have
      \begin{equation*}
        S \Rrightarrow^{R^{\iota, \beta}} S_1 \Rrightarrow^{\bar{R}_{>1}}
        T.
      \end{equation*}
      Both transition sequences $\bar{R'}_{<k}, \bar{R'}_{>k}$ and
      $\bar{R}_{>1}$ are of length less than or equal to $i$.  Thus by the
      induction hypothesis $T \simeq T'$.
  \end{description}
\end{proof}



% TODO add figures to the lemmas and theorem proofs



